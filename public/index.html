<!DOCTYPE html>
<html lang="en">
<!-- TODO
https://dhtmlx.com/docs/products/dhtmlxScheduler/ -- can double click to edit inline

Tell Joey if we make the website: https://github.com/joereynolds/what-to-code#websites

Features: 

Use cases:

* Visiting homepage, entering ID, creates the calendar with that shortcode
* Visiting homepage, have random shortcode (shortID) prepopulated
* Visiting pastecal.com/ID creates the calendar (prefilled option to create)
* Visiting homepage, have a list of your recent calcs on the side

TODO:
* DONE: Figure out creation and permissions issue
* TODO: Rename Calendar Title
* DONE: Visiting URL directly (/doesnotexist) should have button to create

* Have data parsing to only load the named fields, not the extra ones added by the program
* DONE: Full 24 hours
* BUG: pressing enter with lightbox closes it
* TODO: Events under 40 minutes get small view: view-source:https://docs.dhtmlx.com/scheduler/samples/02_customization/27_custom_event_box.html
* TODO: Events get color based on hashtag : https://docs.dhtmlx.com/scheduler/custom_events_color.html #work #fun etc. First tag wins
* TODO: Button to rescale to fit
* TODO: Change calendar title / click to edit
* TODO: Have the recents list (saved to localstorage)
* TODO: Make it responsive (with all-hours moved via JS to just below the nav)
* TODO: Have it save the calendar to localstorage until you share it
* TODO: Have a help/tour button for discussion, etc. Otherwise the app is full-fledged.

transform: scale(0.7);
    transform-origin: top;

-->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PasteCal: Shareable, no-login calendar</title>
    <xlink rel="stylesheet" href="style.css" />
    <!--
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
-->
    <!-- CDN Development (always latest) -->
    <xlink rel="stylesheet" href="https://unpkg.com/style.css" />
    <script src="https://unpkg.com/vue@3"></script>

    <!-- firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-compat.js"></script>
    <script>
        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyCZ9U1FflAFcdDLgxJscs2BwV_PrXqmzKw",
            authDomain: "pastecal-web.firebaseapp.com",
            databaseURL: "https://pastecal-web-default-rtdb.firebaseio.com",
            projectId: "pastecal-web",
            storageBucket: "pastecal-web.appspot.com",
            messagingSenderId: "912998627577",
            appId: "1:912998627577:web:aa652846c2618a986d8a28",
            measurementId: "G-4J99GY9KE6"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        nanoid = (t = 21) => {
            let e = "",
                r = crypto.getRandomValues(new Uint8Array(t));
            for (; t--;) {
                let n = 63 & r[t];
                e +=
                    n < 36
                        ? n.toString(36)
                        : n < 62
                            ? (n - 26).toString(36).toUpperCase()
                            : n < 63
                                ? nanoid(1) // replace with another random character
                                : nanoid(1);
            }
            return e;
        };
        Utils = {};
        Utils.nanoid = nanoid;

        class Event {
            // being created from a TUI event
            constructor(options) {
                this.id = Utils.nanoid(8);
                this.title = options.text || options.title;

                // from DHTMLX
                this.start = options.start;
                this.end = options.end;

                this.repeat = "";

                if (options.start_date && options.end_date) {
                    this.start = options.start_date.toISOString()
                    this.end = options.end_date.toISOString();
                }

                // from TUI
                if (options.start && options.start._date) {
                    this.start = options.start._date.toISOString();
                    this.end = options.end._date.toISOString();
                }
            }
        }

        class Calendar {
            constructor(id, title, events, options) {
                this.id = id;
                this.title = title || "";
                this.events = events || [];
                this.options = options || {};
            }

            // return events in TUI format
            getTUIEvents() {
                return this.events.map(e => {
                    e.category = e.category || "time";
                    return e;
                });
            }

            getDHTMLXEvents() {
                return this.events.map(e => {
                    return {
                        id: e.id,
                        start_date: e.start,
                        end_date: e.end,
                        text: e.title
                    }
                });
            }

            addEvent(e) {
                var event = new Event(e);
                this.events.push(event);
                CalendarDataService.sync(this);
            }

            deleteEvent(eventToDelete) {
                this.events = this.events.filter(e => e.id !== eventToDelete.id);
                CalendarDataService.sync(this);
            }

            updateEvent(updatedEvent) {
                var event = this.events.find(e => e.id === updatedEvent.id);
                if (event) {
                    var updated = new Event(updatedEvent);
                    Object.assign(event, updated);
                } else {
                    console.log("Event not found", updatedEvent);
                }
                CalendarDataService.sync(this);
            }
        }

        class CalendarDataService {
            static slug = null;
            static db = firebase.database().ref('/calendars');

            static getAll() {
                return this.db;
            }

            // subscribe to live updates
            static subscribe(slug) {
                console.log("subscribe to ", slug);
                this.slug = slug;
                if (this.slug) {
                    this.db.child(this.slug).on('value', data => {
                        console.log(`loaded ${slug}`, data.val());
                        // var events = data.val().events;
                        // update calendar object in vue app
                        // app.calendar = data.val();
                        var calendar = data.val();
                        if (calendar && calendar.id) {
                            app.isExisting = true;
                            app.setCalendarData(calendar);
                        }
                    })
                }
            }

            // only sync if we have existed
            static sync(calendar) {
                if (calendar && calendar.id && app.isExisting) {
                    this.db.child(calendar.id).set(calendar);
                }
            }

            static create(item) {
                return this.db.push(item);
            }

            static createWithId(key, value, success) {
                return this.db.child(key).set(value, (error) => {
                    if (error) {
                        console.log("error", error);
                    } else {
                        success();
                    }
                });
            }

            static update(key, value) {
                return this.db.child(key).update(value);
            }

            static delete(key) {
                return this.db.child(key).remove();
            }
        }
    </script>
    <!--
    <script src="index.js"></script>
-->
</head>

<body>
    <style>
        body {
            max-width: 100%;
            padding: 0px 5px;
            margin: 5px auto;
            font-family: Roboto, Arial, sans-serif;
        }

        #app input#slug {
            width: 15ch;
        }

        .dhx_cal_date {
            font-size: 1.0rem !important;
        }

        .dhx_lightbox_time_select {
            width: 120px !important;
        }

        .dhx_cal_ltext {
            height: 200px !important;
        }

        .dhx_cal_light {
            width: 550px !important;
        }

        textarea.dhx_cal_editor {
            padding: 1px 2px !important;
        }

        .topbar {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #ccc;
            padding: 5px 0px;
            margin-top: 5px;
            font-size: 0.8rem;
        }

        .topbar>div {
            width: 33%;
        }

        .topbar .title {
            font-weight: bold;
            font-size: 1.0rem;
        }

        div.extended_hours {
            position: absolute;
            top: 90px;
            z-index: 99;
            font-size: 0.8rem;
            color: #666;
        }

        .recents a {
            margin-right: 0.5rem;
        }
    </style>
    <div id="app">
        <div class="extended_hours">
            <input type="checkbox" id="extended" v-model="calendar.options.extended">
            <label for="extended">All hours</label>
        </div>

        <div class="topbar">
            <div style="text-align: left;">
                <a href="/">PasteCal</a>: Shared calendars, no logins
            </div>
            <div style="text-align: center;" class="title" @click="editTitle = true;">
                <span v-if="!editTitle">{{calendar.title}}</span>
                <input type="text" v-if="editTitle" v-model="calendar.title" @keyup.enter="setTitle($event)">
            </div>
            <div class="recents" style="display: none;">
                <select name="recents" id="recents">
                    <option value="">Recently opened</option>
                </select>
            </div>
            <div style="text-align:right">
                <div v-if="isExisting">
                    <a :href="calendar.id">https://pastecal.com/{{calendar.id}}</a>
                </div>

                <div v-if="!isExisting">
                    https://pastecal.com/<input id="slug" type="text" :disabled="isExisting"
                        v-model="calendar.id"></input>
                    <button @click="create" v-if="!isExisting">Save</button>
                </div>
            </div>
        </div>

        <div id="cal2_wrap" style="width: 100%; height: 100%;">
            <div id="scheduler_here" class="dhx_cal_container" style='width:100%; height:100%'>
                <div class="dhx_cal_navline">
                    <div class="dhx_cal_prev_button">&nbsp;</div>
                    <div class="dhx_cal_next_button">&nbsp;</div>
                    <div class="dhx_cal_today_button"></div>
                    <div class="dhx_cal_date"></div>
                    <div class="dhx_cal_tab" name="day_tab" style="right:204px;"></div>
                    <div class="dhx_cal_tab" name="week_tab" style="right:140px;"></div>
                    <div class="dhx_cal_tab" name="month_tab" style="right:76px;"></div>
                </div>
                <div class="dhx_cal_header">
                </div>
                <div class="dhx_cal_data">
                </div>
            </div>
        </div>
        <div class="recents" style="display: none;">
            Recents:
            <span v-for="item in recents" :key="item.id">
                <a :href="item.id">{{item.title}}</a>
            </span>
        </div>
        <!--
        <pre>{{calendar}}</pre>
        -->
    </div>
    <script src="https://cdn.dhtmlx.com/scheduler/5.3/dhtmlxscheduler.js"></script>
    <script
        src="https://docs.dhtmlx.com/scheduler/codebase/ext/dhtmlxscheduler_container_autoresize.js?v=5.3.13"></script>
    <link rel="stylesheet" href="https://cdn.dhtmlx.com/scheduler/5.3/dhtmlxscheduler.css" />
    <link rel="stylesheet" href="https://docs.dhtmlx.com/scheduler/codebase/dhtmlxscheduler_material.css?v=5.3.13" />

    <script>
        const CalendarVueApp = {
            data() {
                console.log("Vue: data()");
                var urlslug = window.location.pathname.split("/")[1];

                // TODO: Make function to check valid URL slug exists. Then we can set exists.
                if (urlslug.match(/^[a-zA-Z0-9_\-]+$/) && urlslug.length < 40) {
                    // slug is ok
                } else {
                    // should redirect back to homepage if we have a bad url;
                    urlslug = null;
                }

                var id = urlslug ?? Utils.nanoid(8);
                CalendarDataService.subscribe(id);
                var cal = new Calendar(id, "Untitled Calendar", []);

                return {
                    isExisting: false, // set by callback
                    editTitle: false,
                    calendar: cal,
                    recents: []
                }
            },

            mounted() {
                console.log("Vue:mounted");

                scheduler.xy.scale_width = 60;

                // TODO: get format string from environment
                // https://docs.dhtmlx.com/scheduler/settings_format.html 
                scheduler.config.hour_date = "%g:%i %A";
                scheduler.config.responsive_lightbox = true; // responsive lightbox
                scheduler.config.separate_short_events = true;
                scheduler.config.time_step = 15;

                scheduler.config.details_on_create = true;
                scheduler.config.details_on_dblclick = true;
                scheduler.config.icons_select = ["icon_edit"];

                // have option to show midnight - 5am
                scheduler.config.first_hour = 5;
                // have option for larger 30-min scale

                scheduler.config.event_duration = 60;
                scheduler.config.full_day = true;

                scheduler.config.scroll_hour = new Date().getHours();
                scheduler.config.mark_now = true;
                scheduler.config.now_date = new Date();
                scheduler.init("scheduler_here", new Date(), "week");

                scheduler.attachEvent("onEventAdded", (id, ev) => {
                    console.log("onEventAdded", id, ev);
                    app.calendar.addEvent(ev);
                });
                scheduler.attachEvent("onEventChanged", (id, ev) => {
                    console.log("onEventChanged", id, ev);
                    app.calendar.updateEvent(ev);
                });
                scheduler.attachEvent("onEventDeleted", (id, ev) => {
                    console.log("onEventDeleted", id, ev);
                    app.calendar.deleteEvent(ev);
                });
            },

            watch: {
                'calendar.options.extended'(val) {
                    CalendarDataService.sync(this.calendar);
                    console.log("extended", val);
                    scheduler.config.first_hour = val ? 0 : 5;
                    scheduler.render();
                }
            },

            methods: {
                create() {
                    // initial create
                    CalendarDataService.createWithId(this.calendar.id, this.calendar, () => {
                        window.location = "/" + this.calendar.id;
                    });
                },

                setTitle(event) {
                    if (event.target.value) {
                        this.editTitle = false;
                        this.calendar.title = event.target.value;

                        // only save if save has been clicked before
                        if (this.isExisting) {
                            CalendarDataService.sync(this.calendar);
                        }
                    }
                },

                setCalendarData(data) {
                    this.calendar = Object.assign(this.calendar, data); // keep as calendar object
                    scheduler.clearAll();
                    scheduler.parse(this.calendar.getDHTMLXEvents());
                },
            }
        };

        const app = Vue.createApp(CalendarVueApp).mount('#app');
    </script>

    <br />
    <!--
    <p>
        Features:
    <ul>
        <li>DONE: Simple calendar UX</li>
        <li>DONE: Share with anyone with a link</li>
        <li>Daily revision history for changes</li>
        <li>No-login to embed your calendar in any page</li>
    </ul>
    </p>
-->

</body>

</html>