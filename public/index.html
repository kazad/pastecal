<!-- 
Open sourced under the MIT License: https://opensource.org/licenses/MIT
Copyright (c) 2025 Kalid Azad
-->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- HTML Meta Tags -->
    <title>PasteCal: Shareable, no-login calendar</title>
    <meta name="description" content="Create a public shared calendar link, no signups needed.">

    <!-- Facebook Meta Tags -->
    <meta property="og:url" content="https://pastecal.com/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="PasteCal: Shareable, no-login calendar">
    <meta property="og:description" content="Create a public shared calendar link, no signups needed.">
    <meta property="og:image" content="https://pastecal.com/img/screenshot.png">

    <!-- Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta property="twitter:domain" content="pastecal.com">
    <meta property="twitter:url" content="https://pastecal.com/">
    <meta name="twitter:title" content="PasteCal: Shareable, no-login calendar">
    <meta name="twitter:description" content="Create a public shared calendar link, no signups needed.">
    <meta name="twitter:image" content="https://pastecal.com/img/screenshot.png">

    <!-- Favicons: https://realfavicongenerator.net/ -->
    <link rel="icon" type="image/png" href="/img/icons/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/img/icons/favicon.svg" />
    <link rel="shortcut icon" href="/img/icons/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/img/icons/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">

    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            }); var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-WTP9VTM');</script>
    <!-- End Google Tag Manager -->

    <!-- CDN Development (always latest) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

    <!-- Syncfusion styles: https://ej2.syncfusion.com/documentation/appearance/theme/ -->
    <link id="syncfusion-base-theme" href="https://cdn.syncfusion.com/ej2/ej2-base/styles/material.css" rel="stylesheet"
        type="text/css" />
    <link id="syncfusion-theme" href="https://cdn.syncfusion.com/ej2/material.css" rel="stylesheet" type="text/css" />
    <link id="syncfusion-schedule-theme" href="https://cdn.syncfusion.com/ej2/ej2-schedule/styles/material.css"
        rel="stylesheet" type="text/css" />

    <!-- Add Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <!-- CSS variables for light/dark theme & Global Styles -->

    <link rel="stylesheet" href="/style.css">

    <!-- Essential JS 2 all script -->
    <script src="https://cdn.syncfusion.com/ej2/23.2.6/dist/ej2.min.js" type="text/javascript"></script>
    <script>
        ej.base.registerLicense('Ngo9BigBOggjHTQxAR8/V1NHaF1cW2hIfEx1RHxQdld5ZFRHallYTnNWUj0eQnxTdEZiW39fcXJXR2JUV0NyWg==');
    </script>

    <!-- firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-compat.js"></script>
    <script>
        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyCZ9U1FflAFcdDLgxJscs2BwV_PrXqmzKw",
            authDomain: "pastecal-web.firebaseapp.com",
            databaseURL: "https://pastecal-web-default-rtdb.firebaseio.com",
            projectId: "pastecal-web",
            storageBucket: "pastecal-web.appspot.com",
            messagingSenderId: "912998627577",
            appId: "1:912998627577:web:aa652846c2618a986d8a28",
            measurementId: "G-4J99GY9KE6"
        };
        firebase.initializeApp(firebaseConfig);

        // 
        if (location.href.includes("localhost") && location.href.includes("?local")) {
            firebase.functions().useEmulator("localhost", 5001);
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chrono-node@1.4.9/dist/chrono.min.js"></script>
    <script src="/index.js?v=1.1"></script>

    <!-- Self-test suite (only loads on localhost) -->
    <script>
        if (window.location.hostname.match(/^(localhost|127\.0\.0\.1|::1)$/)) {
            const script = document.createElement('script');
            script.src = '/selftest.js?v=1.1';
            document.head.appendChild(script);
        }
    </script>

    <script>
        // --- Utilities ---
        // Extend Utils object defined in index.js (already contains nanoid, init, sync, etc.)
        Object.assign(Utils, {
            debounce(func, timeout = 300) {
                let timer;
                return (...args) => {
                    clearTimeout(timer);
                    timer = setTimeout(() => { func.apply(this, args); }, timeout);
                };
            },
            sanitizeUrl(url) {
                let sanitized = url.replaceAll("amp;", "&").replace(/&+/g, '&')
                return sanitized;
            },
            randomID(size = 21) {
                let alphabet = '123456789abcdefghjklmnpqrstuvwxyz';
                let id = '';
                let i = size;
                while (i--) {
                    id += alphabet[(Math.random() * alphabet.length) | 0]
                }
                return id;
            },
            uuidv4() {
                return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c =>
                    (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
                );
            },
            parseDate(str) {
                let date = null;
                if (!str) return date;
                if (str.match(/\D/)) {
                    let parts = str.split(/\D/);
                    date = new Date((parts[0].length == 2 ? "20" : 0) + parts[0], parts[1] - 1, parts[2]);
                } else {
                    if (str.length === 6) date = new Date("20" + str.substring(0, 2), str.substring(2, 4) - 1, str.substring(4, 6));
                    if (str.length === 8) date = new Date(str.substring(0, 4), str.substring(4, 6) - 1, str.substring(6, 8));
                }
                return date.toString() == 'Invalid Date' ? null : date;
            }
        });

        // --- Icon Components ---
        // Icons now rely on parent to pass sizing classes (e.g. class="w-5 h-5")
        const HelpIcon = { template: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9.879 7.519c1.171-1.025 3.071-1.025 4.242 0 1.172 1.025 1.172 2.687 0 3.712-.203.179-.43.326-.67.442-.745.361-1.45.999-1.45 1.827v.75M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 5.25h.008v.008H12v-.008z" /></svg>` };
        const SearchIcon = { template: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-5.197-5.197m0 0A7.5 7.5 0 105.196 5.196a7.5 7.5 0 0010.607 10.607z" /></svg>` };
        const ShareIcon = { template: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" /></svg>` };
        const NotesIcon = { template: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" /></svg>` };
        const ChevronDownIcon = { template: `<svg xmlns="http://www.w3.org/2000/svg" class="w-3 h-3" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z" /></svg>` };
        const CloseIcon = { template: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" /></svg>` };

        const CopyIcon = { template: `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" /></svg>` };

        const StarIcon = {
            props: { filled: Boolean },
            template: `
                <svg v-if="filled" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="currentColor" class="w-4 h-4">
                    <path fill-rule="evenodd" d="M10.788 3.21c.448-1.077 1.976-1.077 2.424 0l2.082 5.006 5.404.434c1.164.093 1.636 1.545.749 2.305l-4.117 3.527 1.257 5.273c.271 1.136-.964 2.033-1.96 1.425L12 18.354 7.373 21.18c-.996.608-2.231-.29-1.96-1.425l1.257-5.273-4.117-3.527c-.887-.76-.415-2.212.749-2.305l5.404-.434 2.082-5.005Z" clip-rule="evenodd" />
                </svg>
                <svg v-else xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M11.48 3.499a.562.562 0 0 1 1.04 0l2.125 5.111a.563.563 0 0 0 .475.345l5.518.442c.499.04.701.663.321.988l-4.204 3.602a.563.563 0 0 0-.182.557l1.285 5.385a.562.562 0 0 1-.84.61l-4.725-2.885a.562.562 0 0 0-.586 0L6.982 20.54a.562.562 0 0 1-.84-.61l1.285-5.386a.562.562 0 0 0-.182-.557l-4.204-3.602a.562.562 0 0 1 .321-.988l5.518-.442a.563.563 0 0 0 .475-.345L11.48 3.5Z" />
                </svg>`
        };

        const TrashIcon = { template: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>` };
        const DropdownIcon = { template: `<svg xmlns="http://www.w3.org/2000/svg" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M1.646 4.646a.5.5 0 0 1 .708 0L8 10.293l5.646-5.647a.5.5 0 0 1 .708.708l-6 6a.5.5 0 0 1-.708 0l-6-6a.5.5 0 0 1 0-.708z" /></svg>` };

        const CheckIcon = { template: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>` };
        const XIcon = { template: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>` };
        const InfoIcon = { template: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" aria-hidden="true"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>` };

        const EditIcon = { template: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>` };
        const DoneIcon = { template: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7" /></svg>` };
        const KebabIcon = { template: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M12 6.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 12.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 18.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z" /></svg>` };

        const LockIcon = { template: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 15v2m-6 4h12a2 2 0 002-2v-6a2 2 0 00-2-2H6a2 2 0 00-2 2v6a2 2 0 002 2zm10-10V7a4 4 0 00-8 0v4h8z" /></svg>` };
        const MobileIcon = { template: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 18h.01M8 21h8a2 2 0 002-2V5a2 2 0 00-2-2H8a2 2 0 00-2 2v14a2 2 0 002 2z" /></svg>` };
        const SwitchIcon = { template: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7h12m0 0l-4-4m4 4l-4 4m0 6H4m0 0l4 4m-4-4l4-4" /></svg>` };
        const EyeIcon = { template: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M2.036 12.322a1.012 1.012 0 0 1 0-.639C3.423 7.51 7.36 4.5 12 4.5c4.638 0 8.573 3.007 9.963 7.178.07.207.07.431 0 .639C20.577 16.49 16.64 19.5 12 19.5c-4.638 0-8.573-3.007-9.963-7.178Z" /><path stroke-linecap="round" stroke-linejoin="round" d="M15 12a3 3 0 1 1-6 0 3 3 0 0 1 6 0Z" /></svg>` };
        const LinkIcon = { template: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M13.19 8.688a4.5 4.5 0 0 1 1.242 7.244l-4.5 4.5a4.5 4.5 0 0 1-6.364-6.364l1.757-1.757m13.35-.622 1.757-1.757a4.5 4.5 0 0 0-6.364-6.364l-4.5 4.5a4.5 4.5 0 0 0 1.242 7.244" /></svg>` };
        const DeviceIcon = { template: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" d="M10.5 1.5H8.25A2.25 2.25 0 0 0 6 3.75v16.5a2.25 2.25 0 0 0 2.25 2.25h7.5A2.25 2.25 0 0 0 18 20.25V3.75a2.25 2.25 0 0 0-2.25-2.25H13.5m-3 0V3h3V1.5m-3 0h3m-3 18.75h3" /></svg>` };
        const ExportIcon = { template: `<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 8.25H7.5a2.25 2.25 0 0 0-2.25 2.25v9a2.25 2.25 0 0 0 2.25 2.25h9a2.25 2.25 0 0 0 2.25-2.25v-9a2.25 2.25 0 0 0-2.25-2.25H15m0-3-3-3m0 0-3 3m3-3V15" /></svg>` };
        // Also re-defining EditIcon2 for the pencil used in Share UI if distinct from EditIcon? 
        // The SVG at line 1187 was: d="m16.862 4.487 1.687-1.688..."
        // The existing EditIcon is d="M15.232 5.232..."
        // They are similar pencils. I will reuse EditIcon for consistency and simplicity unless they look wildly different.
        // Actually, looking at paths, they are both pencils. I will standardize on EditIcon.

        const SettingsIcon = {
            props: { size: { type: String, default: 'w-4 h-4' } },
            template: `<svg xmlns="http://www.w3.org/2000/svg" :class="size" fill="currentColor" viewBox="0 0 16 16"><path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z" /></svg>`
        };


        class Event {
            // may be created from JSON object or DHTMLX internal calendar event
            constructor(options) {
                this.id = options.Id || options.id || Utils.uuidv4();
                this.title = options.Subject || options.text || options.title || "";
                this.description = options.Description || options.description || "";
                this.repeat = options.Recurrence || options.repeat || "";
                this.recurrencerule = options.RecurrenceRule || options.recurrencerule || "";
                this.start = options.start || null;
                this.end = options.end || null;
                this.type = parseInt(options.Type || options.type || 1);

                this.recurrenceID = options.RecurrenceID || options.recurrenceID || null;
                this.recurrenceException = options.RecurrenceException || options.recurrenceException || null;

                // for SyncFusion Internal Object
                if (options.StartTime) {
                    this.start = new Date(options.StartTime).toISOString() || null;
                    this.end = new Date(options.EndTime).toISOString() || null;
                }

                // Firebase saves fail with undefined properties, ensure they are null instead
                for (let prop in this) {
                    if (this[prop] === undefined) {
                        this[prop] = null;
                    }
                }
            }
        }

        class Calendar {
            constructor(id, title, events, options) {
                this.id = id;
                this.title = title || "";
                this.events = events || [];
                this.options = options || {};
            }

            getSyncFusionEvents() {
                return this.events.map(e => {
                    return {
                        Id: e.id,
                        Subject: e.title,
                        StartTime: e.start,
                        EndTime: e.end,
                        Description: e.description,
                        RecurrenceRule: e.recurrencerule,
                        Type: parseInt(e.type || 1),

                        //                        IsAllDay: e.allday,
                        Recurrence: e.repeat,
                        RecurrenceID: e.recurrenceID,
                        RecurrenceException: e.recurrenceException
                    }
                });
            }

            defaultEvent(title) {
                var e = new Event({ title: title });

                // sample 1-hour event in local timezone 
                var d = new Date();
                d.setHours(12, 0, 0, 0);
                e.start = d.toISOString();
                d.setHours(13, 0, 0, 0);
                e.end = d.toISOString();

                return e;
            }

            import(c) {
                Object.assign(this, c);
            }

            setEvents(events) {
                console.log(`[app] setEvents ${events.length}`, events);
                this.events = events.map(e => {
                    return new Event(e);
                });
                CalendarDataService.debounce_sync(this);
            }
        }

        class CalendarDataService {
            static connected = false;
            static db = firebase.database().ref('/calendars');
            static db_readonly = firebase.database().ref('/calendars_readonly');

            // subscribe to live updates
            static subscribe(slug, callback) {
                if (!slug) return;

                // First try exact case match
                this.db.child(slug).on('value', async data => {
                    var calendar = data.val();
                    if (calendar && calendar.id) {
                        this.connected = slug;
                        this.validateCalendarData(calendar);
                        callback(calendar);
                    } else {
                        // Calendar not found with exact case - try case-insensitive lookup for editable calendars only
                        try {
                            console.log('Fallback lookup for slug:', slug);
                            console.log('Calling function with data:', { slug: slug });
                            const lookupCalendar = firebase.functions().httpsCallable('lookupCalendar');
                            const result = await lookupCalendar({ slug: slug });

                            if (result.data.found && !result.data.isReadOnly) {
                                // Found as editable calendar - subscribe with correct case
                                this._subscribeExact(result.data.actualSlug, callback);
                            } else {
                                // Calendar doesn't exist as editable
                                callback(null);
                            }
                        } catch (error) {
                            console.error('Case-insensitive lookup failed:', error);
                            console.error('Error details:', {
                                message: error.message,
                                code: error.code,
                                details: error.details,
                                stack: error.stack
                            });
                            // Fall back to treating as new calendar
                            callback(null);
                        }
                    }
                });
            }

            // internal method for exact subscription without fallback
            static _subscribeExact(slug, callback) {
                if (slug) {
                    this.db.child(slug).on('value', data => {
                        var calendar = data.val();
                        if (calendar && calendar.id) {
                            this.connected = slug;
                            this.validateCalendarData(calendar);
                            callback(calendar);
                        } else {
                            callback(null);
                        }
                    })
                }
            }

            // validate and fix calendar data
            static validateCalendarData(calendar) {
                if (!calendar || !calendar.id) return;

                // Auto-create read-only link if it doesn't exist
                SlugManager.autoCreateReadOnlyLink(calendar);

                // Future validation steps can be added here:
                // - Ensure required fields exist
                // - Fix malformed data
                // - Apply data migrations
                // - Validate event formats
            }

            // find calendar (with redirect logic) and subscribe
            static async findAndSubscribe(slug, callback) {
                if (!slug) {
                    console.warn('findAndSubscribe called with empty slug');
                    callback(null);
                    return;
                }

                // First do a lookup to determine calendar type and location
                try {
                    console.log('Looking up calendar for slug:', slug);
                    console.log('Calling function with data:', { slug: slug });
                    const lookupCalendar = firebase.functions().httpsCallable('lookupCalendar');
                    const result = await lookupCalendar({ slug: slug });
                    console.log('Function result:', result);

                    if (result.data.found) {
                        if (result.data.isReadOnly) {
                            // Found as read-only calendar - redirect to view URL
                            window.location.href = `/view/${result.data.actualSlug}`;
                            return; // Don't call callback, we're redirecting
                        } else {
                            // Found as editable calendar - subscribe with correct case
                            this._subscribeExact(result.data.actualSlug, callback);
                        }
                    } else {
                        // Calendar doesn't exist in any case - try direct subscription (might be new)
                        this._subscribeExact(slug, callback);
                    }
                } catch (error) {
                    console.error('Calendar lookup failed:', error);
                    console.error('Error details:', {
                        message: error.message,
                        code: error.code,
                        details: error.details,
                        stack: error.stack
                    });
                    // Fall back to direct subscription
                    this._subscribeExact(slug, callback);
                }
            }

            // subscribe to live updates for read-only calendars
            static subscribe_readonly(slug, callback) {
                if (slug) {
                    this.db_readonly.child(slug).on('value', data => {
                        var calendar = data.val();
                        if (calendar && calendar.id) {
                            // don't set connected
                            callback(calendar);
                        }
                    })
                }
            }


            // only sync if we have existed
            static sync(calendar) {
                if (calendar && calendar.id && this.connected) {
                    // console.log("CalendarDataService.sync()", calendar);
                    this.db.child(calendar.id).set(calendar);
                    console.log('CalendarDataService.sync()');
                }
            }


            static debounce_sync = Utils.debounce((cal) => (CalendarDataService.sync(cal)), 500);

            static create(item) {
                return this.db.push(item);
            }

            static checkExists(id, callback_yes, callback_no) {
                this.db.child(id).once('value', data => {
                    if (data.val()) {
                        callback_yes();
                    } else {
                        callback_no();
                    }
                });
            }

            static createWithId(key, value, success) {
                return this.db.child(key).set(value, (error) => {
                    if (error) {
                        console.log("error creating calendar", error, key, value);
                    } else {
                        success();
                    }
                });
            }

            static update(key, value) {
                return this.db.child(key).update(value);
            }

            static delete(key) {
                return this.db.child(key).remove();
            }
        }
    </script>
</head>

<body class="p-1 m-1">
    <div id="app">
        <!-- Mobile Header -->
        <header class="md:hidden flex flex-col mb-2 pt-3 space-y-3" role="banner">
            <!-- Row 1: Logo, Title, Menu -->
            <div class="flex items-center gap-2 w-full">
                <!-- Logo & Recents -->
                <div class="relative z-40 flex-shrink-0" v-click-outside="closeRecents">
                    <div @click.stop="toggleRecents" class="cursor-pointer flex items-center gap-1">
                        <div class="flex items-center gap-1.5">
                            <img class="h-8 w-8 dark:brightness-150" src="/img/pastecal.logo.svg" alt="PasteCal Logo">
                            <span
                                class="text-sm font-medium text-blue-500 hover:text-blue-600 transition-colors">pastecal</span>
                        </div>
                        <chevron-down-icon class="w-3 h-3 text-color-1"></chevron-down-icon>
                    </div>
                    <navigation-dropdown v-if="showRecents" :recent-calendars="recentCalendars"
                        @go-homepage="goToHomepage" @toggle-pin="togglePin" @remove-recent="removeRecent"
                        class="mt-2"></navigation-dropdown>
                </div>

                <!-- Center: Title (Flex grow to fill space) -->
                <div class="flex-1 min-w-0 flex justify-center z-30 px-1">
                    <calendar-title :title="calendar.title" :is-editing="editTitle" :is-read-only="isReadOnly"
                        mode="mobile" input-ref="mobileTitleInput" class="overflow-hidden w-full max-w-full truncate"
                        @update:title="calendar.title = $event" @click="editTitle = true" @blur="editTitle = false"
                        @enter="editTitle = false" :show-notes-button="true" :toggle-notes="toggleNotes">
                    </calendar-title>
                </div>

                <!-- Right Actions: Share + Menu -->
                <div class="flex items-center gap-1 text-color-1 flex-shrink-0 z-40">
                    <!-- Share button -->
                    <button v-if="isExisting" @click="toggleShare()" aria-label="Share calendar"
                        class="p-1 hover:text-blue-500">
                        <share-icon class="w-5 h-5"></share-icon>
                    </button>
                    <!-- Kebab Menu (...) -->
                    <div class="relative z-40">
                        <button @click.stop="showMobileMenu = !showMobileMenu" aria-label="Open menu"
                            data-testid="mobile-menu-button" class="p-1 hover:text-blue-500">
                            <kebab-icon class="w-5 h-5"></kebab-icon>
                        </button>
                        <!-- Dropdown -->
                        <div v-if="showMobileMenu" v-click-outside="() => showMobileMenu = false"
                            class="absolute right-0 top-full mt-2 w-48 bg-1 rounded-lg shadow-xl border border-color-default py-1 text-sm text-color-2 z-50">
                            <button @click="showMobileMenu = false; toggleSearch()"
                                class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2">
                                <search-icon class="w-4 h-4"></search-icon>
                                Search
                            </button>
                            <button @click="showMobileMenu = false; $refs.quickAddDialog.showDialog()"
                                data-testid="mobile-quick-add-button"
                                class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2">
                                <span class="text-base font-bold text-blue-500">+</span> Quick Add Event
                            </button>
                            <button @click="showMobileMenu = false; toggleSettings()"
                                class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2">
                                <settings-icon size="w-4 h-4"></settings-icon>
                                Settings
                            </button>
                            <button @click="showMobileMenu = false; toggleHelp()"
                                class="w-full text-left px-4 py-2 hover:bg-gray-100 dark:hover:bg-gray-700 flex items-center gap-2">
                                <help-icon class="w-4 h-4"></help-icon>
                                Help
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Row 2: Claim URL (only for new calendars) -->
            <div v-show="!isExisting"
                class="flex items-center bg-1 border border-color-default rounded-lg p-2 shadow-sm">
                <span class="text-color-1 text-sm pl-1 pr-1 font-medium" id="url-prefix-mobile">pastecal.com/</span>
                <input type="text" v-model="calendar.id" @input="handleSlugInput" @keyup.enter="create"
                    class="flex-1 bg-transparent border-none focus:ring-0 p-1 text-sm font-bold text-color-2 min-w-0"
                    placeholder="your-link" aria-label="Custom URL slug" aria-describedby="url-prefix-mobile">
                <button @click="create"
                    class="bg-blue-600 text-white text-sm font-bold px-4 py-1.5 rounded-md shadow-sm whitespace-nowrap"
                    aria-label="Claim calendar URL">
                    Claim URL
                </button>
            </div>
        </header> <!-- Closing header for md:hidden -->

        <header class="hidden md:flex justify-between items-center pb-1 md:pb-3 text-sm" role="banner">
            <!-- Left section -->
            <section class="flex-1 flex items-center gap-3 min-w-0">
                <!-- Logo and app name -->
                <div class="flex items-center text-sm h-8 relative">
                    <div class="relative" v-click-outside="closeRecents" @mouseenter="handleDropdownMouseEnter"
                        @mouseleave="handleDropdownMouseLeave">
                        <div class="flex items-center space-x-2">
                            <a @click.prevent="toggleRecents" class="flex items-center group cursor-pointer">
                                <img class="h-8 w-8 mr-1.5 flex-shrink-0 dark:brightness-150"
                                    src="/img/pastecal.logo.svg" alt="PasteCal Logo">
                                <div class="flex flex-col">
                                    <span
                                        class="text-blue-500 font-medium text-sm hover:text-blue-600 transition-colors">pastecal</span>
                                    <span class="text-color-1 hidden lg:block -mt-0.5 text-[10px]">no-login
                                        shared calendar</span>
                                </div>
                            </a>

                            <!-- Dropdown arrow indicator -->
                            <button @click.stop="toggleRecents"
                                class="text-color-1 hover:text-blue-500 p-1 transition-colors" title="Recent calendars">
                                <chevron-down-icon class="w-3 h-3"></chevron-down-icon>
                            </button>
                        </div>

                        <!-- Navigation dropdown component -->
                        <navigation-dropdown v-if="showRecents" :recent-calendars="recentCalendars"
                            @go-homepage="goToHomepage" @toggle-pin="togglePin" @remove-recent="removeRecent" v-cloak>
                        </navigation-dropdown>
                    </div>
                </div>

                <!-- Action buttons -->
                <nav class="flex items-center gap-1 mt-0" aria-label="Primary navigation">

                    <!-- Help button -->
                    <custom-tooltip width="w-auto" align="center">
                        <template #trigger>
                            <button v-on:click="toggleHelp" aria-label="Show help"
                                class="text-color-1 hover:text-blue-500 p-1.5 rounded-full transition-colors flex items-center justify-center h-8">
                                <help-icon class="w-5 h-5"></help-icon>
                            </button>
                        </template>
                        <template #content>
                            <span class="whitespace-nowrap">Show Help</span>
                        </template>
                    </custom-tooltip>

                    <!-- Search button -->
                    <custom-tooltip width="w-auto" align="center">
                        <template #trigger>
                            <button v-on:click="toggleSearch" aria-label="Search events"
                                class="text-color-1 hover:text-blue-500 p-1.5 rounded-full transition-colors">
                                <search-icon class="w-5 h-5"></search-icon>
                            </button>
                        </template>
                        <template #content>
                            <span class="whitespace-nowrap">Search Events</span>
                        </template>
                    </custom-tooltip>

                    <!-- Settings button -->
                    <custom-tooltip width="w-auto" align="center" v-if="!isReadOnly">
                        <template #trigger>
                            <button v-on:click="toggleSettings" aria-label="Settings"
                                class="text-color-1 hover:text-blue-500 p-1.5 rounded-full transition-colors flex items-center justify-center h-8">
                                <settings-icon size="w-5 h-5"></settings-icon>
                            </button>
                        </template>
                        <template #content>
                            <span class="whitespace-nowrap">Settings</span>
                        </template>
                    </custom-tooltip>

                    <!-- Quick add button - desktop only -->
                    <custom-tooltip width="w-auto" align="center" v-if="!isReadOnly">
                        <template #trigger>
                            <button @click="$refs.quickAddDialog.showDialog()" aria-label="Quick add event"
                                data-testid="desktop-add-event-button"
                                class="text-color-1 hover:text-blue-500 p-1.5 rounded-full transition-colors flex items-center justify-center h-8">
                                <span
                                    class="text-nowrap px-3 py-1 text-white bg-gray-500 rounded-full text-xs hover:bg-blue-600 transition-colors flex-shrink-0 font-bold">+Event</span>
                            </button>
                        </template>
                        <template #content>
                            <span class="whitespace-nowrap">Create event with text (âŒ˜E)</span>
                        </template>
                    </custom-tooltip>

                </nav>
            </section>

            <!-- Middle section - Calendar title -->
            <section
                class="hidden md:flex flex-1 flex-col md:flex-row items-center justify-center mx-1 md:mx-2 min-w-0 min-h-8"
                v-cloak>
                <calendar-title :title="calendar.title" :is-editing="editTitle" :is-read-only="isReadOnly"
                    mode="desktop" input-ref="desktopTitleInput" @update:title="calendar.title = $event"
                    @click="editTitle = true" @blur="editTitle = false" @enter="setTitle($event)"
                    :show-notes-button="true" :toggle-notes="toggleNotes">
                </calendar-title>
            </section>

            <!-- Right section -->
            <section class="flex-1 flex items-center justify-end text-xs min-w-0 h-8" v-cloak>
                <share-or-claim-ui :calendar="calendar" :is-read-only="isReadOnly" :is-existing="isExisting"
                    :is-loading="isLoading" @toggle-share="toggleShare" @create="create"
                    @update-slug="calendar.id = $event; handleSlugInput($event)">
                </share-or-claim-ui>
            </section>
        </header>

        <div class="flex bg-1 p-1 md:p-3 rounded-sm border border-color-default mb-4 relative w-full"
            v-if="isPanelOpen()" v-cloak>
            <button id="closeAllPanels"
                class="absolute top-0 right-0 m-2 md:m-4 text-color-1 hover:text-red-500 transition-colors"
                @click="closeAllPanels">
                <close-icon class="w-6 h-6"></close-icon>
            </button>

            <div v-if="showNotes" class="flex-1 w-full md:w-1/2 md:min-w-[460px] h-[250px] mx-auto p-2.5 flex flex-col"
                v-cloak>
                <!-- Header with Edit/Done toggle -->
                <div class="flex justify-between items-center mb-2">
                    <button v-if="!isReadOnly && (calendar.options.notes || isEditingNotes)"
                        @click="isEditingNotes = !isEditingNotes"
                        class="text-xs font-bold px-3 py-1.5 rounded-full border border-color-default hover:bg-[var(--bg-interactive-hover)] transition-colors flex items-center gap-1 bg-1"
                        style="color: var(--link); border-color: var(--border-color);">
                        <edit-icon v-if="!isEditingNotes" class="w-4 h-4"></edit-icon>
                        <done-icon v-else class="w-4 h-4"></done-icon>
                        {{ isEditingNotes ? 'Done Editing' : 'Edit Notes' }}
                    </button>
                    <span v-else class="text-xs font-bold text-color-1 uppercase tracking-wider">Notes</span>
                </div>

                <!-- Edit Mode -->
                <textarea v-if="!isReadOnly && isEditingNotes" aria-label="Calendar notes"
                    class="w-full flex-1 p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm resize-none"
                    style="background-color: var(--bg); color: var(--fg); border-color: var(--border-color);"
                    placeholder="Notes..." v-model="calendar.options.notes"></textarea>

                <!-- View Mode -->
                <div v-else class="w-full flex-1 p-2 border rounded-lg overflow-y-auto text-sm"
                    style="background-color: var(--bg-disabled); color: var(--fg); border-color: var(--border-color);"
                    v-html="getReadOnlyNotes()">
                </div>
            </div>
            <div v-if="showSearch" class="m-2 md:m-0 flex flex-col-reverse w-full md:w-1/2" v-cloak>

                <section class="flex-1 flex flex-col space-y-4">
                    <!-- Search Input -->
                    <div class="flex flex-col gap-2">
                        <input type="search" v-model="searchQuery" @input="searchEvents" aria-label="Search events"
                            class="w-full p-2 border border-color-default rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                            placeholder="Search events...">
                    </div>

                    <!-- Search Results -->
                    <div v-if="searchResults.length > 0" class="max-h-64 overflow-auto">
                        <div v-for="event in searchResults" :key="event.id" @click="jumpToEvent(event)"
                            :style="{ borderLeft: '3px solid ' + getTypeColor(event.type) }"
                            class="cursor-pointer p-1 pl-4 hover:bg-gray-50 dark:hover:bg-gray-700 transition-colors mb-1">
                            <div class="font-semibold text-color-2">{{ event.title }}</div>
                            <div class="text-xs text-color-1">{{ formatDate(event.start) }} - {{
                                formatDate(event.end)}}</div>
                        </div>
                    </div>
                </section>

                <section class="flex-1 flex flex-col space-y-4 mb-2">

                    <!-- Filter Options -->
                    <div class="flex items-center space-x-2">
                        <span class="text-xs text-color-1">Show</span>
                        <div class="flex space-x-2">
                            <template v-for="(color, idx) in COLORS">
                                <span @click="toggleColorFilter(idx)"
                                    class="w-6 h-6 rounded-full cursor-pointer border-2 transition-all"
                                    :class="{'opacity-100 border-color-default': colorFilters[idx], 'opacity-25': !colorFilters[idx]}"
                                    :style="{ backgroundColor: color }">
                                </span>
                            </template>
                        </div>
                    </div>
                </section>
            </div>
            <div v-if="showHelp" class="text-sm text-color-2 p-4" v-cloak>
                <div class="w-full overflow-hidden rounded-lg">
                    <!-- Welcome Hero -->
                    <div class="mb-6 p-6 bg-2 rounded-lg border-l-4" style="border-color: var(--link);">
                        <h3 class="text-2xl font-bold mb-3" style="color: var(--link);">Shared calendars that just work.
                        </h3>
                        <p class="text-base mb-2">
                            No logins. No installs. Pick a link and start planning together.
                        </p>
                        <p>
                            Great for team schedules, clubs, vacation planning, and more. Everyone with the link
                            can edit in real time.
                        </p>
                    </div>

                    <!-- Feature Grid - 2x2 -->
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3 mb-6">
                        <!-- Q1: How do I share -->
                        <div class="bg-2 rounded-lg p-4">
                            <div class="font-semibold flex items-center gap-2 mb-2">
                                <share-icon class="w-5 h-5 flex-shrink-0" style="color: var(--link);"></share-icon>
                                How do I share a calendar?
                            </div>
                            <div class="text-sm text-color-1">
                                <p>Choose a URL like <code
                                        class="bg-disabled px-1.5 py-0.5 rounded text-xs">pastecal.com/summer-trip</code>
                                    -- that's it. Everyone with the link can view and edit. </p>
                            </div>
                        </div>

                        <!-- Q2: Privacy -->
                        <div class="bg-2 rounded-lg p-4">
                            <div class="font-semibold flex items-center gap-2 mb-2">
                                <lock-icon class="w-5 h-5 flex-shrink-0" style="color: var(--link);"></lock-icon>
                                Is this private?
                            </div>
                            <div class="text-sm text-color-1">
                                <p>Your calendar isn't listed anywhere, so only people with your calendar link can find
                                    it. For privacy, use a hard-to-guess name. Calendars also get a read-only link for
                                    public sharing.
                            </div>
                        </div>

                        <!-- Q3: Mobile -->
                        <div class="bg-2 rounded-lg p-4">
                            <div class="font-semibold flex items-center gap-2 mb-2">
                                <mobile-icon class="w-5 h-5 flex-shrink-0" style="color: var(--link);"></mobile-icon>
                                Can I use this on my phone?
                            </div>
                            <div class="text-sm text-color-1">
                                <p>Yes, it works in any mobile browser. Want
                                    notifications and reminders? Add the ICS link to your phone's calendar app.
                                </p>
                            </div>
                        </div>

                        <!-- Q4: Switch calendars -->
                        <div class="bg-2 rounded-lg p-4">
                            <div class="font-semibold flex items-center gap-2 mb-2">
                                <switch-icon class="w-5 h-5 flex-shrink-0" style="color: var(--link);"></switch-icon>
                                How do I manage multiple calendars?
                            </div>
                            <p class="text-sm text-color-1">Hover over the <strong>PasteCal logo</strong>
                                to jump between your calendars. Make a few!</p>
                        </div>
                    </div>

                    <!-- Simple CTA -->
                    <div class="p-4 bg-2 rounded-lg text-center">
                        <p class="text-sm text-color-1">
                            <strong>Ready? Pick a name in the top right and save your new calendar.</strong>
                        </p>
                    </div>

                    <!-- Footer -->
                    <div class="mt-6 text-xs text-color-1 text-center space-y-1">
                        <p>
                            <a href="https://github.com/kazad/pastecal/issues" class="hover:underline"
                                style="color: var(--link);">
                                Share feedback/bugs on GitHub
                            </a>
                        </p>
                        <p>Made by Kalid (<a href="https://instacalc.com" class="hover:underline"
                                style="color: var(--link);">Instacalc</a>, <a href="https://betterexplained.com"
                                class="hover:underline" style="color: var(--link);">Better Explained</a>)</p>
                    </div>
                </div>
            </div>

            <div v-if="showShare" class="p-2.5 text-sm w-full" v-cloak>
                <h2 class="text-lg font-bold mb-4">Sharing & Security</h2>

                <!-- 2x2 Grid Layout -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">

                    <!-- Edit Access (Top Left) -->
                    <div v-if="!isReadOnly" class="bg-1 p-4 rounded-lg shadow-sm border border-color-default">
                        <h4 class="font-medium mb-2 inline-flex items-center gap-x-2">
                            <edit-icon class="size-5"></edit-icon>
                            Edit Access
                        </h4>
                        <p class="text-xs text-color-1 mb-3 italic">
                            Full editing access - anyone can view and change events
                        </p>
                        <div class="flex gap-2">
                            <input type="text" :value="getEditableURL()" readonly
                                class="flex-1 p-2 border border-color-default rounded bg-disabled text-sm">
                            <button @click="copyToClipboard(getEditableURL(), $event.currentTarget)"
                                class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 flex items-center">
                                <copy-icon class="w-4 h-4"></copy-icon>
                                <span>Copy</span>
                            </button>
                            <button v-if="canShare()" @click="shareUrl(getEditableURL(), 'Calendar')"
                                class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 flex items-center">
                                <export-icon class="h-4 w-4"></export-icon>
                            </button>
                        </div>
                    </div>

                    <!--  View Only (Top Right) -->
                    <div class="bg-1 p-4 rounded-lg shadow-sm border border-color-default">
                        <h4 class="font-medium mb-2 inline-flex items-center gap-x-2">
                            <eye-icon class="size-5"></eye-icon>
                            View Only
                        </h4>
                        <p class="text-xs text-color-1 mb-3 italic">
                            Read-only access - users can view but not edit events
                        </p>

                        <!-- View-only link (auto-created) -->
                        <div class="space-y-2">
                            <div class="flex gap-2">
                                <input type="text" :value="getReadOnlyURL()" readonly
                                    class="flex-1 p-2 border border-color-default rounded bg-disabled text-sm">
                                <button @click="copyToClipboard(getReadOnlyURL(), $event.currentTarget)"
                                    class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 flex items-center">
                                    <copy-icon class="w-4 h-4"></copy-icon>
                                    <span>Copy</span>
                                </button>
                                <button v-if="canShare()" @click="shareUrl(getReadOnlyURL(), 'Calendar')"
                                    class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 flex items-center">
                                    <export-icon class="h-4 w-4"></export-icon>
                                </button>
                            </div>

                            <!-- Short URL alias -->
                            <div class="text-xs text-color-1">
                                Short: pastecal.com/{{ getReadOnlySlug() }}
                            </div>

                            <!-- Customize existing link -->
                            <div class="">
                                <button @click="showReadOnlySlug = !showReadOnlySlug"
                                    class="text-xs text-blue-500 hover:text-blue-600">
                                    {{ showReadOnlySlug ? 'Cancel' : 'Customize URL' }}
                                </button>

                                <div v-if="showReadOnlySlug" class="mt-2">
                                    <div class="flex gap-2">
                                        <input type="text" v-model="readOnlySlugInput" placeholder="Enter custom name"
                                            class="flex-1 p-2 border border-color-default rounded bg-bg text-sm">
                                        <button @click="customizeExistingLink" :disabled="!readOnlySlugInput.trim()"
                                            class="px-3 py-1 bg-green-500 text-white rounded hover:bg-green-600 disabled:bg-gray-400 text-xs">
                                            Update
                                        </button>
                                    </div>
                                    <div class="text-xs text-color-1 mt-1">
                                        New: pastecal.com/view/{{ readOnlySlugInput || 'custom-name' }}
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Current View (Bottom Left) -->
                    <div class="bg-1 p-4 rounded-lg shadow-sm border border-color-default">
                        <h4 class="font-medium mb-2 inline-flex items-center gap-x-2">
                            <link-icon class="size-5"></link-icon>
                            Current View
                        </h4>
                        <p class="text-xs text-color-1 mb-3 italic">
                            Share link to current date and view. Or add URL params: <code
                                class="bg-disabled px-1 py-0.5 rounded text-xs">?date=2024-04-01&view=week</code>
                        </p>
                        <div class="flex gap-2">
                            <input type="text" :value="currentViewURL" readonly
                                class="flex-1 p-2 border border-color-default rounded bg-disabled text-sm">
                            <button @click="copyToClipboard(currentViewURL, $event.currentTarget)"
                                class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 flex items-center">
                                <copy-icon class="w-4 h-4"></copy-icon>
                                <span>Copy</span>
                            </button>
                            <button v-if="canShare()" @click="shareUrl(currentViewURL, 'Calendar View')"
                                class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 flex items-center">
                                <export-icon class="h-4 w-4"></export-icon>
                            </button>
                        </div>
                    </div>

                    <!-- Phone/Apps (Bottom Right) -->
                    <div class="bg-1 p-4 rounded-lg shadow-sm border border-color-default">
                        <h4 class="font-medium mb-2 inline-flex items-center gap-x-2">
                            <device-icon class="size-5"></device-icon>
                            Phone/Apps
                        </h4>
                        <p class="text-xs text-color-1 mb-3 italic">
                            ICS link for other apps (phone calendar, Outlook, Google Calendar, etc.)
                        </p>

                        <!-- Edit ICS -->
                        <div class="space-y-3">
                            <div v-if="!isReadOnly">
                                <div class="text-xs font-medium text-color-2 mb-1">Full Access:</div>
                                <div class="flex gap-2">
                                    <input type="text" :value="getEditableICSURL()" readonly
                                        class="flex-1 p-2 border border-color-default rounded bg-disabled text-sm">
                                    <button @click="copyToClipboard(getEditableICSURL(), $event.currentTarget)"
                                        class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 flex items-center">
                                        <copy-icon class="w-4 h-4" />
                                        <span>Copy</span>
                                    </button>
                                </div>
                            </div>

                            <!-- View-Only ICS -->
                            <div v-if="getReadOnlyURL()">
                                <div class="text-xs font-medium text-color-2 mb-1">View Only:</div>
                                <div class="flex gap-2">
                                    <input type="text" :value="getReadOnlyICSURL()" readonly
                                        class="flex-1 p-2 border border-color-default rounded bg-disabled text-sm">
                                    <button @click="copyToClipboard(getReadOnlyICSURL(), $event.currentTarget)"
                                        class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 flex items-center">
                                        <copy-icon class="w-4 h-4" />
                                        <span>Copy</span>
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>

                </div>
            </div>

            <div v-if="showSettings" class="w-full p-2.5 text-sm text-color-2" v-cloak>

                <h2 class="text-lg font-bold mb-4">Settings</h2>

                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Global Settings -->
                    <div class="bg-1 p-4 rounded-lg shadow-sm border border-color-default">
                        <h3 class="font-bold text-color-2 mb-3">Personal Settings</h3>
                        <p class="text-xs text-color-1 mb-4 italic">Default settings for your device, when viewing any
                            calendar.
                        </p>

                        <div class="space-y-4">
                            <div>
                                <label class="block mb-1 font-medium">First day of week</label>
                                <select v-model="globalSettings.firstDayOfWeek" @change="saveGlobalSettings"
                                    class="w-full p-2 border border-color-default rounded ">
                                    <option value="0">Sunday</option>
                                    <option value="1">Monday</option>
                                </select>
                            </div>

                            <div>
                                <label class="block mb-1 font-medium">Time format</label>
                                <select v-model="globalSettings.timeFormat" @change="saveGlobalSettings"
                                    class="w-full p-2 border border-color-default rounded ">
                                    <option value="12">12-hour (1:00 PM)</option>
                                    <option value="24">24-hour (13:00)</option>
                                </select>
                            </div>

                            <div>
                                <label class="block mb-1 font-medium">Personal default view</label>
                                <select v-model="globalSettings.defaultView" @change="saveGlobalSettings"
                                    class="w-full p-2 border border-color-default rounded ">
                                    <option value="Day">Day</option>
                                    <option value="Week">Week</option>
                                    <option value="Month">Month</option>
                                    <option value="Custom">Custom ({{ personalCustomViewLabel }})</option>
                                    <option value="Year">Year</option>
                                    <option value="Agenda">Agenda</option>
                                </select>

                                <!-- Custom view configuration panel -->
                                <div v-if="globalSettings.defaultView === 'Custom'"
                                    class="mt-3 p-3 bg-color-panel border border-color-default rounded">
                                    <label class="block mb-2 text-sm font-medium">Custom view settings</label>
                                    <div class="flex items-center gap-2">
                                        <input type="number" v-model.number="globalSettings.customViewDuration"
                                            @change="saveGlobalSettings" :min="1"
                                            :max="globalSettings.customViewUnit === 'Weeks' ? 52 : 24"
                                            class="w-20 p-2 border border-color-default rounded text-sm">
                                        <select v-model="globalSettings.customViewUnit" @change="saveGlobalSettings"
                                            class="flex-1 p-2 border border-color-default rounded text-sm">
                                            <option value="Weeks">Weeks</option>
                                            <option value="Months">Months</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="block mb-1 font-medium">Start hour</label>
                                <select v-model="globalSettings.startHour" @change="saveGlobalSettings"
                                    class="w-full p-2 border border-color-default rounded ">
                                    <option value="00:00">12:00 AM</option>
                                    <option value="05:00">5:00 AM</option>
                                    <option value="06:00">6:00 AM</option>
                                    <option value="07:00">7:00 AM</option>
                                    <option value="08:00">8:00 AM</option>
                                    <option value="09:00">9:00 AM</option>
                                </select>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-color-2 mb-2">
                                    Theme
                                </label>
                                <div class="relative">
                                    <select v-model="globalSettings.darkMode" @change="saveGlobalSettings"
                                        class="appearance-none bg-1 border border-color-default text-color-2 rounded-lg px-4 py-2 pr-8 w-full focus:outline-none focus:ring-2 focus:ring-link focus:border-transparent">
                                        <option value="auto">ðŸŒ“ Auto (System)</option>
                                        <option value="light">â˜€ï¸ Light</option>
                                        <option value="dark">ðŸŒ™ Dark</option>
                                    </select>
                                    <div class="absolute inset-y-0 right-0 flex items-center px-2 pointer-events-none">
                                        <svg class="w-4 h-4 text-color-1" fill="none" stroke="currentColor"
                                            viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M19 9l-7 7-7-7"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Calendar-specific Settings -->
                    <div class="bg-1 p-4 rounded-lg shadow-sm border border-color-default">
                        <h3 class="font-bold text-color-2 mb-3">Settings for '{{calendar.title}}' </h3>
                        <p class="text-xs text-color-1 mb-4 italic">Default settings for everyone viewing this calendar.
                        </p>

                        <div class="space-y-4">
                            <div class="relative">
                                <label class="block mb-1 font-medium">Event Colors &amp; Labels</label>
                                <p class="text-xs text-color-1 mb-2 italic">Click color circle or text to customize</p>

                                <button v-if="hasCustomColors" @click="resetAllColors"
                                    class="absolute right-0 top-0 text-xs text-link hover:text-link-hover">
                                    Reset colors
                                </button>

                                <div v-for="(label, index) in localSettings.typeLabels" :key="index"
                                    class="flex items-center mb-2">
                                    <div class="relative">
                                        <input type="color" :id="'color-picker-' + index"
                                            :value="localSettings.colors[index]"
                                            @change="updateEventColor(index, $event.target.value)"
                                            :aria-label="'Color picker for ' + (localSettings.typeLabels[index] || 'event type ' + (index + 1))"
                                            class="absolute inset-0 w-full h-full opacity-0 cursor-pointer">
                                        <div class="w-5 h-5 rounded-full mr-2 cursor-pointer hover:ring-2 hover:ring-offset-1 hover:ring-link transition-all"
                                            :style="{backgroundColor: getTypeColor(index+1)}"></div>
                                    </div>
                                    <input :value="label" @input="updateTypeLabel(index+1, $event.target.value)"
                                        :aria-label="'Label for type ' + (index + 1)"
                                        class="flex-1 p-2 border border-color-default rounded text-sm"
                                        :placeholder="`Type ${index+1}`">
                                </div>
                            </div>

                            <!-- Default View -->
                            <div>
                                <label class="block mb-1 font-medium">Default view when calendar is opened</label>
                                <select v-model="calendar.options.defaultView"
                                    class=" w-1/3 p-2 border border-color-default rounded text-sm">
                                    <option :value="null">Auto ({{ calendarAutoViewLabel }})</option>
                                    <option value="Day">Day</option>
                                    <option value="Week">Week</option>
                                    <option value="Month">Month</option>
                                    <option value="Custom">Custom ({{ calendarCustomViewLabel }})</option>
                                    <option value="Year">Year</option>
                                    <option value="Agenda">Agenda</option>
                                </select>
                                <p class="mt-1 text-xs text-color-secondary italic">
                                    Auto allows the user's preference to load. Setting a default forces everyone to
                                    start on the same view.
                                </p>

                                <!-- Custom view configuration panel for calendar -->
                                <div v-if="calendar.options.defaultView === 'Custom'"
                                    class="mt-3 p-3 bg-color-panel border border-color-default rounded">
                                    <label class="block mb-2 text-sm font-medium">Custom view settings</label>
                                    <div class="flex items-center gap-2">
                                        <input type="number" v-model.number="calendar.options.customViewDuration"
                                            :min="1" :max="calendar.options.customViewUnit === 'Weeks' ? 52 : 24"
                                            class="w-20 p-2 border border-color-default rounded text-sm">
                                        <select v-model="calendar.options.customViewUnit"
                                            class="flex-1 p-2 border border-color-default rounded text-sm">
                                            <option value="Weeks">Weeks</option>
                                            <option value="Months">Months</option>
                                        </select>
                                    </div>
                                </div>
                            </div>

                            <div>
                                <label class="block mb-1 font-medium">Display options</label>
                                <div class="flex items-center mt-2">
                                    <input type="checkbox" id="extendedHours" v-model="calendar.options.extended"
                                        class="mr-2">
                                    <label for="extendedHours">Show extended hours (12-4 AM)</label>
                                </div>
                            </div>

                            <!-- 
                                // Rename / Move (COMMENTED OUT FOR NOW)
                            <div v-if="isAutogeneratedId" class="pt-4 border-t border-color-default mt-4">
                                <h4 class="font-bold text-red-600 mb-2 text-xs uppercase tracking-wider">Danger Zone</h4>
                                
                                <div class="mb-1">
                                    <label class="block mb-1 font-medium text-xs text-color-2">Rename / Move Calendar</label>
                                    <p class="text-xs text-color-1 mb-2 italic">Copy this calendar's data to a new URL. The old URL will remain accessible.</p>
                                    <div class="flex gap-2">
                                        <input type="text" v-model="newCalendarId" placeholder="new-name" 
                                               class="flex-1 p-2 border border-color-default rounded text-sm"
                                               @keyup.enter="renameCalendar">
                                        <button @click="renameCalendar" 
                                                class="px-3 py-1 bg-red-50 text-red-600 border border-red-200 rounded text-xs hover:bg-red-100 transition-colors whitespace-nowrap">
                                            Move
                                        </button>
                                    </div>
                                </div>
                            </div>
                            -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="cal2_wrap" style="width: 100%; height: 100%;">
            <div id="Schedule"></div>
        </div>

        <!-- Claim Intervention Modal -->
        <div v-if="showClaimDialog"
            class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[1000]" v-cloak>
            <div class="bg-1 rounded-lg shadow-xl p-6 w-full max-w-md mx-4 relative">
                <button @click="showClaimDialog = false"
                    class="absolute top-4 right-4 text-gray-400 hover:text-gray-600">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                        <path fill-rule="evenodd"
                            d="M4.293 4.293a1 1 0 011.414 0L10 8.586l4.293-4.293a1 1 0 111.414 1.414L11.414 10l4.293 4.293a1 1 0 01-1.414 1.414L10 11.414l-4.293 4.293a1 1 0 01-1.414-1.414L8.586 10 4.293 5.707a1 1 0 010-1.414z"
                            clip-rule="evenodd" />
                    </svg>
                </button>

                <div class="text-center mb-6">
                    <h3 class="text-lg font-bold text-gray-900 mb-2">Name your calendar</h3>
                    <p class="text-sm text-gray-600">
                        You're about to claim this permanent link.
                        <br>
                        Want to give it a custom name to make it easier to remember?
                    </p>
                </div>

                <div class="mb-6">
                    <div class="flex items-center border-2 border-blue-500 rounded-md overflow-hidden bg-white">
                        <span
                            class="pl-3 pr-1 text-gray-500 text-sm font-medium bg-gray-50 h-10 flex items-center border-r border-gray-200">pastecal.com/</span>
                        <input ref="claimInput" type="text" v-model="calendar.id" aria-label="Claim custom URL"
                            class="flex-1 p-2 text-gray-900 font-medium focus:outline-none" placeholder="my-calendar"
                            @keyup.enter="confirmClaim">
                    </div>
                    <p class="text-xs text-gray-500 mt-2 text-center">
                        Examples: <span class="italic">marketing-schedule, trip-2025, soccer-team</span>
                    </p>
                </div>
                <button @click="confirmClaim"
                    class="w-full py-2.5 px-4 bg-blue-600 hover:bg-blue-700 text-white font-bold rounded-lg shadow-md transition-colors flex items-center justify-center gap-2">
                    <span>Claim URL</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24"
                        stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                            d="M14 5l7 7m0 0l-7 7m7-7H3" />
                    </svg>
                </button>
            </div>
        </div>

        <pre v-text="syncFusionEvents" v-if="debug"></pre>
        <pre v-text="calendar" v-if="debug"></pre>

        <quick-add-dialog ref="quickAddDialog" @event-created="handleQuickAddEvent"></quick-add-dialog>
        <toast-notification ref="toast"></toast-notification>
    </div>

    <script type="text/x-template" id="tooltip-template">
        <div class="relative" @mouseenter="show = true" @mouseleave="show = false">
            <slot name="trigger"></slot>
            <div v-show="show && !isMobile" 
                class="absolute top-full mt-2 p-3 bg-2 text-color-2 text-xs rounded-lg shadow-xl border border-color-default z-50 transition-opacity duration-200"
                :class="[widthClass, alignClass]">
                
                <slot name="content"></slot>
                
                <!-- Arrow -->
                <div class="absolute -top-1 w-2 h-2 bg-2 transform rotate-45 border-l border-t border-color-default"
            </div>
        </div>
    </script>

    <script type="text/x-template" id="share-or-claim-template">
        <div class="flex items-center justify-end text-xs min-w-0 h-8">
            <!-- Loading state -->
            <div v-if="isLoading" class="mr-2">
                <div class="flex items-center bg-1 border border-color-default rounded-full p-1 pl-3 pr-3 shadow-sm select-none opacity-70">
                    <div class="text-color-1 text-xs">Loading...</div>
                </div>
            </div>

            <template v-if="!isLoading">
                <!-- Read Only Mode -->
                <div v-if="isReadOnly">
                    <custom-tooltip align="right">
                        <template #trigger>
                            <div class="flex items-center bg-1 border border-color-default rounded-full p-1 pl-3 pr-3 shadow-sm cursor-pointer select-none hover:border-blue-500 hover:bg-[var(--bg-interactive-hover)] transition-all"
                                @click="toggleShare">
                                <!-- Share Icon -->
                                <div class="text-color-1 flex-shrink-0 mr-1.5">
                                    <share-icon class="w-4 h-4"></share-icon>
                                </div>
                                <!-- Text -->
                                <div class="text-color-1 text-xs font-bold">
                                    View Only
                                </div>
                            </div>
                        </template>
                        <template #content>
                            <p class="leading-relaxed">
                                You are in View Only mode. Events cannot be added or edited.
                            </p>
                        </template>
                    </custom-tooltip>
                </div>

                <!-- Edit Mode (Existing or New) -->
                <div v-else>
                    <!-- Existing calendar info -->
                    <div v-if="isExisting">
                        <custom-tooltip align="right">
                            <template #trigger>
                                <div class="relative flex items-center bg-1 border border-color-default rounded-full p-1 pl-3 pr-3 shadow-sm hover:border-blue-500 hover:bg-[var(--bg-interactive-hover)] cursor-pointer transition-all group select-none"
                                    @click="toggleShare">

                                    <!-- Icon -->
                                    <div class="text-color-1 group-hover:text-blue-500 transition-colors flex-shrink-0 p-1 rounded-full mr-1">
                                        <share-icon class="w-4 h-4"></share-icon>
                                    </div>

                                    <!-- URL Text -->
                                    <div class="text-color-1 text-xs truncate max-w-[150px] md:max-w-xs">
                                        pastecal.com/<span class="font-bold text-color-2" v-text="calendar.id"></span>
                                    </div>
                                </div>
                            </template>
                            <template #content>
                                <p class="leading-relaxed">
                                    Get links to share with anyone or sync to your phone.
                                </p>
                            </template>
                        </custom-tooltip>
                    </div>

                    <!-- New calendar creation -->
                    <div v-else class="flex flex-wrap md:flex-nowrap items-center gap-2 relative">
                        <custom-tooltip>
                            <template #trigger>
                                <!-- Unified Pill Container -->
                                <div class="flex items-center bg-1 border border-color-default rounded-full p-0 sm:p-1 pl-1.5 sm:pl-3 pr-0 sm:pr-1 shadow-sm focus-within:border-blue-500 focus-within:ring-2 focus-within:ring-blue-100 transition-all max-w-full relative">
                                    <!-- Domain -->
                                    <span class="text-color-1 text-sm font-medium hidden md:inline flex-shrink-0 tracking-tight">pastecal.com/</span>
                                    <span class="text-color-1 text-sm font-medium md:hidden flex-shrink-0">/</span>

                                    <!-- Input -->
                                    <input id="slug"
                                        class="bg-transparent border-none focus:ring-0 p-0 text-sm font-bold text-color-2 w-24 md:w-40 focus:outline-none placeholder-gray-400 min-w-0"
                                        type="text" 
                                        :value="calendar.id"
                                        @input="handleSlugInput"
                                        @keyup.enter="create"
                                        placeholder="your-name">

                                    <!-- Claim Button (Integrated) -->
                                    <button @click="create"
                                        class="ml-0.5 sm:ml-1 px-2 sm:px-3 py-1 sm:py-1.5 text-white bg-blue-600 font-bold rounded-full text-xs hover:bg-blue-700 transition-colors flex-shrink-0 shadow-sm">
                                        <span class="hidden sm:inline">Claim URL</span>
                                        <span class="inline sm:hidden">Claim</span>
                                    </button>
                                </div>
                            </template>
                            <template #content>
                                <p class="leading-relaxed">
                                    Claim any URL, like `/trip-2025`. Everyone with the URL can edit events. Use a random ID for privacy.
                                </p>
                            </template>
                        </custom-tooltip>
                    </div>
                </div>
            </template>
        </div>
    </script>

    <script type="text/x-template" id="calendar-title-template">
        <div class="calendar-title-component w-full text-center flex justify-center items-center gap-1">
            <!-- Edit Mode -->
            <input v-if="isEditing"
                type="text"
                :value="title"
                @input="$emit('update:title', $event.target.value)"
                @blur="$emit('blur')"
                @keyup.enter="$emit('enter', $event)"
                :ref="inputRef"
                aria-label="Calendar title"
                :class="inputClass">

            <!-- View Mode -->
            <template v-else>
                <!-- Desktop + Editable: Show Title with Tooltip -->
                <custom-tooltip width="w-auto" align="center" v-if="!isReadOnly && mode === 'desktop'">
                    <template #trigger>
                        <h1 @click="handleTitleClick" :class="titleClasses">
                            {{ title || 'New Calendar' }}
                        </h1>
                    </template>
                    <template #content>
                        <span class="whitespace-nowrap">Click to edit title</span>
                    </template>
                </custom-tooltip>

                <!-- Mobile OR ReadOnly: Just Title -->
                <h1 v-else
                    @click="handleTitleClick"
                    :class="titleClasses">
                    {{ title || 'New Calendar' }}
                </h1>

                <!-- Notes Button -->
                <custom-tooltip width="w-auto" align="center" v-if="showNotesButton && !isEditing">
                    <template #trigger>
                        <button v-on:click="handleToggleNotes"
                            aria-label="Toggle notes"
                            class="text-color-1 hover:text-blue-500 p-1.5 rounded-full transition-colors flex items-center justify-center h-8">
                            <notes-icon class="w-5 h-5"></notes-icon>
                            <span v-if="mode === 'desktop'" class="ml-0.5 text-xs hidden lg:inline">Notes</span>
                        </button>
                    </template>
                    <template #content>
                        <span class="whitespace-nowrap">Toggle Notes</span>
                    </template>
                </custom-tooltip>
            </template>
        </div>
    </script>

    <script type="text/x-template" id="navigation-dropdown-template">
        <div class="absolute top-full left-0 md:left-0 mt-2 bg-1 min-w-[280px] md:min-w-[280px] w-[90vw] md:w-auto max-w-[280px] shadow-lg rounded-lg border border-color-default overflow-hidden z-50">
            <!-- Home / New Calendar option -->
            <a @click.prevent="$emit('go-homepage')"
                class="flex items-center px-4 py-3 text-color-2 hover:bg-1 transition-colors cursor-pointer group">
                <div class="mr-3 text-color-1 group-hover:text-blue-500 transition-colors">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="m2.25 12 8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
                    </svg>
                </div>
                <span class="font-medium group-hover:text-blue-500 transition-colors">Home [New Calendar]</span>
            </a>

            <!-- Recent calendars -->
            <div v-if="recentCalendars.length > 0">
                <div class="px-4 py-2 text-xs font-semibold text-color-1 uppercase tracking-wider bg-1 border-t border-color-default">
                    Recent Calendars
                </div>
                <div class="max-h-[36rem] overflow-y-auto">
                    <div v-for="item in recentCalendars" :key="item.id"
                        class="flex justify-between items-center px-4 py-3 hover:bg-1 transition-colors group">
                        <a :href="'/' + item.id" class="flex-1 min-w-0 mr-3">
                            <div class="text-color-2 font-medium truncate group-hover:text-blue-500 transition-colors">
                                {{ item.title }}
                            </div>
                            <div class="text-xs text-color-1 truncate">
                                pastecal.com/{{ item.id }}
                            </div>
                        </a>
                        <div class="flex items-center gap-1 transition-opacity"
                            :class="{ 'opacity-100': item.pinned, 'opacity-0 group-hover:opacity-100': !item.pinned }">
                            <button @click.stop="$emit('toggle-pin', item.id)"
                                class="p-1.5 rounded-md hover:bg-1 transition-colors text-color-1"
                                :class="{ 'text-color-2': item.pinned }"
                                :title="item.pinned ? 'Unpin calendar' : 'Pin calendar'">
                                <star-icon :filled="item.pinned" class="w-4 h-4"></star-icon>
                            </button>
                            <button @click.stop="$emit('remove-recent', item.id)"
                                class="p-1.5 rounded-md text-color-1 hover:text-red-500 hover:bg-1 transition-colors"
                                title="Remove from recent">
                                <trash-icon class="w-4 h-4"></trash-icon>
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div v-if="recentCalendars.length === 0" class="px-4 py-6 text-center">
                <div class="w-8 h-8 mx-auto mb-2 text-color-1 opacity-50 flex justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
                        <path stroke-linecap="round" stroke-linejoin="round" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" />
                    </svg>
                </div>
                <p class="text-sm text-color-1">No recent calendars yet</p>
                <p class="text-xs text-color-1 opacity-60 mt-1">Your calendars will appear here</p>
            </div>
        </div>
    </script>

    <script type="text/x-template" id="toast-notification-template">
        <transition 
            enter-active-class="transform ease-out duration-300 transition"
            enter-from-class="translate-y-2 opacity-0 sm:translate-y-0 sm:translate-x-2"
            enter-to-class="translate-y-0 opacity-100 sm:translate-x-0"
            leave-active-class="transition ease-in duration-100"
            leave-from-class="opacity-100"
            leave-to-class="opacity-0">
            <div v-if="show" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 z-[100] w-full max-w-sm px-4">
                <div class="w-full bg-2 border border-color-default shadow-lg rounded-lg pointer-events-auto ring-1 ring-black ring-opacity-5 overflow-hidden">
                    <div class="p-4">
                        <div class="flex items-start">
                            <div class="flex-shrink-0">
                                <!-- Success Icon -->
                                <check-icon v-if="type === 'success'" class="h-6 w-6 text-green-400"></check-icon>
                                <!-- Error Icon -->
                                <x-icon v-if="type === 'error'" class="h-6 w-6 text-red-400"></x-icon>
                                <!-- Info Icon -->
                                <info-icon v-if="type === 'info'" class="h-6 w-6 text-blue-400"></info-icon>
                            </div>
                            <div class="ml-3 w-0 flex-1 pt-0.5">
                                <p class="text-sm font-medium text-color-2">
                                    {{ message }}
                                </p>
                            </div>
                            <div class="ml-4 flex-shrink-0 flex">
                                <button @click="hide" class="bg-transparent rounded-md inline-flex text-color-1 hover:text-color-2 focus:outline-none focus:ring-2 focus:ring-offset-2 focus:ring-blue-500">
                                    <span class="sr-only">Close</span>
                                    <x-icon class="h-5 w-5"></x-icon>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </transition>
    </script>

    <script type="text/x-template" id="quick-add-dialog-template">
        <div v-if="dialogVisible" 
                class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-[1001]">
            <div class="bg-1 rounded-lg p-6 w-[80%] max-w-[500px] shadow-2xl">
                <h3 class="text-lg font-semibold mb-4">Add Event by Typing</h3>
                <form @submit.prevent="createEvent">
                    <textarea v-model="description"
                                aria-label="Event description"
                                placeholder="Describe event here (e.g., 'Meet John tomorrow 2pm'). Hit Enter to create."
                                rows="3"
                                @keydown.enter.prevent="handleEnter"
                                class="w-full p-2 border border-color-default rounded mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
                    </textarea>

                    <div class="bg-1 rounded p-4 mb-4">
                        <p><strong>Subject:</strong> {{ parsedEvent?.subject }}</p>
                        <p><strong>Start:</strong> {{ formatDate(parsedEvent?.startDateTime) }}</p>
                        <p><strong>End:</strong> {{ formatDate(parsedEvent?.endDateTime) }}</p>
                    </div>

                    <pre class="bg-1 p-4 rounded mb-4 text-sm whitespace-pre overflow-x-auto">
Examples: 
    
lunch tomorrow 2pm for 1 hour
appointment 9/15 at 2:30pm
birthday party Sat 7pm to 11pm
workout 3pm May 20 for 90 minutes
vacation dec 11 - dec 15
</pre>

                    <div class="flex justify-end gap-2">
                        <button type="button" 
                                @click="hideDialog"
                                class="px-4 py-2 border border-color-default rounded hover:bg-[var(--bg-interactive-hover)]">
                            Cancel
                        </button>
                        <button type="submit" 
                                :disabled="!isValidEvent"
                                class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50">
                            Create
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </script>

    <script>
        const ToastNotification = {
            template: '#toast-notification-template',
            data() {
                return {
                    show: false,
                    message: '',
                    type: 'info',
                    timer: null
                }
            },
            methods: {
                display(message, type = 'info') {
                    this.message = message;
                    this.type = type;
                    this.show = true;

                    if (this.timer) clearTimeout(this.timer);
                    this.timer = setTimeout(() => {
                        this.hide();
                    }, 3000);
                },
                hide() {
                    this.show = false;
                }
            }
        };

        const QuickAddDialog = {
            template: "#quick-add-dialog-template",
            data() {
                return {
                    dialogVisible: false,
                    description: '',
                    parsedEvent: null
                };
            },
            computed: {
                isValidEvent() {
                    return this.parsedEvent &&
                        this.parsedEvent.subject &&
                        this.parsedEvent.startDateTime &&
                        !isNaN(new Date(this.parsedEvent.startDateTime).getTime());
                }
            },

            watch: {
                description() {
                    this.parseDescription();
                }
            },
            mounted() {
                window.addEventListener('keydown', this.handleKeydown);
            },
            beforeDestroy() {
                window.removeEventListener('keydown', this.handleKeydown);
            },
            methods: {
                showDialog() {
                    this.dialogVisible = true;
                    this.$nextTick(() => {
                        this.$el.querySelector('textarea').focus();
                    });
                },
                hideDialog() {
                    this.dialogVisible = false;
                    this.description = '';
                    this.parsedEvent = null;
                },
                parseDescription() {
                    this.parsedEvent = Utils.parseHumanWrittenCalendar(this.description);
                },
                createEvent() {
                    if (this.parsedEvent) {
                        this.$emit('event-created', this.parsedEvent);
                        this.hideDialog();
                    }
                },
                formatDate(dateString) {
                    if (!dateString) return '';
                    const options = { weekday: 'short', month: 'short', year: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric', hour12: true };
                    return new Date(dateString).toLocaleString(undefined, options);
                },
                handleKeydown(event) {
                    // Check for Cmd+A (Mac) or Ctrl+A (Windows/Linux)
                    if ((event.metaKey || event.ctrlKey) && event.key === 'e') {
                        event.preventDefault();
                        this.showDialog();
                    }
                    // Check for Escape key when dialog is visible
                    if (event.key === 'Escape' && this.dialogVisible) {
                        this.hideDialog();
                    }
                },
                handleEnter(event) {
                    // If Shift key is not pressed, submit the form
                    if (!event.shiftKey) {
                        this.createEvent();
                    }
                }
            }
        };

        // Vue directive for handling clicks outside an element
        const clickOutside = {
            mounted(el, binding) {
                el._clickOutside = (event) => {
                    if (!(el === event.target || el.contains(event.target))) {
                        binding.value(event);
                    }
                };
                document.addEventListener('click', el._clickOutside);
            },
            unmounted(el) {
                document.removeEventListener('click', el._clickOutside);
            }
        };


        // SlugManager static class for centralized read-only link operations
        class SlugManager {
            // Normalize slug for consistent lookup (matches backend)
            static normalizeSlug(slug) {
                return slug?.toLowerCase();
            }

            // Core method - handles all read-only link creation scenarios
            static async createReadOnlyLink(calendar, options = {}) {
                const { customSlug = null, autoCreate = false } = options;
                const createPublicLink = firebase.functions().httpsCallable('createPublicLink');

                try {
                    const params = { sourceCalendarId: calendar.id };
                    if (customSlug) {
                        params.customSlug = customSlug.trim();
                    }

                    const result = await createPublicLink(params);
                    const { publicViewId } = result.data;

                    // Update calendar options
                    if (!calendar.options) {
                        calendar.options = {};
                    }
                    calendar.options.publicViewId = publicViewId;

                    // Auto-save for auto-creation
                    if (autoCreate) {
                        CalendarDataService.db.child(calendar.id).set(calendar);
                    }

                    console.log(`${autoCreate ? 'Auto-created' : 'Created'} read-only link:`, publicViewId);
                    return publicViewId;

                } catch (error) {
                    console.error('Error creating read-only link:', error);
                    if (!autoCreate) {
                        alert('Failed to create read-only link: ' + (error.message || 'Please try again.'));
                        throw error;
                    }
                    // For auto-create, just log and suppress error so we don't block loading
                }
            }

            // Specific read-only link operations with clear naming
            static autoCreateReadOnlyLink(calendar) {
                if (!calendar.options?.publicViewId) {
                    return this.createReadOnlyLink(calendar, { autoCreate: true });
                }
            }

            static createReadOnlyLinkWithCustomSlug(calendar, customSlug) {
                return this.createReadOnlyLink(calendar, { customSlug });
            }

            static customizeReadOnlyLink(calendar, customSlug) {
                return this.createReadOnlyLink(calendar, { customSlug });
            }

            // Helper methods - distinguish between slug and full URL
            static getReadOnlySlug(calendar) {
                return calendar.options?.publicViewId;
            }

            static hasReadOnlyLink(calendar) {
                return !!(calendar.options?.publicViewId);
            }

            static getReadOnlyURL(calendar) {
                const slug = this.getReadOnlySlug(calendar);
                return slug ? `${window.location.origin}/view/${slug}` : null;
            }

            static getReadOnlyICSURL(calendar) {
                const slug = this.getReadOnlySlug(calendar);
                return slug ? `${window.location.origin}/view/${slug}.ics` : null;
            }
        }

        const Tooltip = {
            template: '#tooltip-template',
            props: {
                width: {
                    type: String,
                    default: 'w-64'
                },
                align: {
                    type: String,
                    default: 'left' // 'left' or 'right'
                }
            },
            data() {
                return {
                    show: false,
                    isMobile: false
                }
            },
            mounted() {
                this.checkMobile();
                window.addEventListener('resize', this.checkMobile);
            },
            beforeUnmount() {
                window.removeEventListener('resize', this.checkMobile);
            },
            methods: {
                checkMobile() {
                    this.isMobile = window.innerWidth <= 768; // Adjust breakpoint as needed
                }
            },
            computed: {
                widthClass() {
                    return this.width;
                },
                alignClass() {
                    if (this.align === 'center') return 'left-1/2 transform -translate-x-1/2';
                    return this.align === 'right' ? 'right-0' : 'left-0';
                },
                arrowAlignClass() {
                    if (this.align === 'center') return 'left-1/2 transform -translate-x-1/2';
                    return this.align === 'right' ? 'right-6' : 'left-6';
                }
            }
        };

        const CalendarTitle = {
            template: '#calendar-title-template',
            components: {
                'notes-icon': NotesIcon // Register NotesIcon here
            },
            props: {
                title: String,
                isEditing: Boolean,
                isReadOnly: Boolean,
                mode: {
                    type: String,
                    default: 'mobile', // 'mobile' or 'desktop'
                    validator: (value) => ['mobile', 'desktop'].includes(value)
                },
                inputRef: {
                    type: String,
                    default: 'titleInput'
                },
                showNotesButton: Boolean, // New prop
                toggleNotes: Function,   // New prop
            },
            emits: ['update:title', 'blur', 'enter', 'click'],
            computed: {
                brandingClass() {
                    return this.mode === 'mobile'
                        ? 'text-base font-bold text-color-2 leading-tight'
                        : 'text-lg font-bold text-color-2 leading-tight';
                },
                taglineClass() {
                    return 'text-color-1 text-xs -mt-0.5 text-[10px]';
                },
                titleClasses() {
                    const base = this.mode === 'mobile'
                        ? 'text-sm font-semibold text-color-2 leading-tight truncate text-center block'
                        : 'font-bold max-w-[150px] md:max-w-xs text-center inline-block leading-tight py-1';

                    const interactive = !this.isReadOnly
                        ? 'cursor-pointer hover:text-blue-500 transition-colors px-1 py-0.5 rounded hover:bg-[var(--bg-interactive-hover)]'
                        : 'px-1';

                    return [base, interactive].filter(Boolean).join(' ');
                },
                inputClass() {
                    return this.mode === 'mobile'
                        ? 'w-full bg-1 border-2 border-blue-500 rounded text-base font-bold focus:outline-none focus:ring-2 focus:ring-blue-300 px-2 py-1 text-color-2 leading-tight text-center'
                        : 'border border-color-default p-1 max-w-[150px] md:max-w-xs h-8';
                }
            },
            methods: {
                handleTitleClick() {
                    if (!this.isReadOnly) {
                        this.$emit('click');
                    }
                },
                // New method for notes button click
                handleToggleNotes() {
                    if (this.toggleNotes) {
                        this.toggleNotes();
                    }
                }
            }
        };

        const NavigationDropdown = {
            template: '#navigation-dropdown-template',
            props: ['recentCalendars'],
            emits: ['go-homepage', 'toggle-pin', 'remove-recent']
        };

        // CopyIcon and SettingsIcon already defined above, no need to redeclare

        const ShareOrClaimUI = {
            template: '#share-or-claim-template',
            components: {
                'custom-tooltip': Tooltip,
                'copy-icon': CopyIcon
            },
            props: {
                calendar: Object,
                isReadOnly: Boolean,
                isExisting: Boolean,
                isLoading: Boolean
            },
            emits: ['toggle-share', 'create', 'update-slug'],
            methods: {
                handleSlugInput(e) {
                    this.$emit('update-slug', e.target.value);
                },
                create() {
                    this.$emit('create');
                },
                toggleShare() {
                    this.$emit('toggle-share');
                },
                copyToClipboard(text, target) {
                    // Reuse the parent's logic or reimplement simply
                    navigator.clipboard.writeText(text).then(() => {
                        // simplified feedback or emit event
                    });
                }
            }
        };

        // ============================================================
        // COMPONENT REGISTRY
        // ============================================================
        // IMPORTANT: All components used in templates must be registered here!
        // If you add a new component, add it to this object.
        // The key is the kebab-case name used in templates (e.g., <calendar-title>)
        // The value is the component object defined above (e.g., CalendarTitle)
        // ============================================================
        const COMPONENT_REGISTRY = {
            'calendar-title': CalendarTitle,           // Mobile & desktop title component
            'navigation-dropdown': NavigationDropdown, // Recent calendars dropdown
            'custom-tooltip': Tooltip,                 // Tooltip wrapper
            'toast-notification': ToastNotification,   // Toast messages
            'copy-icon': CopyIcon,                     // Copy icon SVG
            'settings-icon': SettingsIcon,             // Settings icon SVG
            'help-icon': HelpIcon,                     // Help icon SVG
            'search-icon': SearchIcon,                 // Search icon SVG
            'share-icon': ShareIcon,                   // Share icon SVG
            'notes-icon': NotesIcon,                   // Notes icon SVG
            'chevron-down-icon': ChevronDownIcon,      // Chevron down icon SVG
            'close-icon': CloseIcon,                   // Close icon SVG
            'quick-add-dialog': QuickAddDialog,        // Quick Add Dialog component
            'share-or-claim-ui': ShareOrClaimUI,       // Share or Claim UI
            'star-icon': StarIcon,
            'trash-icon': TrashIcon,
            'dropdown-icon': DropdownIcon,
            'check-icon': CheckIcon,
            'x-icon': XIcon,
            'info-icon': InfoIcon,
            'edit-icon': EditIcon,
            'done-icon': DoneIcon,
            'kebab-icon': KebabIcon,
            'lock-icon': LockIcon,
            'mobile-icon': MobileIcon,
            'switch-icon': SwitchIcon,
            'eye-icon': EyeIcon,
            'link-icon': LinkIcon,
            'device-icon': DeviceIcon,
            'export-icon': ExportIcon
        };

        const CalendarVueApp = {
            components: COMPONENT_REGISTRY,
            directives: {
                'click-outside': clickOutside
            },
            data() {
                let urlslug = window.location.pathname.split("/")[1];

                if (urlslug && urlslug.match(/^[a-zA-Z0-9_\-]+$/) && urlslug.length < 40) {
                    // slug is ok, normalize for consistent lookup
                    urlslug = SlugManager.normalizeSlug(urlslug);
                } else {
                    // should redirect back to homepage if we have a bad url;
                    urlslug = null;
                }

                let id = urlslug ?? Utils.randomID(8);
                let cal = new Calendar(id, "New Calendar", []);

                // Define default colors
                const DEFAULT_COLORS = [
                    "#3f51b5", "#e3165b", "#ff6652", "#4caf50",
                    "#ff9800", "#03a9f4", "#9e9e9e", "#27282f"
                ];

                // COLORS will be updated based on custom colors if available
                let COLORS = [...DEFAULT_COLORS];

                return {
                    isReadOnly: false,
                    isLoading: true, // set to false when calendar status is determined
                    isExisting: false, // set by callback
                    editTitle: false,
                    calendar: cal,
                    recentCalendars: [],
                    syncFusionEvents: [],     // local copy, not synced
                    urlslug: urlslug,
                    debug: false,

                    showRecents: false,
                    hoverTimeout: null,
                    showHelp: false,
                    showNotes: false,
                    isEditingNotes: false,
                    showShare: false,
                    showSearch: false,
                    showSettings: false,


                    currentViewURL: '',
                    updateLinkTimer: null, // re-render share link

                    searchQuery: '',
                    searchResults: [],
                    _pendingViewActivationHandler: null,
                    _pendingViewActivationTimeout: null,

                    // Settings
                    globalSettings: {
                        firstDayOfWeek: '0',
                        timeFormat: '12',
                        defaultView: 'Month',
                        customViewDuration: 3,
                        customViewUnit: 'Months',
                        startHour: '05:00',
                        darkMode: 'auto'
                    },
                    localSettings: {
                        typeLabels: Array(COLORS.length).fill().map((_, i) => `Type ${i + 1}`),
                        colors: [...DEFAULT_COLORS]
                    },

                    // Store COLORS as a component property for consistent reference
                    COLORS: COLORS,
                    DEFAULT_COLORS: DEFAULT_COLORS,
                    colorFilters: COLORS.map(() => true), // allow all color types by default

                    // Store browser locale for display
                    browserLocale: navigator.language || navigator.userLanguage || 'en-US',

                    remoteSettingsApplied: false,

                    // Read-only slug properties
                    showReadOnlySlug: false,
                    readOnlySlugInput: '',

                    // Rename
                    newCalendarId: '',

                    // Creation flow
                    showClaimDialog: false,
                    userHasEditedSlug: false,

                    // Mobile Menu
                    showMobileMenu: false,
                }
            },

            computed: {
                isAutogeneratedId() {
                    const id = this.calendar?.id;
                    if (!id) return false;
                    // Check if ID is exactly 8 characters and contains only chars from the random alphabet (1-9, A-Z excluding I,O)
                    // Regex: ^[1-9a-hj-np-z]+$  (case insensitive)
                    return /^[1-9a-hj-np-z]{8}$/i.test(id);
                },
                hasCustomColors() {
                    return this.COLORS.some((color, index) => color !== this.DEFAULT_COLORS[index]);
                },
                calendarAutoViewLabel() {
                    return 'Month'; // Could be dynamic based on screen size etc.
                },
                calendarCustomViewLabel() {
                    return `${this.calendar.options.customViewDuration || 3} ${this.calendar.options.customViewUnit || 'Months'}`;
                },
                personalCustomViewLabel() {
                    return `${this.globalSettings.customViewDuration} ${this.globalSettings.customViewUnit}`;
                },
                isValidEvent() {
                    // Placeholder if needed for validation logic moved to computed
                    return true;
                },
                displayReadOnlySlug() {
                    if (this.calendar?.options?.publicViewId) return this.calendar.options.publicViewId;
                    // fallback to URL parsing if calendar data isn't fully loaded or populated yet
                    const parts = window.location.pathname.split('/');
                    if (parts[1] === 'view' && parts[2]) return parts[2];
                    return '...';
                },
                // Readable intent-based computed properties
                isNewCalendar() {
                    // User is on homepage creating a new calendar
                    const result = !this.isExisting && !this.isReadOnly;
                    console.log('[isNewCalendar]', result, '| isExisting:', this.isExisting, '| isReadOnly:', this.isReadOnly);
                    return result;
                },
                hasCalendar() {
                    // User is viewing any calendar (owned or read-only)
                    return this.isExisting || this.isReadOnly;
                }
            },

            mounted() {
                // Global keydown listener for shortcuts
                document.addEventListener('keydown', (e) => {
                    if (e.key === 'Escape') {
                        this.closeAllPanels();
                    }
                });

                // Initialize recents
                this.recentManager = new RecentCalendars();
                this.recentCalendars = this.recentManager.getAll();

                // Ensure calendar.options has proper defaults
                this.ensureCalendarOptionsDefaults();

                // Initialize local settings
                this.initializeLocalSettings();
                // We'll load and apply global settings after scheduleObj is initialized

                // readonly: pastecal.com/view/ID
                let path = location.pathname;
                if (path?.startsWith('/view/')) {
                    // Read-only view mode
                    const requestedSlug = path.split('/')[2];
                    this.isReadOnly = true;

                    // Always use lookupCalendar for consistent case-insensitive handling
                    (async () => {
                        try {
                            console.log('Looking up calendar for /view/ route:', requestedSlug);
                            const lookupCalendar = firebase.functions().httpsCallable('lookupCalendar');
                            const result = await lookupCalendar({ slug: requestedSlug });

                            if (result.data.found && result.data.isReadOnly) {
                                // Found as read-only - subscribe with the actual slug
                                const actualSlug = result.data.actualSlug;
                                console.log('Found read-only calendar with slug:', actualSlug);

                                CalendarDataService.subscribe_readonly(actualSlug, (c) => {
                                    this.calendar.import(c);
                                    this.ensureCalendarOptionsDefaults();
                                    // Update custom view in schedule with calendar's settings
                                    this.updateCustomViewInSchedule();
                                    // Re-initialize local settings to load custom colors and labels
                                    this.initializeLocalSettings();
                                    // Add to recents when calendar loads, but mark as read-only
                                    if (c.title) {
                                        this.recentManager.add(actualSlug, `${c.title} (View Only)`, true);
                                        this.recentCalendars = this.recentManager.getAll();
                                    }

                                    if (!this.remoteSettingsApplied) {
                                        this.applyGlobalSettingsAfterRemote();
                                        this.remoteSettingsApplied = true;
                                    }
                                    this.isLoading = false;
                                });
                            } else if (result.data.found && !result.data.isReadOnly) {
                                // Found as editable calendar - show message
                                this.isLoading = false;
                                alert('This calendar exists but is not shared for viewing. Ask the owner to create a read-only link.');
                            } else {
                                // Calendar doesn't exist at all
                                this.isLoading = false;
                                alert('Calendar not found. Please check the URL and try again.');
                            }
                        } catch (error) {
                            console.error('Calendar lookup failed:', error);
                            this.isLoading = false;
                            alert('Failed to load calendar. Please try again later.');
                        }
                    })();
                } else if (this.urlslug) {
                    // default: pastecal.com/ID
                    CalendarDataService.findAndSubscribe(this.urlslug, (c) => {
                        console.log('[DEBUG] findAndSubscribe callback triggered', c);
                        if (c) {
                            // Calendar found
                            console.log('[CalendarDataService] Calendar loaded from Firebase', c);
                            this.isExisting = true;
                            this.calendar.import(c);
                            console.log('[DEBUG] Calendar after import:', this.calendar);

                            console.log('[CalendarDataService] Calendar imported, defaultView:', this.calendar?.options?.defaultView);
                            this.ensureCalendarOptionsDefaults();
                            // Update custom view in schedule with calendar's settings
                            this.updateCustomViewInSchedule();
                            // Re-initialize local settings to load custom colors and labels
                            this.initializeLocalSettings();
                            // Add to recents when calendar loads
                            this.recentManager.add(this.calendar.id, this.calendar.title);
                            this.recentCalendars = this.recentManager.getAll();

                            if (!this.remoteSettingsApplied) {
                                this.applyGlobalSettingsAfterRemote();
                                this.remoteSettingsApplied = true;
                            }

                            // Force update in case watcher doesn't trigger
                            this.updateCalendarView();
                        } else {
                            // Calendar doesn't exist
                            this.isExisting = false;
                        }
                        this.isLoading = false;
                    });
                } else {
                    // homepage - no remote calendar to load
                    this.isExisting = false;
                    this.calendar.id = Utils.randomID(8);
                    this.isLoading = false;
                }

                const scheduleObj = window.scheduleObj = new ej.schedule.Schedule();
                const scheduleInitTimestamp = performance.now();
                console.log('[schedule-init] Schedule constructed at', scheduleInitTimestamp.toFixed(1), 'ms');
                scheduleObj.on('actionComplete', (args) => {
                    if (args?.requestType === 'toolBarRendered') {
                        console.log('[schedule-init] toolBarRendered at', (performance.now() - scheduleInitTimestamp).toFixed(1), 'ms since init');
                    }
                });
                scheduleObj.addEventListener('dataBound', () => {
                    console.log('[schedule-init] dataBound at', (performance.now() - scheduleInitTimestamp).toFixed(1), 'ms since init');
                });
                scheduleObj.on('eventsLoaded', () => {
                    console.log('[schedule-init] eventsLoaded at', (performance.now() - scheduleInitTimestamp).toFixed(1), 'ms since init');
                });

                scheduleObj.startHour = "05:00";

                // Build custom view configuration dynamically
                const customViewDuration = this.calendar?.options?.customViewDuration || this.globalSettings.customViewDuration;
                const customViewUnit = this.calendar?.options?.customViewUnit || this.globalSettings.customViewUnit;
                const customViewConfig = this.buildCustomViewConfig(customViewDuration, customViewUnit);

                scheduleObj.views = [
                    'Day',
                    'Week',
                    'Month',
                    customViewConfig,
                    'Year',
                    'Agenda'
                ];
                scheduleObj.enableAdaptiveUI = false;

                scheduleObj.readonly = this.isReadOnly;


                // Set up scheduler first, then apply settings after initialization
                // set params from URL
                let sanitizedUrl = Utils.sanitizeUrl(window.location.href.toLowerCase());
                let url = new URL(sanitizedUrl);
                let date_param = url.searchParams.get("d") || url.searchParams.get("date");
                let view_param = url.searchParams.get("v") || url.searchParams.get("view");

                let d;
                if (d = Utils.parseDate(date_param)) {
                    scheduleObj.selectedDate = d;
                }

                if (view_param) {
                    switch (view_param.toLowerCase()) {
                        case "d":
                        case "day":
                            scheduleObj.currentView = "Day"; break;
                        case "w":
                        case "week":
                            scheduleObj.currentView = "Week"; break;
                        case "12w":
                        case "12weeks":
                            // Map to custom 12 weeks view
                            const twelveWeeksView = this.buildCustomViewConfig(12, 'Weeks');
                            const twelveWeeksIndex = scheduleObj.views.findIndex(v =>
                                typeof v === 'object' && (v === customViewConfig)
                            );
                            if (twelveWeeksIndex !== -1) {
                                scheduleObj.views[twelveWeeksIndex] = twelveWeeksView;
                            }
                            scheduleObj.currentView = twelveWeeksView.displayName;
                            break;
                        case "m":
                        case "month":
                            scheduleObj.currentView = "Month"; break;
                        case "c":
                        case "custom":
                            // Check for URL parameter overrides for custom view
                            const durParam = url.searchParams.get("dur") || url.searchParams.get("duration");
                            const unitParam = url.searchParams.get("unit");

                            let customViewToUse = customViewConfig;

                            if (durParam && unitParam) {
                                // Temporarily override custom view config from URL
                                const duration = parseInt(durParam);
                                const unit = unitParam.charAt(0).toUpperCase() + unitParam.slice(1).toLowerCase();

                                if (this.validateCustomView(duration, unit)) {
                                    // Rebuild the custom view with URL parameters
                                    customViewToUse = this.buildCustomViewConfig(duration, unit);
                                    // Replace the custom view in the views array
                                    const customViewIndex = scheduleObj.views.findIndex(v =>
                                        typeof v === 'object' && (v === customViewConfig)
                                    );
                                    if (customViewIndex !== -1) {
                                        scheduleObj.views[customViewIndex] = customViewToUse;
                                    }
                                }
                            }

                            // Set currentView to the display name
                            scheduleObj.currentView = customViewToUse.displayName;
                            break;
                        case "q":
                        case "quarter":
                            // Map to custom 3 months view
                            const quarterView = this.buildCustomViewConfig(3, 'Months');
                            const quarterIndex = scheduleObj.views.findIndex(v =>
                                typeof v === 'object' && (v === customViewConfig)
                            );
                            if (quarterIndex !== -1) {
                                scheduleObj.views[quarterIndex] = quarterView;
                            }
                            scheduleObj.currentView = quarterView.displayName;
                            break;
                        case "y":
                        case "year":
                            scheduleObj.currentView = "Year"; break;
                        case "a":
                        case "agenda":
                            scheduleObj.currentView = "Agenda"; break;
                        default:
                            break;
                    }
                }

                // disable drag and drop / resizing for touch devices
                let touchDevice = ('ontouchstart' in document.documentElement);
                scheduleObj.allowDragAndDrop = !touchDevice;
                scheduleObj.allowResizing = !touchDevice;

                // live binding to events
                scheduleObj.eventSettings.dataSource = this.syncFusionEvents;
                scheduleObj.actionComplete = (ev) => {
                    switch (ev.requestType) {
                        case 'eventChanged':
                        case 'eventCreated':
                        case 'eventRemoved':
                            console.log("[app] actionComplete()", "event", ev);
                            console.log(` - syncFusionEvents ${this.syncFusionEvents.length}`, this.syncFusionEvents);
                            console.log(` - eventsData ${scheduleObj.eventsData.length}`, scheduleObj.eventsData);
                            // Use eventsData as the source of truth since DataManager might not update syncFusionEvents in place
                            this.calendar.setEvents(scheduleObj.eventsData);
                            break;
                    }
                    // console.log(ev);
                };

                // color events based on type
                scheduleObj.eventRendered = (args) => {
                    // change color as needed
                    categoryColor = app.COLORS[args.data.Type - 1] || app.COLORS[0];
                    if (scheduleObj.currentView === 'Agenda') {
                        args.element.firstChild.style.borderLeftColor = categoryColor;
                    } else {
                        args.element.style.backgroundColor = categoryColor;
                    }
                }

                // custom display for types
                scheduleObj.popupOpen = (args) => {

                    if (args.type === 'Editor') {
                        // console.log("Editor call");

                        // Configure datetime pickers with strictMode to prevent invalid date/time entries
                        const startElement = args.element.querySelector('[name="StartTime"]');
                        const endElement = args.element.querySelector('[name="EndTime"]');

                        if (startElement && startElement.ej2_instances && startElement.ej2_instances[0]) {
                            const startPicker = startElement.ej2_instances[0];
                            startPicker.strictMode = true;
                        }

                        if (endElement && endElement.ej2_instances && endElement.ej2_instances[0]) {
                            const endPicker = endElement.ej2_instances[0];
                            endPicker.strictMode = true;
                        }

                        function setColor(id) {
                            if (!window.btnObj) {
                                return;
                            }

                            window.btnObj.element.style.background = app.COLORS[id - 1];
                            window.inputEle.setAttribute('value', id);

                            // Explicitly set the Type on the event data object
                            args.data.Type = parseInt(id);
                            // console.log("Color set to:", id, "for event:", args.data);
                        }

                        // Initial setup
                        if (!args.element.querySelector('.custom-field-row-color')) {

                            // console.log("Initial args", args);

                            // button dropdown
                            // TODO: allow live edit (vs reload for types)
                            let items = app.getTypes();

                            window.btnObj = new ej.splitbuttons.DropDownButton({
                                items: items,
                                iconCss: 'e-type',
                                select: (button_args) => {
                                    // console.log("select type args", button_args);
                                    let type = button_args.item.value;
                                    inputEle.value = type;
                                    args.data.Type = type;
                                    setColor(type);
                                },
                                open: () => {
                                    app.dropdownOpen = true;
                                    updateTooltipVisibility();
                                },
                                close: () => {
                                    app.dropdownOpen = false;
                                    updateTooltipVisibility();
                                }
                            });

                            var createElement = ej.base.createElement;
                            let row = createElement('div', { className: 'custom-field-row-color group' });
                            let formElement = args.element.querySelector('.e-schedule-form');
                            formElement.firstChild.insertBefore(row, args.element.querySelector('.e-description-row'));
                            let container = createElement('div', { className: 'custom-field-container', attrs: { name: 'Type' } });

                            window.inputEle = createElement('input', {
                                className: 'e-type e-field', attrs: { name: 'Type' }
                            });
                            container.appendChild(window.inputEle);
                            row.appendChild(container);

                            btnObj.appendTo(container);
                            window.inputEle.setAttribute('name', 'Type');
                            window.inputEle.style.display = "none";
                            window.inputEle.setAttribute('value', args.data.Type);

                            // Add tooltip for customizing labels (shown in dropdown when opened)
                            let tooltip = createElement('div', {
                                id: 'type-label-hint',
                                className: 'w-full px-4 py-2 text-xs text-center italic hidden flex items-center justify-center gap-1',
                                innerHTML: `Customize labels in ${getSettingsIconSVG('w-3 h-3')} Settings`
                            });
                            tooltip.style.background = 'var(--panel-bg)';
                            tooltip.style.color = 'var(--text-color-1)';
                            tooltip.style.borderTop = '1px solid var(--border-color)';
                            // Will be appended to dropdown after it's rendered
                            window.typeTooltip = tooltip;
                        }

                        // Function to update tooltip visibility based on dropdown state
                        window.updateTooltipVisibility = () => {
                            const isDefaultLabels = app.localSettings.typeLabels.every((label, i) => label === `Type ${i + 1}`);
                            const shouldShow = app.dropdownOpen && isDefaultLabels && window.innerWidth >= 768;

                            if (window.typeTooltip) {
                                // Append tooltip to dropdown popup if not already there
                                if (app.dropdownOpen && !window.typeTooltip.parentElement) {
                                    const dropdownPopup = document.querySelector('.e-dropdown-popup.e-popup-open ul');
                                    if (dropdownPopup) {
                                        dropdownPopup.parentElement.appendChild(window.typeTooltip);
                                    }
                                }

                                window.typeTooltip.classList.toggle('hidden', !shouldShow);
                            }
                        };

                        // Initialize dropdown state
                        app.dropdownOpen = false;
                        updateTooltipVisibility();

                        // Initialize with existing type or default to Type 1
                        const initialType = args.data.Type || 1;
                        setColor(initialType);

                        // Make sure the event has a Type property even if not selected
                        if (!args.data.Type) {
                            args.data.Type = 1; // Default to first type if not set
                        }

                        //setColor(args.data.Type);
                    }
                }

                scheduleObj.appendTo('#Schedule');

                // Add event listener to mark month-start dates
                scheduleObj.dataBound = function () {
                    // Find all date headers and mark ones with month names (contain space)
                    const dateHeaders = document.querySelectorAll('.e-schedule .e-month-view .e-date-header.e-navigate');
                    dateHeaders.forEach(header => {
                        const text = header.textContent.trim();
                        // If the text contains a space, it's a month-start date like "Jul 1", "Aug 1"
                        if (text.includes(' ')) {
                            header.classList.add('month-start');
                        } else {
                            header.classList.remove('month-start');
                        }
                    });
                };

                // Load and apply global settings after scheduleObj is fully initialized
                this.loadGlobalSettings();
                // Only apply settings immediately for homepage; remote calendars will apply after data loads
                if (!this.urlslug) {
                    this.applyGlobalSettings();
                }
                this.applyTheme();

                // Apply custom colors CSS if any
                this.updateColorCSS();

                // extended hours button
                document.addEventListener('click', (e) => {
                    if (e.target.className == "e-header-cells e-disable-dates") {
                        if (!this.calendar.options) this.calendar.options = {};
                        this.calendar.options.extended = !this.calendar?.options?.extended;
                    }
                });

                // populate sample data for new calendars on homepage
                if (this.isHomepageCalendar && this.calendar.events.length == 0) {
                    // Load homepage data from localStorage
                    this.loadLocalStorage();

                    // If still no events after loading, create default sample event
                    if (this.calendar.events.length == 0) {
                        var defaultEvent = this.calendar.defaultEvent("Sample event");
                        this.calendar.setEvents([defaultEvent]);
                    }
                    this.updateCalendarView();
                }
            },

            watch: {
                showShare(newValue) {
                    if (newValue) {
                        this.updateCurrentViewURL();
                        this.startUpdateLinkTimer();
                    } else {
                        this.stopUpdateLinkTimer();
                    }
                },

                editTitle(newValue) {
                    // Auto-focus the title input when entering edit mode
                    if (newValue) {
                        this.$nextTick(() => {
                            if (this.$refs.mobileTitleInput) {
                                this.$refs.mobileTitleInput.focus();
                                this.$refs.mobileTitleInput.select();
                            }
                        });
                    }
                },

                calendar: {
                    // sync changes to local storage or firebase
                    handler: function (newVal, oldVal) {
                        // console.log("Vue:watch:calendar", newVal, oldVal);

                        if (!this.isExisting) {
                            this.saveLocalStorage();
                        } else {
                            // because calendar.options.notes may be noisy
                            CalendarDataService.debounce_sync(this.calendar);
                        }
                        this.updateCalendarView();
                    },
                    deep: true
                },
                'calendar.options.extended'(val) {
                    // No need to call CalendarDataService.sync here as the calendar watcher will handle that
                    console.log("calendar.options.extended changed", val);
                    // Apply extended hour setting immediately
                    if (window.scheduleObj) {
                        scheduleObj.startHour = val ? "00:00" : this.globalSettings.startHour;
                    }
                },

                // Initialize custom view defaults when Custom is selected
                'globalSettings.defaultView'(newVal) {
                    if (newVal === 'Custom') {
                        if (this.globalSettings.customViewDuration === undefined) {
                            this.globalSettings.customViewDuration = 3;
                        }
                        if (this.globalSettings.customViewUnit === undefined) {
                            this.globalSettings.customViewUnit = 'Months';
                        }
                    }
                },

                'calendar.options.defaultView'(newVal) {
                    if (newVal === 'Custom') {
                        const hasOptions = !!this.calendar.options;
                        const existingOptions = hasOptions ? this.calendar.options : {};
                        const normalizedOptions = { ...existingOptions };
                        let shouldReplace = !hasOptions;

                        if (!('customViewDuration' in normalizedOptions) || normalizedOptions.customViewDuration === undefined) {
                            normalizedOptions.customViewDuration = this.globalSettings.customViewDuration ?? 3;
                            shouldReplace = true;
                        }
                        if (!('customViewUnit' in normalizedOptions) || normalizedOptions.customViewUnit === undefined) {
                            normalizedOptions.customViewUnit = this.globalSettings.customViewUnit ?? 'Months';
                            shouldReplace = true;
                        }

                        if (shouldReplace) {
                            this.calendar.options = normalizedOptions;
                        }
                    }
                },

                colorFilters: {
                    handler() { this.updateCalendarView(); },
                    deep: true
                },

                // Watch for changes to custom view settings and update schedule
                'globalSettings.customViewDuration'(newVal, oldVal) {
                    if (oldVal !== undefined && newVal !== oldVal) {
                        this.updateCustomViewInSchedule(true);
                    }
                },
                'globalSettings.customViewUnit'(newVal, oldVal) {
                    if (oldVal !== undefined && newVal !== oldVal) {
                        this.updateCustomViewInSchedule(true);
                    }
                },
                'calendar.options.customViewDuration'(newVal, oldVal) {
                    if (oldVal !== undefined && newVal !== oldVal) {
                        this.updateCustomViewInSchedule(true);
                    }
                },
                'calendar.options.customViewUnit'(newVal, oldVal) {
                    if (oldVal !== undefined && newVal !== oldVal) {
                        this.updateCustomViewInSchedule(true);
                    }
                }
            },

            computed: {
                hasCustomColors() {
                    return this.localSettings.colors.some((color, index) => color !== this.DEFAULT_COLORS[index]);
                },
                isHomepageCalendar() {
                    // Homepage calendar has no URL slug and is not an existing saved calendar
                    return !this.urlslug && !this.isExisting;
                },
                // Label for Auto option in calendar settings - viewer's default
                calendarAutoViewLabel() {
                    return "Viewer's Default";
                },
                // Label for Custom option in personal settings showing current config
                personalCustomViewLabel() {
                    const duration = this.globalSettings.customViewDuration || 3;
                    const unit = this.globalSettings.customViewUnit || 'Months';
                    const unitLabel = duration === 1 ? unit.slice(0, -1) : unit;
                    return `${duration} ${unitLabel}`;
                },
                // Label for Custom option in calendar settings showing current config
                calendarCustomViewLabel() {
                    const duration = this.calendar?.options?.customViewDuration || this.globalSettings.customViewDuration || 3;
                    const unit = this.calendar?.options?.customViewUnit || this.globalSettings.customViewUnit || 'Months';
                    const unitLabel = duration === 1 ? unit.slice(0, -1) : unit;
                    return `${duration} ${unitLabel}`;
                }
            },

            methods: {
                // ============================================================
                // REGION: Calendar Initialization & Setup
                // ============================================================

                // Ensure calendar.options has proper default values
                ensureCalendarOptionsDefaults() {
                    const hasOptions = !!this.calendar.options;
                    const existingOptions = hasOptions ? this.calendar.options : {};
                    const normalizedOptions = { ...existingOptions };
                    let shouldReplace = !hasOptions;

                    // Ensure defaultView is null (not undefined) for proper dropdown binding
                    if (!Object.prototype.hasOwnProperty.call(normalizedOptions, 'defaultView')) {
                        normalizedOptions.defaultView = null;
                        shouldReplace = true;
                    }
                    if (!Object.prototype.hasOwnProperty.call(normalizedOptions, 'customViewDuration') ||
                        normalizedOptions.customViewDuration === undefined) {
                        const fallbackDuration = this.globalSettings.customViewDuration ?? 3;
                        normalizedOptions.customViewDuration = fallbackDuration;
                        shouldReplace = true;
                    }
                    if (!Object.prototype.hasOwnProperty.call(normalizedOptions, 'customViewUnit') ||
                        normalizedOptions.customViewUnit === undefined) {
                        const fallbackUnit = this.globalSettings.customViewUnit ?? 'Months';
                        normalizedOptions.customViewUnit = fallbackUnit;
                        shouldReplace = true;
                    }

                    if (shouldReplace) {
                        this.calendar.options = normalizedOptions;
                    }
                },

                // ============================================================
                // REGION: View Management & Calendar Display
                // ============================================================

                // Apply default view to schedule (if no URL override)
                applyDefaultView() {
                    if (!window.location.search.includes('view=') && !window.location.search.includes('v=')) {
                        const defaultView = this.calendar?.options?.defaultView || this.globalSettings.defaultView || 'Month';
                        const actualViewName = this.getActualViewName(defaultView);

                        const viewIndex = scheduleObj.views.findIndex(v => {
                            if (typeof v === 'string') {
                                return v === actualViewName;
                            } else if (typeof v === 'object' && v.displayName) {
                                return v.displayName === actualViewName;
                            }
                            return false;
                        });

                        if (viewIndex === -1) {
                            console.warn('[applyDefaultView] View not found in schedule:', actualViewName);
                            return;
                        }

                        const activateViewIfReady = () => {
                            const viewButtons = document.querySelectorAll('.e-toolbar-item.e-views button');
                            const targetButton = viewButtons[viewIndex];
                            if (!targetButton) {
                                return false;
                            }
                            const buttonLabel = (targetButton.getAttribute('aria-label') || targetButton.textContent || '').trim();
                            if (buttonLabel && buttonLabel.toLowerCase().includes(actualViewName.toLowerCase())) {
                                targetButton.click();
                                return true;
                            }
                            return false;
                        };

                        if (activateViewIfReady()) {
                            return;
                        }

                        if (this._pendingViewActivationHandler) {
                            scheduleObj.removeEventListener('dataBound', this._pendingViewActivationHandler);
                            this._pendingViewActivationHandler = null;
                        }
                        if (this._pendingViewActivationTimeout) {
                            clearTimeout(this._pendingViewActivationTimeout);
                            this._pendingViewActivationTimeout = null;
                        }

                        const dataBoundHandler = () => {
                            if (activateViewIfReady()) {
                                scheduleObj.removeEventListener('dataBound', dataBoundHandler);
                                this._pendingViewActivationHandler = null;
                                if (this._pendingViewActivationTimeout) {
                                    clearTimeout(this._pendingViewActivationTimeout);
                                    this._pendingViewActivationTimeout = null;
                                }
                            }
                        };

                        this._pendingViewActivationHandler = dataBoundHandler;
                        scheduleObj.addEventListener('dataBound', dataBoundHandler);

                        this._pendingViewActivationTimeout = setTimeout(() => {
                            scheduleObj.removeEventListener('dataBound', dataBoundHandler);
                            this._pendingViewActivationHandler = null;
                            this._pendingViewActivationTimeout = null;
                            if (!activateViewIfReady()) {
                                console.error('[applyDefaultView] Unable to activate view after waiting for dataBound events:', actualViewName);
                            }
                        }, 10000);
                    }
                },

                // Apply theme based on user preference and system settings
                applyTheme() {
                    let isDark = false;

                    if (this.globalSettings.darkMode === 'auto') {
                        // Use system preference
                        isDark = window.matchMedia && window.matchMedia('(prefers-color-scheme: dark)').matches;
                    } else {
                        // Use explicit user preference
                        isDark = this.globalSettings.darkMode === 'dark';
                    }

                    document.documentElement.setAttribute('data-theme', isDark ? 'dark' : 'light');
                    this.swapSyncfusionTheme(isDark);
                },
                swapSyncfusionTheme(dark) {
                    document.getElementById('syncfusion-base-theme').href = dark
                        ? 'https://cdn.syncfusion.com/ej2/ej2-base/styles/material-dark.css'
                        : 'https://cdn.syncfusion.com/ej2/ej2-base/styles/material.css';
                    document.getElementById('syncfusion-theme').href = dark
                        ? 'https://cdn.syncfusion.com/ej2/material-dark.css'
                        : 'https://cdn.syncfusion.com/ej2/material.css';
                    document.getElementById('syncfusion-schedule-theme').href = dark
                        ? 'https://cdn.syncfusion.com/ej2/ej2-schedule/styles/material-dark.css'
                        : 'https://cdn.syncfusion.com/ej2/ej2-schedule/styles/material.css';
                },

                // Validate custom view configuration
                validateCustomView(duration, unit) {
                    const maxWeeks = 52;
                    const maxMonths = 24;

                    if (unit === 'Weeks') {
                        return duration >= 1 && duration <= maxWeeks;
                    } else if (unit === 'Months') {
                        return duration >= 1 && duration <= maxMonths;
                    }
                    return false;
                },

                // Build custom view configuration for Syncfusion
                buildCustomViewConfig(duration, unit) {
                    // Validate inputs
                    if (!this.validateCustomView(duration, unit)) {
                        console.warn('Invalid custom view configuration, using defaults');
                        duration = 3;
                        unit = 'Months';
                    }

                    // Build dynamic display name
                    const unitLabel = duration === 1 ? unit.slice(0, -1) : unit; // Singular/plural
                    const displayName = `${duration} ${unitLabel}`;

                    // Standard interval view
                    const baseOption = unit === 'Weeks' ? 'Week' : 'Month';
                    return {
                        option: baseOption,
                        displayName: displayName,
                        interval: duration
                    };
                },

                // Update the custom view in the schedule when duration/unit changes
                updateCustomViewInSchedule(shouldRefresh = false) {
                    if (!window.scheduleObj || !window.scheduleObj.views) {
                        return;
                    }

                    // Get the current custom view configuration
                    const customViewDuration = this.calendar?.options?.customViewDuration || this.globalSettings.customViewDuration;
                    const customViewUnit = this.calendar?.options?.customViewUnit || this.globalSettings.customViewUnit;
                    const newCustomViewConfig = this.buildCustomViewConfig(customViewDuration, customViewUnit);

                    // Find the custom view index (it's the object with interval property)
                    const customViewIndex = scheduleObj.views.findIndex(v =>
                        typeof v === 'object' && v.interval !== undefined
                    );

                    if (customViewIndex !== -1) {
                        const oldDisplayName = scheduleObj.views[customViewIndex].displayName;
                        const currentView = scheduleObj.currentView;

                        // Replace the custom view
                        scheduleObj.views[customViewIndex] = newCustomViewConfig;

                        // If we're currently viewing the custom view, update the currentView
                        if (currentView === oldDisplayName) {
                            scheduleObj.currentView = newCustomViewConfig.displayName;
                        }

                        // Refresh the schedule to update the header (only if user actively changed settings)
                        if (shouldRefresh) {
                            scheduleObj.refresh();
                        }
                    } else {
                    }
                },

                // Get the actual Syncfusion view name for a given default view setting
                // Converts "Custom" to the actual display name like "3 Months"
                getActualViewName(viewSetting) {
                    // Handle null/undefined viewSetting - default to Month
                    if (!viewSetting) {
                        return 'Month';
                    }

                    if (viewSetting !== 'Custom') {
                        return viewSetting;
                    }

                    // For Custom view, we need to find the custom view in the scheduleObj.views array
                    if (typeof window.scheduleObj !== 'undefined' && window.scheduleObj && window.scheduleObj.views) {
                        // Find the custom view (it's the one with interval property and not a string)
                        const customView = window.scheduleObj.views.find(v =>
                            typeof v === 'object' && v.interval !== undefined && v.displayName
                        );
                        if (customView) {
                            return customView.displayName;
                        }
                    }

                    // Fallback: compute it from settings
                    const duration = this.calendar?.options?.customViewDuration || this.globalSettings.customViewDuration || 3;
                    const unit = this.calendar?.options?.customViewUnit || this.globalSettings.customViewUnit || 'Months';
                    const unitLabel = duration === 1 ? unit.slice(0, -1) : unit;
                    return `${duration} ${unitLabel}`;
                },

                clearLocalStorage() {
                    localStorage.removeItem("calendar");
                },

                resetToDefaults() {
                    // Reset to a completely fresh calendar state
                    this.calendar.id = Utils.randomID(8);
                    this.calendar.title = "New Calendar";
                    this.calendar.events = [];
                    this.calendar.options = {
                        notes: '',
                        defaultView: 'week'
                    };
                    // Add one sample event
                    var defaultEvent = this.calendar.defaultEvent("Sample event");
                    this.calendar.setEvents([defaultEvent]);
                    // Reset local settings to defaults
                    this.initializeLocalSettings();
                },

                loadLocalStorage() {
                    var c = JSON.parse(localStorage.getItem("calendar"));
                    if (c) {
                        // Load ALL draft data from localStorage (ID, title, events, settings, colors, notes, etc.)
                        this.calendar.import(c);
                        // Re-initialize local settings to load custom colors and labels
                        this.initializeLocalSettings();
                    } else {
                        // No localStorage data (fresh start after save, or first visit)
                        this.resetToDefaults();
                    }
                },

                saveLocalStorage() {
                    // Only save to localStorage when on homepage
                    // Named calendars should never overwrite homepage data
                    if (this.isHomepageCalendar) {
                        localStorage.setItem("calendar", JSON.stringify(this.calendar));
                    }
                },

                updateCalendarView() {
                    // Step 1: Ensure this.syncFusionEvents is up-to-date from the master store (this.calendar.events).
                    // This creates a new array instance for this.syncFusionEvents if this.calendar.events has changed.
                    this.syncFusionEvents = this.calendar.getSyncFusionEvents();

                    // Step 2: Create a DataManager with the current, complete set of events.
                    const eventDataManager = new ej.data.DataManager(this.syncFusionEvents);

                    // Step 3: Prepare the query based on current filters.
                    let query = this.getFilteredEventsQuery();

                    // Step 4: Update the Scheduler's eventSettings with the new DataManager and Query.
                    // This tells the Scheduler to use the 'eventDataManager' as its source and apply the 'query'.
                    scheduleObj.setProperties({
                        eventSettings: {
                            dataSource: eventDataManager,
                            query: query
                        }
                    });

                    // Step 5: Re-bind the data to ensure the Scheduler reflects the changes.
                    // While setProperties might sometimes trigger a refresh, explicitly calling dataBind is safer
                    // when dataSource or query changes significantly.
                    scheduleObj.dataBind();
                },

                // ============================================================
                // REGION: Calendar CRUD Operations
                // ============================================================

                create() {
                    // If user hasn't manually edited the slug, show intervention dialog
                    if (!this.userHasEditedSlug) {
                        this.showClaimDialog = true;
                        // Focus input in dialog on next tick
                        this.$nextTick(() => {
                            if (this.$refs.claimInput) {
                                this.$refs.claimInput.focus();
                                this.$refs.claimInput.select();
                            }
                        });
                        return;
                    }

                    this.confirmClaim();
                },

                confirmClaim() {
                    if (this.calendar.id) {
                        // Proceed with creation
                        this.create();
                        this.showClaimDialog = false;
                    }
                },

                create() {
                    let slug = this.calendar.id;
                    if (!slug) {
                        slug = Utils.randomID(8);
                        this.calendar.id = slug;
                    }

                    // normalize
                    slug = SlugManager.normalizeSlug(slug);
                    this.calendar.id = slug;

                    // check for existing
                    CalendarDataService.checkExists(slug, () => {
                        // Revert to alert for this validation as per user request
                        alert("This URL is already taken. Please choose another.");
                    }, () => {
                        // does not exist, proceed
                        this.isLoading = true;
                        CalendarDataService.createWithId(slug, this.calendar, () => {
                            // success - clear localStorage so homepage starts fresh next time
                            this.clearLocalStorage();
                            this.showToast('Calendar created!', 'success');
                            window.location.href = "/" + slug;
                        });
                    });
                },

                handleSlugInput() {
                    this.userHasEditedSlug = true;
                },

                randomizeId() {
                    this.calendar.id = Utils.randomID(8);
                    // Reset edited state if they randomize (treat as "auto" again, or maybe not? 
                    // Let's keep it as "not edited" so they get the review dialog if they just clicked shuffle
                    // Actually, if they clicked shuffle, they interacted. 
                    // But let's err on safe side: if they just shuffled but didn't TYPE, show dialog to confirm.
                    this.userHasEditedSlug = false;
                },

                renameCalendar() {
                    if (!this.newCalendarId || !this.newCalendarId.trim()) return;

                    let newId = this.newCalendarId.trim();
                    // basic validation (alphanumeric, hyphens)
                    if (!newId.match(/^[a-zA-Z0-9_\-]+$/)) {
                        alert("Invalid name. Use letters, numbers, dashes, and underscores.");
                        return;
                    }

                    // Check if current name is same as new name
                    if (newId.toLowerCase() === this.calendar.id.toLowerCase()) {
                        alert("New name must be different from current name.");
                        return;
                    }

                    CalendarDataService.checkExists(newId, () => {
                        alert("That name is already taken.");
                    }, () => {
                        // Does not exist, proceed
                        if (confirm(`Move calendar to pastecal.com/${newId}?`)) {
                            // Create copy with new ID
                            let newCalendar = JSON.parse(JSON.stringify(this.calendar));
                            newCalendar.id = newId;
                            newCalendar.title = newCalendar.title || "New Calendar";

                            CalendarDataService.createWithId(newId, newCalendar, () => {
                                // We don't delete the old one (safer, acts as a copy)
                                window.location = "/" + newId;
                            });
                        }
                    });
                },

                setTitle(event) {
                    if (event.target.value.trim()) {
                        this.editTitle = false;
                        this.calendar.title = event.target.value.trim();
                    }
                },

                getTypes() {
                    // First check if we have custom labels in calendar.options.typeLabels
                    if (this.calendar?.options?.typeLabels?.length > 0) {
                        return Array(this.COLORS.length).fill().map((_, i) => {
                            let id = i + 1;
                            let title = this.calendar.options.typeLabels[i] || `Type ${id}`;
                            return { text: title, value: id, iconCss: `e-color-${id}` };
                        });
                    }

                    // Fallback to default labels if no custom labels are found
                    return Array(this.COLORS.length).fill().map((_, i) => {
                        let id = i + 1;
                        return { text: `Type ${id}`, value: id, iconCss: `e-color-${id}` };
                    });
                },

                updateCurrentViewURL() {
                    const currentView = scheduleObj.currentView;
                    const currentDate = scheduleObj.selectedDate.toISOString().slice(0, 10);

                    // Map display name to URL parameter
                    let viewParam;
                    const viewLower = currentView.toLowerCase();

                    // Check if it's a custom view (has a number and unit)
                    const customViewMatch = currentView.match(/^(\d+)\s+(Week|Month)s?$/);
                    if (customViewMatch) {
                        const duration = customViewMatch[1];
                        const unit = customViewMatch[2].toLowerCase() + 's';
                        viewParam = `custom&dur=${duration}&unit=${unit}`;
                    } else {
                        // Standard view - just lowercase it
                        viewParam = viewLower;
                    }

                    this.currentViewURL = `${window.location.origin}/${this.calendar.id}?date=${currentDate}&view=${viewParam}`;
                },

                // ============================================================
                // REGION: URL Generation & Sharing
                // ============================================================

                getEditableURL() {
                    return `${window.location.origin}/${this.calendar.id}`;
                },

                getEditableICSURL() {
                    return `${window.location.origin}/${this.calendar.id}.ics`;
                },

                getReadOnlyICSURL() {
                    // Use SlugManager for centralized read-only link operations
                    return SlugManager.getReadOnlyICSURL(this.calendar);
                },

                createReadOnlyLink() {
                    // Use SlugManager for centralized read-only link operations
                    return SlugManager.createReadOnlyLink(this.calendar);
                },

                customizeExistingLink() {
                    if (!this.readOnlySlugInput.trim()) return;

                    // Use SlugManager for centralized read-only link operations
                    SlugManager.customizeReadOnlyLink(this.calendar, this.readOnlySlugInput.trim())
                        .then(() => {
                            // Clear the input and hide the form
                            this.readOnlySlugInput = '';
                            this.showReadOnlySlug = false;
                        });
                },

                getReadOnlySlug() {
                    // Use SlugManager for centralized read-only link operations
                    return SlugManager.getReadOnlySlug(this.calendar) || '';
                },

                getReadOnlyURL() {
                    // Use SlugManager for centralized read-only link operations
                    return SlugManager.getReadOnlyURL(this.calendar);
                },

                getReadOnlyNotes() {
                    let notes = this.calendar.options?.notes || '';

                    // Escape HTML special characters
                    notes = notes.replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;")
                        .replace(/"/g, "&quot;")
                        .replace(/'/g, "&#039;");

                    // Convert URLs to hyperlinks safely
                    // Match URLs starting with http://, https://, or ftp://
                    notes = notes.replace(/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig,
                        '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');

                    // Match URLs starting with "www." not preceded by '://'
                    notes = notes.replace(/(^|\s)(www\.[\S]+(\b|$))/ig,
                        '$1<a href="http://$2" target="_blank" rel="noopener noreferrer">$2</a>');

                    // Convert line breaks to <br> tags
                    notes = notes.replace(/\n/g, "<br>");

                    // If no notes, display a message
                    if (notes.trim() === '') {
                        return '<span class="text-color-1 italic">No notes yet.</span>';
                    }

                    return notes;
                },

                startUpdateLinkTimer() {
                    this.updateLinkTimer = setInterval(() => {
                        this.updateCurrentViewURL();
                    }, 100);
                },

                stopUpdateLinkTimer() {
                    clearInterval(this.updateLinkTimer);
                },

                copyToClipboard(target) {
                    target.select();
                    document.execCommand('copy');
                },

                // ============================================================
                // REGION: Events & Search Management
                // ============================================================

                searchEvents() {
                    if (this.searchQuery.trim() !== '') {
                        this.searchResults = this.calendar.events.filter(event =>
                            event.title.toLowerCase().includes(this.searchQuery.toLowerCase())
                        );

                        // sort results by newest first
                        this.searchResults.sort((a, b) => new Date(b.start) - new Date(a.start));
                    } else {
                        this.searchResults = [];
                    }
                },

                toggleColorFilter(index) {
                    this.colorFilters[index] = !this.colorFilters[index];
                },

                resetColorFilters() {
                    this.colorFilters = this.colorFilters.map(() => true);
                },

                getFilteredEventsQuery() {
                    let query = new ej.data.Query();

                    if (this.showSearch) {
                        // Apply color filters from this.colorFilters
                        const activeColorTypes = [];
                        for (let i = 0; i < this.colorFilters.length; i++) {
                            if (this.colorFilters[i]) {
                                activeColorTypes.push(i + 1); // Event types are 1-based
                            }
                        }

                        if (activeColorTypes.length > 0 && activeColorTypes.length < this.COLORS.length) {
                            // If some, but not all, colors are selected, build a predicate.
                            let colorPredicate = null;
                            for (const typeId of activeColorTypes) {
                                if (colorPredicate === null) {
                                    colorPredicate = new ej.data.Predicate('Type', 'equal', typeId);
                                } else {
                                    colorPredicate = colorPredicate.or('Type', 'equal', typeId);
                                }
                            }
                            query = query.where(colorPredicate);
                        } else if (activeColorTypes.length === 0 && this.COLORS.length > 0) {
                            // If no colors are selected (and there are colors to select from), filter out all events.
                            // Use a predicate that will never be true. Assuming 'Type' is always positive.
                            query = query.where('Type', 'equal', -1);
                        }
                        // If all colors are selected (activeColorTypes.length === this.COLORS.length),
                        // no 'Type' predicate is added, effectively showing all events (respecting other query parts).
                    }

                    return query;
                },

                getFilteredEvents() {
                    if (!this.showSearch) {
                        return this.syncFusionEvents;
                    }

                    return this.syncFusionEvents;

                    return this.syncFusionEvents.filter(event => {
                        return true;

                        const eventType = parseInt(event.Type || event.type);
                        // If eventType is not a valid number, just keep the event.
                        if (isNaN(eventType)) return true;
                        // If the color filter for the event type is explicitly false, remove it.
                        return this.colorFilters[eventType - 1] === true;
                    });
                },

                jumpToEvent(event) {
                    let startDate = new Date(event.start);
                    scheduleObj.selectedDate = startDate;
                    scheduleObj.currentView = 'Week';
                },

                toggleRecents() {
                    this.showRecents = !this.showRecents;
                },

                closeRecents() {
                    this.showRecents = false;
                },

                handleDropdownMouseEnter() {
                    // Only handle hover on non-touch devices
                    if (!('ontouchstart' in window)) {
                        clearTimeout(this.hoverTimeout);
                        this.showRecents = true;
                    }
                },

                handleDropdownMouseLeave() {
                    // Only handle hover on non-touch devices
                    if (!('ontouchstart' in window)) {
                        this.hoverTimeout = setTimeout(() => {
                            this.showRecents = false;
                        }, 300);
                    }
                },

                goToHomepage() {
                    this.closeRecents();
                    window.location.href = '/';
                },

                // ============================================================
                // REGION: UI State Management (Panels & Toggles)
                // ============================================================

                isPanelOpen() {
                    return this.showNotes || this.showSearch || this.showHelp || this.showShare || this.showSettings;
                },

                toggleHelp() {
                    // If help is already open, close it
                    if (this.showHelp) {
                        this.showHelp = false;
                    } else {
                        // Close all other panels first
                        this.closeAllPanels();
                        // Then open help
                        this.showHelp = true;
                    }
                },

                toggleNotes() {
                    if (this.showNotes) {
                        this.showNotes = false;
                    } else {
                        this.closeAllPanels();
                        this.showNotes = true;

                        // If editable and no notes exist, default to edit mode
                        if (!this.isReadOnly) {
                            const hasNotes = this.calendar.options.notes && this.calendar.options.notes.trim().length > 0;
                            this.isEditingNotes = !hasNotes;
                        } else {
                            this.isEditingNotes = false;
                        }
                    }
                },

                toggleSearch() {
                    if (this.showSearch) {
                        this.showSearch = false;
                        this.resetColorFilters();
                    } else {
                        this.closeAllPanels();
                        this.showSearch = true;
                    }
                },

                toggleShare() {
                    if (this.showShare) {
                        this.showShare = false;
                    } else {
                        this.closeAllPanels();
                        this.showShare = true;
                    }
                },

                closeAllPanels() {
                    if (this.showHelp) {
                        this.toggleHelp();
                    }

                    if (this.showNotes) {
                        this.toggleNotes();
                    }

                    if (this.showSearch) {
                        this.toggleSearch();
                    }

                    if (this.showShare) {
                        this.toggleShare();
                    }

                    if (this.showSettings) {
                        this.toggleSettings();
                    }
                },

                togglePin(id) {
                    this.recentManager.togglePin(id);
                    this.recentCalendars = this.recentManager.getAll();
                },

                removeRecent(id) {
                    this.recentManager.remove(id);
                    this.recentCalendars = this.recentManager.getAll();
                },

                formatDate(dateString) {
                    const options = {
                        weekday: 'short',
                        month: 'short',
                        day: 'numeric',
                        hour: 'numeric',
                        minute: 'numeric',
                        hour12: true
                    };
                    return new Date(dateString).toLocaleString(undefined, options);
                },

                handleQuickAddEvent(event) {
                    const newEvent = new Event({
                        title: event.subject,
                        start: event.startDateTime,
                        end: event.endDateTime
                    });
                    this.calendar.events.push(newEvent);
                    this.calendar.setEvents(this.calendar.events);
                },

                shareUrl(url, title) {
                    if (navigator.share) {
                        navigator.share({
                            title: 'PasteCal Calendar',
                            text: title,
                            url: url
                        }).catch(err => {
                            console.log('Error sharing:', err);
                        });
                    }
                },

                canShare() {
                    return !!navigator.share;
                },

                toggleSettings() {
                    if (this.showSettings) {
                        this.showSettings = false;
                    } else {
                        this.closeAllPanels();
                        this.showSettings = true;

                        // One-time import of type labels from notes when settings panel is opened
                        this.importTypeLabelsFromNotes();
                    }
                },

                // ============================================================
                // REGION: Settings & Preferences Management
                // ============================================================

                // Global Settings methods (device-specific, stored in localStorage)
                loadGlobalSettings() {
                    const settings = JSON.parse(localStorage.getItem('pastecal_global_settings'));
                    if (settings) {
                        this.globalSettings = { ...this.globalSettings, ...settings };

                        // Ensure custom view properties exist for backwards compatibility
                        if (this.globalSettings.customViewDuration === undefined) {
                            this.globalSettings.customViewDuration = 3;
                        }
                        if (this.globalSettings.customViewUnit === undefined) {
                            this.globalSettings.customViewUnit = 'Months';
                        }
                    } else {
                        // Auto-import locale settings if no saved settings exist
                        this.autoImportLocaleSettings();
                    }
                },

                // Auto-import settings from browser locale
                autoImportLocaleSettings() {
                    try {
                        // Get browser locale 
                        const locale = navigator.language || navigator.userLanguage;
                        console.log("Detected locale:", locale);

                        // Detect 12/24 hour format preference from locale
                        const formatter = new Intl.DateTimeFormat(locale, {
                            hour: 'numeric',
                            hour12: undefined // Let the system decide
                        });
                        const timeFormatSample = formatter.format(new Date(2023, 0, 1, 13, 0, 0));
                        // Check if the formatted time contains "AM" or "PM" or their locale equivalents
                        const is12Hour = timeFormatSample.match(/am|pm|a\.m\.|p\.m\.|AM|PM|A\.M\.|P\.M\./i) !== null;
                        this.globalSettings.timeFormat = is12Hour ? '12' : '24';
                        console.log("Detected time format:", is12Hour ? "12-hour" : "24-hour");

                        // Detect first day of week - cross-browser compatible approach
                        let firstDay = 0; // Default to Sunday (0)

                        try {
                            // Try the newer Intl.Locale API first
                            if (typeof Intl !== 'undefined' &&
                                typeof Intl.Locale !== 'undefined' &&
                                typeof Intl.Locale.prototype.getWeekInfo === 'function') {
                                const weekInfo = new Intl.Locale(locale).getWeekInfo();
                                firstDay = weekInfo.firstDay === 7 ? 0 : weekInfo.firstDay; // Convert Sunday (7) to 0
                                console.log("First day detected using Intl.Locale.getWeekInfo");
                            }
                            // Fallback to region-based detection
                            else {
                                // Countries/regions that typically use Monday as first day of week
                                const mondayFirstRegions = ['AD', 'AL', 'AM', 'AT', 'AZ', 'BA', 'BE', 'BG', 'BY', 'CH',
                                    'CZ', 'DE', 'DK', 'EE', 'ES', 'FI', 'FR', 'GB', 'GE', 'GR',
                                    'HR', 'HU', 'IS', 'IT', 'KG', 'KZ', 'LT', 'LU', 'LV', 'MC',
                                    'MD', 'ME', 'MK', 'MT', 'NL', 'NO', 'PL', 'PT', 'RO', 'RS',
                                    'RU', 'SE', 'SI', 'SK', 'SM', 'TJ', 'TM', 'TR', 'UA', 'UZ',
                                    'VA', 'CN', 'HK', 'JP', 'KP', 'KR', 'MO', 'TW'];

                                // Languages that typically use Monday as first day of week
                                const mondayFirstLanguages = ['ar', 'bg', 'ca', 'cs', 'da', 'de', 'el', 'et', 'eu', 'fa',
                                    'fi', 'fr', 'hr', 'hu', 'is', 'it', 'lt', 'lv', 'mk', 'nl',
                                    'pl', 'pt', 'ro', 'ru', 'sk', 'sl', 'sr', 'sv', 'tr', 'uk', 'zh'];

                                // Extract region code and language code
                                let regionCode = '';
                                let languageCode = '';

                                if (locale.includes('-')) {
                                    const parts = locale.split('-');
                                    languageCode = parts[0].toLowerCase();
                                    regionCode = parts[1].toUpperCase();
                                } else {
                                    languageCode = locale.toLowerCase();
                                }

                                // Check region first, then fall back to language
                                if (mondayFirstRegions.includes(regionCode)) {
                                    firstDay = 1; // Monday
                                    console.log("First day detected as Monday based on region:", regionCode);
                                } else if (mondayFirstLanguages.includes(languageCode)) {
                                    firstDay = 1; // Monday
                                    console.log("First day detected as Monday based on language:", languageCode);
                                } else {
                                    console.log("First day defaulting to Sunday (not in Monday lists)");
                                }
                            }
                        } catch (e) {
                            console.warn("Error in first day detection:", e);
                            // Keep the default (Sunday) if there's an error
                        }

                        this.globalSettings.firstDayOfWeek = firstDay.toString();
                        console.log("Detected first day of week:", firstDay === 0 ? "Sunday" : "Monday");

                        // Add locale detection flag for UI messaging
                        this.globalSettings.autoDetectedFromLocale = true;

                        // Save the imported settings
                        this.saveGlobalSettings();
                    } catch (error) {
                        console.error("Error auto-importing locale settings:", error);
                        // Fallback to defaults if import fails
                    }
                },

                saveGlobalSettings() {
                    try {
                        localStorage.setItem('pastecal_global_settings', JSON.stringify(this.globalSettings));
                        console.log('Global settings saved to localStorage');
                    } catch (error) {
                        console.warn('Failed to save settings to localStorage:', error);
                        // Notify user if in private mode
                        if (error.name === 'QuotaExceededError' ||
                            error.name === 'NS_ERROR_DOM_QUOTA_REACHED' ||
                            error.code === 22) {
                            console.warn('Browser may be in private browsing mode');
                        } else {
                            console.warn('Unable to save settings', error);
                        }
                    }
                    this.applyGlobalSettings();
                    this.applyTheme();
                },

                // settings which are stored in the remote calendar object
                applyGlobalSettingsAfterRemote() {
                    if (typeof window.scheduleObj === 'undefined' || !window.scheduleObj) {
                        console.log('[applyGlobalSettingsAfterRemote] Scheduler not initialized yet, skipping settings application');
                        return;
                    }

                    this.applyDefaultView();
                },

                applyGlobalSettings() {
                    console.log('[applyGlobalSettings] Called');
                    if (typeof window.scheduleObj === 'undefined' || !window.scheduleObj) {
                        return;
                    }

                    // console.log("[app] cal data", this.calendar);

                    try {
                        // Apply first day of week
                        scheduleObj.firstDayOfWeek = parseInt(this.globalSettings.firstDayOfWeek);

                        // Apply time format
                        const timeFormat = this.globalSettings.timeFormat === '24' ? 'HH:mm' : 'hh:mm a';
                        scheduleObj.timeFormat = timeFormat;

                        // Apply default view if not already set via URL
                        this.applyDefaultView();

                        // Apply start hour if not overridden by extended setting
                        if (!this.calendar?.options?.extended) {
                            scheduleObj.startHour = this.globalSettings.startHour;
                        }

                        console.log('Global settings applied successfully:', {
                            firstDayOfWeek: scheduleObj.firstDayOfWeek,
                            timeFormat: scheduleObj.timeFormat,
                            currentView: scheduleObj.currentView,
                            startHour: scheduleObj.startHour
                        });
                    } catch (error) {
                        console.error('Error applying global settings:', error);
                        // Try to recover by applying settings individually
                        try {
                            scheduleObj.firstDayOfWeek = parseInt(this.globalSettings.firstDayOfWeek);
                            console.log('Applied first day of week setting');
                        } catch (e) { console.warn('Failed to apply first day of week setting:', e); }

                        try {
                            scheduleObj.timeFormat = this.globalSettings.timeFormat === '24' ? 'HH:mm' : 'hh:mm a';
                            console.log('Applied time format setting');
                        } catch (e) { console.warn('Failed to apply time format setting:', e); }

                        try {
                            this.applyDefaultView();
                            console.log('Applied default view setting');
                        } catch (e) { console.warn('Failed to apply default view setting:', e); }

                        try {
                            if (!this.calendar?.options?.extended) {
                                scheduleObj.startHour = this.globalSettings.startHour;
                                console.log('Applied start hour setting');
                            }
                        } catch (e) { console.warn('Failed to apply start hour setting:', e); }
                    }
                },

                // Calendar-specific Settings methods (stored in calendar.options)
                initializeLocalSettings() {
                    // Ensure we have default type labels
                    const defaultLabels = Array(this.COLORS.length).fill().map((_, i) => `Type ${i + 1}`);

                    if (!this.localSettings.typeLabels || !Array.isArray(this.localSettings.typeLabels)) {
                        this.localSettings.typeLabels = [...defaultLabels];
                    }

                    // If the calendar has typeLabels, use them
                    if (this.calendar?.options?.typeLabels?.length > 0) {
                        this.localSettings.typeLabels = [...this.calendar.options.typeLabels];
                    } else {
                        // Try to import from notes
                        const imported = this.importTypeLabelsFromNotes();
                        if (!imported) {
                            // If import failed or had no labels, use defaults
                            this.localSettings.typeLabels = [...defaultLabels];
                            // Store defaults in calendar.options
                            if (!this.calendar.options) this.calendar.options = {};
                            this.calendar.options.typeLabels = [...defaultLabels];
                        }
                    }

                    // Load custom colors
                    this.loadCustomColors();
                },

                updateTypeLabel(typeId, value) {
                    const index = typeId - 1;
                    if (index >= 0 && index < this.COLORS.length) {
                        // Sanitize input: trim whitespace, limit length to 70 chars, ensure non-empty
                        let sanitizedValue = value.trim().substring(0, 70);
                        if (sanitizedValue === '') {
                            sanitizedValue = `Type ${typeId}`; // Fallback to default if empty
                        }

                        this.localSettings.typeLabels[index] = sanitizedValue;
                        // Store directly in calendar.options and sync
                        this.storeTypeLabelsInCalendarOptions();
                    }
                },

                updateEventColor(index, color) {
                    if (index >= 0 && index < this.COLORS.length) {
                        // Update local settings
                        this.localSettings.colors[index] = color;

                        // Update the component COLORS array
                        this.COLORS[index] = color;

                        // Store in calendar options and sync
                        this.storeColorsInCalendarOptions();

                        // Update CSS dynamically
                        this.updateColorCSS();
                    }
                },

                resetEventColor(index) {
                    if (index >= 0 && index < this.COLORS.length) {
                        this.localSettings.colors[index] = this.DEFAULT_COLORS[index];
                        this.COLORS[index] = this.DEFAULT_COLORS[index];

                        this.storeColorsInCalendarOptions();
                        this.updateColorCSS();
                    }
                },

                resetAllColors() {
                    this.localSettings.colors = [...this.DEFAULT_COLORS];
                    this.COLORS = [...this.DEFAULT_COLORS];

                    this.storeColorsInCalendarOptions();
                    this.updateColorCSS();
                },

                storeColorsInCalendarOptions() {
                    // Ensure calendar.options exists
                    if (!this.calendar.options) {
                        this.calendar.options = {};
                    }

                    // Store custom colors in calendar.options
                    this.calendar.options.colors = [...this.localSettings.colors];

                    // The calendar watcher will handle syncing to Firebase or localStorage
                    // Refresh the schedule to update the UI
                    if (window.scheduleObj) {
                        scheduleObj.refresh();
                    }
                },

                updateColorCSS() {
                    // Remove existing dynamic style if it exists
                    const existingStyle = document.getElementById('dynamic-color-styles');
                    if (existingStyle) {
                        existingStyle.remove();
                    }

                    // Create new style element
                    const style = document.createElement('style');
                    style.id = 'dynamic-color-styles';

                    let css = '';
                    this.COLORS.forEach((color, index) => {
                        const num = index + 1;
                        css += `.e-color-${num} { background-color: ${color} !important; }\n`;
                        css += `.e-color-${num}:hover { background-color: ${color} !important; }\n`;
                    });

                    style.textContent = css;
                    document.head.appendChild(style);
                },

                loadCustomColors() {
                    // Load custom colors from calendar options if available
                    if (this.calendar.options && this.calendar.options.colors && Array.isArray(this.calendar.options.colors)) {
                        // Update local settings with stored colors
                        this.localSettings.colors = [...this.calendar.options.colors];

                        // Update the component COLORS array
                        this.COLORS = [...this.calendar.options.colors];

                        // Update CSS to reflect custom colors
                        this.updateColorCSS();
                    }
                },

                getTypeColor(typeId) {
                    typeId = parseInt(typeId);
                    return this.COLORS[typeId - 1] || this.COLORS[0];
                },

                storeTypeLabelsInCalendarOptions() {
                    // Ensure calendar.options exists
                    if (!this.calendar.options) {
                        this.calendar.options = {};
                    }

                    // Store type labels directly in calendar.options
                    this.calendar.options.typeLabels = [...this.localSettings.typeLabels];

                    // The calendar watcher will handle syncing to Firebase or localStorage
                    // Refresh the schedule to update the UI
                    if (window.scheduleObj) {
                        scheduleObj.refresh();
                    }
                },

                // One-time migration from notes format to calendar.options format
                importTypeLabelsFromNotes() {
                    try {
                        if (!this.calendar.options) {
                            this.calendar.options = {};
                        }

                        // Skip if we already have typeLabels in calendar.options
                        if (this.calendar?.options?.typeLabels?.length > 0) {
                            this.localSettings.typeLabels = [...this.calendar.options.typeLabels];
                            return true; // Success - already had labels
                        }

                        const notes = this.calendar?.options?.notes || '';
                        const typeRegex = /\b(Type)\s*(\d)\s*[=](.*)\b/ig;
                        const matches = [...notes.matchAll(typeRegex)];

                        if (matches.length > 0) {
                            // Found type definitions in notes to migrate
                            const labels = Array(this.COLORS.length).fill().map((_, i) => `Type ${i + 1}`);

                            matches.forEach(m => {
                                const index = parseInt(m[2]) - 1;
                                if (index >= 0 && index < this.COLORS.length) {
                                    labels[index] = m[3].trim().substring(0, 70);
                                }
                            });

                            // Update localSettings and store in calendar.options
                            this.localSettings.typeLabels = labels;
                            this.calendar.options.typeLabels = [...labels];

                            // Clean up the notes by removing type definitions
                            this.cleanTypeDefinitionsFromNotes(notes, matches);

                            return true; // Success - found and migrated labels
                        }

                        return false; // No labels found to migrate
                    } catch (error) {
                        console.error('Error importing type labels from notes:', error);
                        return false; // Error occurred
                    }
                },

                cleanTypeDefinitionsFromNotes(notes, matches) {
                    // Get all the strings to remove
                    const stringsToRemove = matches.map(match => match[0]);

                    let newNotes = notes;
                    // Remove each string and any line breaks around it
                    stringsToRemove.forEach(str => {
                        // Remove the string with surrounding line breaks
                        newNotes = newNotes.replace(new RegExp(str + '\\n?\\n?', 'g'), '');
                        newNotes = newNotes.replace(new RegExp('\\n?\\n?' + str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), '');
                    });

                    // Clean up excessive line breaks
                    newNotes = newNotes.replace(/\n{3,}/g, '\n\n').trim();

                    // Update notes
                    this.calendar.options.notes = newNotes;
                },

                copyToClipboard(textToCopy, buttonElement) {
                    if (!textToCopy) {
                        this.showToast('Nothing to copy', 'error');
                        return;
                    }

                    navigator.clipboard.writeText(textToCopy).then(() => {
                        const originalContent = buttonElement.innerHTML;
                        const checkIcon = `<svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1 text-green-300" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                                        </svg>`;
                        buttonElement.innerHTML = `${checkIcon} Copied!`;
                        buttonElement.classList.remove('bg-blue-500', 'hover:bg-blue-600');
                        buttonElement.classList.add('bg-green-500');

                        setTimeout(() => {
                            buttonElement.innerHTML = originalContent;
                            buttonElement.classList.remove('bg-green-500');
                            buttonElement.classList.add('bg-blue-500', 'hover:bg-blue-600');
                        }, 1500); // Revert after 1.5 seconds

                    }).catch(err => {
                        console.error('Failed to copy: ', err);
                        this.showToast('Failed to copy link', 'error');
                    });
                },

                showToast(message, type = 'info') {
                    this.$refs.toast.display(message, type);
                },
            }
        };

        const app = Vue.createApp(CalendarVueApp);

        // Register all components globally so they can be used recursively
        Object.entries(COMPONENT_REGISTRY).forEach(([name, component]) => {
            app.component(name, component);
        });

        app.mount('#app');

        // ============================================================
        // COMPONENT REGISTRATION VALIDATOR
        // ============================================================
        // This function validates that all components used in templates are registered
        // It will log warnings for any unregistered components found in the DOM
        // ============================================================
        function validateComponentRegistration() {
            const registeredComponents = Object.keys(COMPONENT_REGISTRY);
            const allElements = document.querySelectorAll('*');
            const customElements = new Set();

            allElements.forEach(el => {
                const tagName = el.tagName.toLowerCase();
                // Check if it's a custom element (contains hyphen and not a standard HTML tag)
                if (tagName.includes('-') && !tagName.startsWith('x-')) {
                    customElements.add(tagName);
                }
            });

            const unregistered = Array.from(customElements).filter(
                tag => !registeredComponents.includes(tag)
            );

            if (unregistered.length > 0) {
                console.error('âš ï¸  UNREGISTERED COMPONENTS DETECTED:');
                console.error('The following components are used in templates but not registered:');
                unregistered.forEach(tag => {
                    console.error(`  - <${tag}> (empty/not rendering)`);
                });
                console.error('\nTo fix: Add these components to COMPONENT_REGISTRY in index.html');
            } else {
                console.log('âœ… All components properly registered');
            }
        }

        // Run validation after a short delay to allow Vue to mount
        setTimeout(validateComponentRegistration, 1000);
    </script>

    <script>
        function linkify(inputText) {
            var replacedText, replacePattern1, replacePattern2, replacePattern3;

            //URLs starting with http://, https://, or ftp://
            replacePattern1 = /(\b(https?|ftp):\/\/[^<>\s"']*[-A-Z0-9+&@#\/%=~_|])/gim;
            replacedText = inputText.replace(replacePattern1, '<a href="$1" target="_blank">$1</a>');

            //URLs starting with "www." (without // before it, or it'd re-link the ones done above).
            replacePattern2 = /(^|[^\/])(www\.[^<>\s"']+(\b|$))/gim;
            replacedText = replacedText.replace(replacePattern2, '$1<a href="http://$2" target="_blank">$2</a>');

            //Change email addresses to mailto:: links.
            replacePattern3 = /(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim;
            replacedText = replacedText.replace(replacePattern3, '<a href="mailto:$1">$1</a>');

            return replacedText;
        }

        // Convert links in description to clickable items using MutationObserver
        const linkifyObserver = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList') {
                    const descriptionEl = document.querySelector(".e-event-popup .e-description-details");
                    if (descriptionEl && !descriptionEl.hasAttribute('data-processed')) {
                        descriptionEl.setAttribute('data-processed', 'true');
                        descriptionEl.innerHTML = linkify(descriptionEl.innerHTML);
                    }
                }
            });
        });

        // Start observing the document with the configured parameters
        linkifyObserver.observe(document.body, {
            childList: true,
            subtree: true
        });
    </script>
</body>

</html>