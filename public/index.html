<!-- 
Open sourced under the MIT License: https://opensource.org/licenses/MIT
Copyright (c) 2022 Kalid Azad
-->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PasteCal: Shareable, no-login calendar</title>

    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            }); var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-WTP9VTM');</script>
    <!-- End Google Tag Manager -->

    <!-- CDN Development (always latest) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

    <!-- Syncfusion styles: https://ej2.syncfusion.com/documentation/appearance/theme/ -->
    <link href="https://cdn.syncfusion.com/ej2/ej2-base/styles/material.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.syncfusion.com/ej2/material.css" rel="stylesheet" type="text/css" />

    <!-- Essential JS 2 Scheduler's material theme -->
    <link href="https://cdn.syncfusion.com/ej2/ej2-schedule/styles/material.css" rel="stylesheet" type="text/css" />

    <style>
        body {
            padding: 0px 5px;
            margin: 5px auto;
            font-family: "Roboto", "Segoe UI", "GeezaPro", "DejaVu Serif", "sans-serif", "-apple-system", "BlinkMacSystemFont";
        }

        .topbar {
            display: flex;
            justify-content: space-between;
            border-bottom: 1px solid #ccc;
            padding: 5px 0px;
            margin-top: 5px;
            font-size: 0.8rem;
        }

        .topbar>div {
            width: 33%;
        }

        .topbar .title {
            font-weight: bold;
            font-size: 1.0rem;
        }

        #help {
            font-size: 0.8rem;
            color: #888;
        }

        /* syncfusion customizations */
        .e-toolbar-item.e-today {
            display: none !important;
        }

        .e-schedule .e-vertical-view .e-time-cells-wrap table td,
        .e-schedule .e-vertical-view .e-work-cells {
            height: 24px !important;
        }

        .e-schedule .e-month-view .e-work-cells {
            height: 100px !important;
        }

        td.e-header-cells.e-disable-dates::before {
            content: '12-4 AM';
            width: 100%;
            margin: 0px auto;
            margin-top: 40%;
            text-align: center;
            display: inline-block;
            color: rgba(0, 0, 0, 0.54);
        }

        td.e-header-cells.e-disable-dates:hover {
            background-color: #fafafa !important;
        }
    </style>

    <!-- Essential JS 2 all script -->
    <script src="https://cdn.syncfusion.com/ej2/dist/ej2.min.js" type="text/javascript"></script>

    <!-- firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-compat.js"></script>
    <script>
        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyCZ9U1FflAFcdDLgxJscs2BwV_PrXqmzKw",
            authDomain: "pastecal-web.firebaseapp.com",
            databaseURL: "https://pastecal-web-default-rtdb.firebaseio.com",
            projectId: "pastecal-web",
            storageBucket: "pastecal-web.appspot.com",
            messagingSenderId: "912998627577",
            appId: "1:912998627577:web:aa652846c2618a986d8a28",
            measurementId: "G-4J99GY9KE6"
        };
        firebase.initializeApp(firebaseConfig);
    </script>

    <script>
        let randomID = (size = 21) => {
            let alphabet = '123456789ABCDEFGHJKLMNPQRSTUVWXYZ'; // no lookalikes
            let id = '';
            let i = size;
            while (i--) {
                // `| 0` is more compact and faster than `Math.floor()`.
                id += alphabet[(Math.random() * alphabet.length) | 0]
            }
            return id;
        }

        function uuidv4() {
            return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
        }

        function parseDate(str) {
            let date = null;

            if (!str) {
                return date;
            }

            // has non-digit separator
            if (str.match(/\D/)) {
                let parts = str.split(/\D/);
                date = new Date((parts[0].length == 2 ? "20" : 0) + parts[0], parts[1] - 1, parts[2]);
            }
            else {
                // YYMMDD
                if (str.length === 6) {
                    date = new Date("20" + str.substring(0, 2), str.substring(2, 4) - 1, str.substring(4, 6));
                }
                // YYYYMMDD
                if (str.length === 8) {
                    date = new Date(str.substring(0, 4), str.substring(4, 6) - 1, str.substring(6, 8));
                }
            }

            // js silliness, no better check?
            return date.toString() == 'Invalid Date' ? null : date;
        }

        // parse test
        if (new Set([
            (new Date(2022, 01 - 1, 02)).getTime(),
            parseDate("20220102").getTime(),
            parseDate("220102").getTime(),
            parseDate("2022-01-02").getTime(),
            parseDate("22-01-02").getTime(),
            parseDate("2022.1.2").getTime(),
            parseDate("22-1-2").getTime()
        ]).size !== 1) {
            console.error("parseDate failed");
        }

        class Event {
            // may be created from JSON object or DHTMLX internal calendar event
            constructor(options) {
                this.id = options.Id || options.id || uuidv4();
                this.title = options.Subject || options.text || options.title;
                this.description = options.Description || options.description || "";
                this.repeat = options.Recurrence || options.repeat || "";
                this.recurrencerule = options.RecurrenceRule || options.recurrencerule || "";
                this.start = options.start;
                this.end = options.end;

                // for SyncFusion Internal Object
                if (options.StartTime) {
                    this.start = new Date(options.StartTime).toISOString();
                    this.end = new Date(options.EndTime).toISOString();
                }
            }
        }

        class Calendar {
            constructor(id, title, events, options) {
                this.id = id;
                this.title = title || "";
                this.events = events || [];
                this.options = options || {};
            }

            getSyncFusionEvents() {
                return this.events.map(e => {
                    return {
                        Id: e.id,
                        Subject: e.title,
                        StartTime: e.start,
                        EndTime: e.end,
                        Description: e.description,
                        RecurrenceRule: e.recurrencerule,
                        //                        IsAllDay: e.allday,
                        Recurrence: e.repeat
                    }
                });
            }

            defaultEvent(title) {
                var e = new Event({ title: title });

                // sample 1-hour event in local timezone 
                var d = new Date();
                d.setHours(12, 0, 0, 0);
                e.start = d.toISOString();
                d.setHours(13, 0, 0, 0);
                e.end = d.toISOString();

                return e;
            }

            import(c) {
                Object.assign(this, c);
            }

            setEvents(events) {
                // console.log("setEvents()", events);
                this.events = events.map(e => {
                    return new Event(e);
                });
                CalendarDataService.sync(this);
            }
        }

        class CalendarDataService {
            static connected = false;
            static db = firebase.database().ref('/calendars');

            // subscribe to live updates
            static subscribe(slug, callback) {
                if (slug) {
                    this.db.child(slug).on('value', data => {
                        var calendar = data.val();
                        // console.log(`DataService: loaded ${slug}`, calendar);
                        if (calendar && calendar.id) {
                            this.connected = slug;
                            callback(calendar);
                        }
                    })
                }
            }

            // only sync if we have existed
            static sync(calendar) {
                if (calendar && calendar.id && this.connected) {
                    // console.log("CalendarDataService.sync()", calendar);
                    this.db.child(calendar.id).set(calendar);
                }
            }

            static create(item) {
                return this.db.push(item);
            }

            static checkExists(id, callback_yes, callback_no) {
                this.db.child(id).once('value', data => {
                    if (data.val()) {
                        callback_yes();
                    } else {
                        callback_no();
                    }
                });
            }

            static createWithId(key, value, success) {
                return this.db.child(key).set(value, (error) => {
                    if (error) {
                        console.log("error creating calendar", error, key, value);
                    } else {
                        success();
                    }
                });
            }

            static update(key, value) {
                return this.db.child(key).update(value);
            }

            static delete(key) {
                return this.db.child(key).remove();
            }
        }
    </script>
</head>

<body>
    <div id="app">
        <div v-if="false" class="extended_hours">
            <input type="checkbox" id="extended" v-model="calendar.options.extended">
            <label for="extended">All hours</label>
        </div>

        <div class="topbar">
            <div style="text-align: left;">
                <a href="/">PasteCal</a>: Shared, no-login calendar
                <button v-on:click="showhelp = !showhelp" class="e-control e-btn e-lib e-primary e-small e-flat"
                    style="color: #03a9f4">Tips</button>
            </div>
            <div style=" text-align: center;" class="title">
                <span v-show="!editTitle" style="display: none; cursor: pointer;" @click="editTitle = true"
                    title="Click to edit" v-text="calendar.title"></span>
                <input type="text" v-show="editTitle" style="display: none;" v-model="calendar.title"
                    @keyup.enter="setTitle($event)">
            </div>
            <div class="recents" style="display: none;">
                <select name="recents" id="recents">
                    <option value="">Recently opened</option>
                </select>
            </div>
            <div style="text-align:right">
                <div v-show="isExisting" style="display: none;">
                    <a :href="calendar.id">https://pastecal.com/{{calendar.id}}</a>
                </div>

                <div v-show="!isExisting" style="display:none;">
                    https://pastecal.com/<input id="slug" type="text" style="width: 10ch;" :disabled="isExisting"
                        v-model="calendar.id" @keyup.enter="create"></input>
                    <button @click="create" v-show="!isExisting" style="margin-left: 5px;"
                        class="e-control e-btn e-lib e-primary e-small e-flat">Save</button>
                </div>
            </div>
        </div>

        <div v-if="showhelp" id="help">
            <ul>
                <li>Pick any shortcode (pastecal.com/yourname) and click save</li>
                <li>There's no passwords (like a wiki). Make private URLs like
                    <code>pastecal.com/yourname-hardtoguess</code>
                </li>
                <li>Set the default date and view:
                    <br />
                    date (or d=): YYYYMMDD, YYMMDD, YYYY.MM.DD (any separator allowed)<br />
                    view (or v=): day, week, month, year, agenda
                    <br />
                    <br />
                    <code>pastecal.com/test?date=2022-04-01&amp;view=week</code>
                </li>

                <br />

                - From Kalid at <a href="https://instacalc.com">instacalc</a> and <a
                    href="https://betterexplained.com">betterexplained</a>
            </ul>
        </div>

        <div id="cal2_wrap" style="width: 100%; height: 100%;">
            <div id="Schedule"></div>
        </div>
        <pre v-text="syncFusionEvents" v-if="debug"></pre>
        <pre v-text="calendar" v-if="debug"></pre>
    </div>

    <script>
        const CalendarVueApp = {
            data() {
                var urlslug = window.location.pathname.split("/")[1];

                if (urlslug.match(/^[a-zA-Z0-9_\-]+$/) && urlslug.length < 40) {
                    // slug is ok
                } else {
                    // should redirect back to homepage if we have a bad url;
                    urlslug = null;
                }

                var id = urlslug ?? randomID(8);
                var cal = new Calendar(id, "New Calendar", []);

                return {
                    isExisting: false, // set by callback
                    editTitle: false,
                    calendar: cal,
                    recents: [],
                    syncFusionEvents: [],     // local copy, not synced
                    urlslug: urlslug,
                    debug: false,
                    showhelp: false,
                }
            },

            mounted() {
                CalendarDataService.subscribe(this.calendar.id, (c) => {
                    this.isExisting = true;
                    this.calendar.import(c);
                });

                window.scheduleObj = new ej.schedule.Schedule();
                scheduleObj.startHour = "05:00";
                scheduleObj.views = ['Day', 'Week', 'Month', 'Year', 'Agenda'];

                // set params from URL
                var url = new URL(window.location.href.toLowerCase());
                var date_param = url.searchParams.get("d") || url.searchParams.get("date");
                var view_param = url.searchParams.get("v") || url.searchParams.get("view");

                if (d = parseDate(date_param)) {
                    scheduleObj.selectedDate = d;
                }

                if (view_param) {
                    switch (view_param.toLowerCase()) {
                        case "d":
                        case "day":
                            scheduleObj.currentView = "Day"; break;
                        case "w":
                        case "week":
                            scheduleObj.currentView = "Week"; break;
                        case "m":
                        case "month":
                            scheduleObj.currentView = "Month"; break;
                        case "y":
                        case "year":
                            scheduleObj.currentView = "Year"; break;
                        case "a":
                        case "agenda":
                            scheduleObj.currentView = "Agenda"; break;
                        default:
                            break;
                    }
                }

                // live binding to events
                scheduleObj.eventSettings.dataSource = this.syncFusionEvents;
                scheduleObj.actionComplete = (ev) => {
                    switch (ev.requestType) {
                        case 'eventChanged':
                        case 'eventCreated':
                        case 'eventRemoved':
                            // console.log("actionComplete()", ev, this.syncFusionEvents, scheduleObj.eventsData);
                            this.calendar.setEvents(this.syncFusionEvents);
                            break;
                    }
                    // console.log(ev);
                };

                scheduleObj.appendTo('#Schedule');

                // extended hours button
                document.addEventListener('click', (e) => {
                    if (e.target.className == "e-header-cells e-disable-dates") {
                        this.calendar.options.extended = !this.calendar.options.extended;
                    }
                });

                // populate sample data if needed, or load from local storage
                if (!this.isExisting && this.calendar.events.length == 0 && !this.urlslug) {
                    var defaultEvent = this.calendar.defaultEvent("Sample event");
                    this.calendar.setEvents([defaultEvent]);
                    this.loadLocalStorage();    // attempt this
                    this.updateCalendarView();
                }
            },

            watch: {
                calendar: {
                    // sync changes to local storage or firebase
                    handler: function (newVal, oldVal) {
                        // console.log("Vue:watch:calendar", newVal, oldVal);
                        if (!this.isExisting) {
                            this.saveLocalStorage();
                        } else {
                            CalendarDataService.sync(this.calendar);
                        }
                        this.updateCalendarView();
                    },
                    deep: true
                },
                'calendar.options.extended'(val) {
                    CalendarDataService.sync(this.calendar);
                    // console.log("calendar.options.extended changed", val);
                    scheduleObj.startHour = val ? "00:00" : "05:00";
                },
            },

            methods: {
                clearLocalStorage() {
                    localStorage.removeItem("calendar");
                },

                loadLocalStorage() {
                    var c = JSON.parse(localStorage.getItem("calendar"));
                    if (c) {
                        this.calendar.import(c);
                    }
                },

                saveLocalStorage() {
                    localStorage.setItem("calendar", JSON.stringify(this.calendar));
                },

                updateCalendarView() {
                    this.syncFusionEvents = this.calendar.getSyncFusionEvents();
                    scheduleObj.eventSettings.dataSource = this.syncFusionEvents;
                },

                create() {
                    CalendarDataService.checkExists(this.calendar.id, () => {
                        alert("Calendar already exists, please choose another name.");
                    }, () => {
                        CalendarDataService.createWithId(this.calendar.id, this.calendar, () => {
                            this.clearLocalStorage();
                            window.location = "/" + this.calendar.id;
                        });
                    });
                },

                setTitle(event) {
                    if (event.target.value.trim()) {
                        this.editTitle = false;
                        this.calendar.title = event.target.value.trim();
                    }
                },
            }
        };

        const app = Vue.createApp(CalendarVueApp).mount('#app');
    </script>

    <script>
        function linkify(inputText) {
            var replacedText, replacePattern1, replacePattern2, replacePattern3;

            //URLs starting with http://, https://, or ftp://
            replacePattern1 = /(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;
            replacedText = inputText.replace(replacePattern1, '<a href="$1" target="_blank">$1</a>');

            //URLs starting with "www." (without // before it, or it'd re-link the ones done above).
            replacePattern2 = /(^|[^\/])(www\.[\S]+(\b|$))/gim;
            replacedText = replacedText.replace(replacePattern2, '$1<a href="http://$2" target="_blank">$2</a>');

            //Change email addresses to mailto:: links.
            replacePattern3 = /(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim;
            replacedText = replacedText.replace(replacePattern3, '<a href="mailto:$1">$1</a>');

            return replacedText;
        }

        // Convert links in description to clickable items. TODO: make this automatic
        setInterval(() => {
            var el = document.querySelector(".e-event-popup .e-description-details");
            if (el && !el.attributes['data-processed']) {
                el.attributes['data-processed'] = true;
                el.innerHTML = linkify(el.innerHTML);
            }
        }, 250);
    </script>
    <br />
</body>

</html>