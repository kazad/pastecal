<!DOCTYPE html>
<html lang="en">
<!-- TODO
https://dhtmlx.com/docs/products/dhtmlxScheduler/ -- can double click to edit inline

Tell Joey if we make the website: https://github.com/joereynolds/what-to-code#websites

Features: 

Use cases:

* Visiting homepage, entering ID, creates the calendar with that shortcode
* Visiting homepage, have random shortcode (shortID) prepopulated
* Visiting pastecal.com/ID creates the calendar (prefilled option to create)
* Visiting homepage, have a list of your recent calcs on the side

TODO:
* Have data parsing to only load the named fields, not the extra ones added by the program

-->

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="X-UA-Compatible" content="ie=edge">
    <title>PasteCal</title>
    <link rel="stylesheet" href="style.css">
    <!--
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/water.css">
-->
    <!-- CDN Development (always latest) -->
    <link rel="stylesheet" href="https://unpkg.com/style.css">
    <!-- calendar TUI -->
    <link rel="stylesheet" type="text/css" href="https://uicdn.toast.com/tui-calendar/latest/tui-calendar.css" />

    <!-- If you use the default popups, use this. -->
    <link rel="stylesheet" type="text/css" href="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.css" />
    <link rel="stylesheet" type="text/css" href="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.css" />

    <script src="https://uicdn.toast.com/tui.code-snippet/v1.5.2/tui-code-snippet.min.js"></script>
    <script src="https://uicdn.toast.com/tui.time-picker/latest/tui-time-picker.min.js"></script>
    <script src="https://uicdn.toast.com/tui.date-picker/latest/tui-date-picker.min.js"></script>
    <script src="https://uicdn.toast.com/tui-calendar/latest/tui-calendar.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.20.1/moment.min.js"></script>

    <script src="https://unpkg.com/vue@3"></script>
    <!-- firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-compat.js"></script>
    <script>
        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyCZ9U1FflAFcdDLgxJscs2BwV_PrXqmzKw",
            authDomain: "pastecal-web.firebaseapp.com",
            databaseURL: "https://pastecal-web-default-rtdb.firebaseio.com",
            projectId: "pastecal-web",
            storageBucket: "pastecal-web.appspot.com",
            messagingSenderId: "912998627577",
            appId: "1:912998627577:web:aa652846c2618a986d8a28",
            measurementId: "G-4J99GY9KE6"
        };

        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);

        nanoid = (t = 21) => {
            let e = "",
                r = crypto.getRandomValues(new Uint8Array(t));
            for (; t--;) {
                let n = 63 & r[t];
                e +=
                    n < 36
                        ? n.toString(36)
                        : n < 62
                            ? (n - 26).toString(36).toUpperCase()
                            : n < 63
                                ? nanoid(1) // replace with another random character
                                : nanoid(1);
            }
            return e;
        };
        Utils = {};
        Utils.nanoid = nanoid;

        class Event {
            // being created from a TUI event
            constructor(options) {
                this.id = Utils.nanoid(8);
                this.title = options.text || options.title;

                // from DHTMLX
                if (options.start_date && options.end_date) {
                    this.start = options.start_date.toISOString()
                    this.end = options.end_date.toISOString();
                }

                // from TUI
                if (options.start && options.start._date) {
                    this.start = options.start._date.toISOString();
                    this.end = options.end._date.toISOString();
                }
                this.repeat = "";
            }
        }

        class Calendar {
            constructor(id, title, events, options) {
                this.id = id;
                this.title = title || "New Calendar";
                this.events = events || [];
                this.options = options || {};
            }

            // return events in TUI format
            getTUIEvents() {
                return this.events.map(e => {
                    e.category = e.category || "time";
                    return e;
                });
            }

            getDHTMLXEvents() {
                return this.events.map(e => {
                    return {
                        id: e.id,
                        start_date: e.start,
                        end_date: e.end,
                        text: e.title
                    }
                });
            }

            addEvent(e) {
                var event = new Event(e);
                this.events.push(event);
                CalendarDataService.sync(this);
            }

            deleteEvent(eventToDelete) {
                this.events = this.events.filter(e => e.id !== eventToDelete.id);
                CalendarDataService.sync(this);
            }

            updateEvent(updatedEvent) {
                var event = this.events.find(e => e.id === updatedEvent.id);
                if (event) {
                    var updated = new Event(updatedEvent);
                    Object.assign(event, updated);
                } else {
                    console.log("Event not found", updatedEvent);
                }
                CalendarDataService.sync(this);
            }
        }

        class CalendarDataService {
            static slug = null;
            static db = firebase.database().ref('/calendars');

            static getAll() {
                return this.db;
            }

            // subscribe to live updates
            static subscribe(slug) {
                console.log("subscribe to ", slug);
                this.slug = slug;
                if (this.slug) {
                    this.db.child(this.slug).on('value', data => {
                        console.log(`loaded ${slug}`, data.val());
                        // var events = data.val().events;
                        // update calendar object in vue app
                        // app.calendar = data.val();
                        var calendar = data.val();
                        if (calendar && calendar.id) {
                            app.setCalendarData(calendar);
                        }
                    })
                }
            }

            static sync(calendar) {
                if (calendar && calendar.id) {
                    this.db.child(calendar.id).set(calendar);
                }
            }

            static create(item) {
                return this.db.push(item);
            }

            static createWithId(key, value) {
                return this.db.child(key).set(value);
            }

            static update(key, value) {
                return this.db.child(key).update(value);
            }

            static delete(key) {
                return this.db.child(key).remove();
            }
        }
    </script>
    <!--
    <script src="index.js"></script>
-->
</head>

<body>
    <h1>WebCal: No-login shared calendar</h1>
    <style>
        body {
            max-width: 95%;
            margin: 0px auto;
        }

        #app input#slug {
            width: 200px;
        }
    </style>
    <div id="app">
        <pre>{{calendar}}</pre>
        <div style="text-align: center">
            <div v-if="isExisting">
                <a :href="calendar.id">https://pastecal.com/{{calendar.id}}</a>
            </div>
            <h2>{{calendar.title}}</h2>
        </div>
        <div v-if="!isExisting">
            https://pastecal.com/<input id="slug" type="text" :disabled="isExisting" v-model="calendar.id"></input>
            <button @click="create" v-if="!isExisting">Save</button>
        </div>

        <!-- 
        <button @click="month">Month</button>
        <button @click="week">Week</button>
        <button @click="day">Day</button>
        -->
        <!-- <button @click="clearAll">Clear everything</button> -->
    </div>
    <div id="calendar_wrap" style="display: none; width: 95%; height: 600px; border: 1px solid #ccc;">
    </div>

    <script src="https://cdn.dhtmlx.com/scheduler/5.3/dhtmlxscheduler.js?"></script>
    <xlink rel="stylesheet" href="https://cdn.dhtmlx.com/scheduler/5.3/dhtmlxscheduler.css">
        <link rel="stylesheet" href="https://docs.dhtmlx.com/scheduler/codebase/dhtmlxscheduler_material.css?v=5.3.13">

        <div id="cal2_wrap" style="height: 600px;">
            <div id="scheduler_here" class="dhx_cal_container" style='width:100%; height:100%'>
                <div class="dhx_cal_navline">
                    <div class="dhx_cal_prev_button">&nbsp;</div>
                    <div class="dhx_cal_next_button">&nbsp;</div>
                    <div class="dhx_cal_today_button"></div>
                    <div class="dhx_cal_date"></div>
                    <div class="dhx_cal_tab" name="day_tab" style="right:204px;"></div>
                    <div class="dhx_cal_tab" name="week_tab" style="right:140px;"></div>
                    <div class="dhx_cal_tab" name="month_tab" style="right:76px;"></div>
                </div>
                <div class="dhx_cal_header">
                </div>
                <div class="dhx_cal_data">
                </div>
            </div>
        </div>
        <script>
            window.addEventListener("DOMContentLoaded", function () {
                scheduler.init('scheduler_here', new Date(), "week");

                // load events            scheduler.load("../common/events.json");
            });
        </script>
        <script>
            const CalendarVueApp = {
                data() {
                    console.log("Vue: data()");
                    var urlslug = window.location.pathname.split("/")[1];
                    var exists = false;

                    // TODO: Make function to check valid URL slug exists. Then we can set exists.
                    if (urlslug.match(/^[a-zA-Z0-9_\-]+$/) && urlslug.length < 40) {
                        exists = true;
                    } else {
                        // should redirect back to homepage if we have a bad url;
                        urlslug = null;
                    }

                    var id = urlslug ?? Utils.nanoid(8);
                    CalendarDataService.subscribe(id);
                    var cal = new Calendar(id, "New Calendar", []);

                    return {
                        isExisting: exists,
                        calendar: cal,
                    }
                },

                setup(props, context) {
                    console.log("Vue:setup()", props, context);
                    /*
                    window.calendar_view = new tui.Calendar('#calendar_wrap', {
                        defaultView: 'month',
                        taskView: false,
                        useCreationPopup: true,
                        useDetailPopup: true,
                    });

                    calendar_view.on({
                        beforeCreateSchedule: function (e) {
                            console.log("beforeCreateSchedule", e);
                            console.log(app);
                            app.calendar.addEvent(e);
                        },
                        beforeUpdateSchedule: function (e) {
                            console.log("beforeUpdateSchedule", e);
                            app.calendar.updateEvent(e);
                        },
                        beforeDeleteSchedule: function (e) {
                            console.log("beforeDeleteSchedule", e);
                            app.calendar.deleteEvent(e);
                        },
                    })
                    */

                    scheduler.init("scheduler_here", new Date(), "week");
                    scheduler.attachEvent("onEventAdded", (id, ev) => {
                        console.log("onEventAdded", id, ev);
                        app.calendar.addEvent(ev);
                    });
                    scheduler.attachEvent("onEventChanged", (id, ev) => {
                        console.log("onEventChanged", id, ev);
                        app.calendar.updateEvent(ev);
                    });
                    scheduler.attachEvent("onEventDeleted", (id, ev) => {
                        console.log("onEventDeleted", id, ev);
                        app.calendar.deleteEvent(ev);
                    });
                },

                methods: {
                    create() {
                        CalendarDataService.sync(this.calendar);
                        // TODO: redirect to the new location
                    },

                    setCalendarData(data) {
                        this.calendar = Object.assign(this.calendar, data); // keep as calendar object
                        // calendar_view.clear();
                        // calendar_view.createSchedules(this.calendar.getTUIEvents());
                        scheduler.clearAll();
                        scheduler.parse(this.calendar.getDHTMLXEvents());
                    },

                    clearAll() {
                        console.log('clear');
                    }
                }
            };

            const app = Vue.createApp(CalendarVueApp).mount('#app');
        </script>

        <br />
        <p>
            Features:
        <ul>
            <li>Simple calendar UX</li>
            <li>Share with anyone with a link</li>
            <li>Daily revision history for changes</li>
            <!-- <li>Add calendar with iCal subscription</li> -->
            <li>No-login to embed your calendar in any page</li>
        </ul>
        </p>

</body>

</html>