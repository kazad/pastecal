<!-- 
Open sourced under the MIT License: https://opensource.org/licenses/MIT
Copyright (c) 2022 Kalid Azad
-->
<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- HTML Meta Tags -->
    <title>PasteCal: Shareable, no-login calendar</title>
    <meta name="description" content="Create a public shared calendar link, no signups needed.">

    <!-- Facebook Meta Tags -->
    <meta property="og:url" content="https://pastecal.com/">
    <meta property="og:type" content="website">
    <meta property="og:title" content="PasteCal: Shareable, no-login calendar">
    <meta property="og:description" content="Create a public shared calendar link, no signups needed.">
    <meta property="og:image" content="https://pastecal.com/img/screenshot.png">

    <!-- Twitter Meta Tags -->
    <meta name="twitter:card" content="summary_large_image">
    <meta property="twitter:domain" content="pastecal.com">
    <meta property="twitter:url" content="https://pastecal.com/">
    <meta name="twitter:title" content="PasteCal: Shareable, no-login calendar">
    <meta name="twitter:description" content="Create a public shared calendar link, no signups needed.">
    <meta name="twitter:image" content="https://pastecal.com/img/screenshot.png">

    <!-- Favicons: https://realfavicongenerator.net/ -->
    <link rel="icon" type="image/png" href="/img/icons/favicon-96x96.png" sizes="96x96" />
    <link rel="icon" type="image/svg+xml" href="/img/icons/favicon.svg" />
    <link rel="shortcut icon" href="/img/icons/favicon.ico" />
    <link rel="apple-touch-icon" sizes="180x180" href="/img/icons/apple-touch-icon.png" />
    <link rel="manifest" href="/site.webmanifest" />
    <meta name="msapplication-TileColor" content="#da532c">
    <meta name="theme-color" content="#ffffff">

    <!-- Google Tag Manager -->
    <script>(function (w, d, s, l, i) {
            w[l] = w[l] || []; w[l].push({
                'gtm.start':
                    new Date().getTime(), event: 'gtm.js'
            }); var f = d.getElementsByTagName(s)[0],
                j = d.createElement(s), dl = l != 'dataLayer' ? '&l=' + l : ''; j.async = true; j.src =
                    'https://www.googletagmanager.com/gtm.js?id=' + i + dl; f.parentNode.insertBefore(j, f);
        })(window, document, 'script', 'dataLayer', 'GTM-WTP9VTM');</script>
    <!-- End Google Tag Manager -->

    <!-- CDN Development (always latest) -->
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>

    <!-- Syncfusion styles: https://ej2.syncfusion.com/documentation/appearance/theme/ -->
    <link href="https://cdn.syncfusion.com/ej2/ej2-base/styles/material.css" rel="stylesheet" type="text/css" />
    <link href="https://cdn.syncfusion.com/ej2/material.css" rel="stylesheet" type="text/css" />

    <!-- Essential JS 2 Scheduler's material theme -->
    <link href="https://cdn.syncfusion.com/ej2/ej2-schedule/styles/material.css" rel="stylesheet" type="text/css" />

    <!-- Add Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>

    <style>
        body a {
            text-decoration: none;
            color: rgb(3, 169, 244);
        }

        body a:hover {
            text-decoration: underline;
        }

        /* Keep only Syncfusion customizations */
        .e-toolbar-item.e-today {
            display: none !important;
        }

        .e-schedule .e-vertical-view .e-time-cells-wrap table td,
        .e-schedule .e-vertical-view .e-work-cells {
            height: 24px !important;
        }

        .e-schedule .e-month-view .e-work-cells {
            height: 100px !important;
        }

        td.e-header-cells.e-disable-dates::before {
            content: '12-4 AM';
            width: 100%;
            margin: 0px auto;
            margin-top: 40%;
            text-align: center;
            display: inline-block;
            color: #36b1f6;
            cursor: pointer;
        }

        td.e-header-cells.e-disable-dates:hover {
            background-color: #fafafa !important;
        }

        /* Keep color classes for event types */
        span.e-menu-icon.e-color-1 {
            background: #3f51b5;
        }

        span.e-menu-icon.e-color-2 {
            background: #e3165b;
        }

        span.e-menu-icon.e-color-3 {
            background: #ff6652;
        }

        span.e-menu-icon.e-color-4 {
            background: #4caf50;
        }

        span.e-menu-icon.e-color-5 {
            background: #ff9800;
        }

        span.e-menu-icon.e-color-6 {
            background: #03a9f4;
        }

        span.e-menu-icon.e-color-7 {
            background: #9e9e9e;
        }

        span.e-menu-icon.e-color-8 {
            background: #27282f;
        }

        /* Keep essential Syncfusion form styles */
        .custom-field-row-color {
            position: absolute;
            top: 1rem;
            right: 25px;
        }

        .custom-field-row-color .e-caret {
            color: #eee;
        }

        /* make room for color picker */
        .e-subject-container {
            margin-right: 50px;
        }

        .e-schedule-dialog .e-subject-container {
            width: 100%;
        }

        .e-location-container {
            display: none;
        }

        /* font overrides */
        html,
        div#Schedule,
        .e-control,
        .e-css,
        .e-toolbar,
        .e-tbar-btn,
        .e-tbar-btn-text,
        .e-control-wrapper,
        .e-label,
        textarea {
            font-family: ui-sans-serif, system-ui, sans-serif, "Apple Color Emoji", "Segoe UI Emoji", "Segoe UI Symbol", "Noto Color Emoji" !important;
            font-weight: normal;
        }

        /* to find all roboto fonts: 
        [...document.querySelectorAll('*')].filter(el => {
                const font = getComputedStyle(el).fontFamily.toLowerCase();
                return font.includes('roboto');
        });
        */

        div#Schedule,
        .e-appointment,
        .e-draggable,
        .e-btn {
            border-radius: 6px !important;
        }

        .e-dialog,
        .e-popup,
        .e-calendar {
            border-radius: 6px;
            overflow: hidden;
        }

        /* better colors */
        .e-schedule .e-vertical-view .e-work-cells,
        .e-schedule .e-vertical-view .e-date-header-wrap table tbody td {
            border-color: #efefef;
        }

        /* some fonts get cut off */
        .e-schedule.e-device .e-vertical-view .e-time-cells-wrap {
            overflow: visible;
        }

        /* better save icon */
        .e-schedule-dialog.e-device .e-save-icon::before {
            content: 'SAVE';
            color: #e3165b;
            font-size: 16px;
        }
    </style>

    <style>
        .quick-add-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 1000;
        }

        .quick-add-dialog {
            background-color: white;
            padding: 20px;
            border-radius: 8px;
            width: 80%;
            max-width: 500px;
        }

        .quick-add-dialog textarea {
            width: 100%;
            margin-bottom: 10px;
        }

        .parsed-event {
            background-color: #f0f0f0;
            padding: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
        }

        .dialog-buttons {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }

        @media screen and (max-width: 600px) {
            .mobile-hide {
                display: none;
            }
        }

        [v-cloak] {
            display: none;
        }
    </style>

    <!-- Essential JS 2 all script -->
    <script src="https://cdn.syncfusion.com/ej2/23.2.6/dist/ej2.min.js" type="text/javascript"></script>
    <script>
        ej.base.registerLicense('Ngo9BigBOggjHTQxAR8/V1NHaF1cW2hIfEx1RHxQdld5ZFRHallYTnNWUj0eQnxTdEZiW39fcXJXR2JUV0NyWg==');
    </script>

    <!-- firebase -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-compat.js"></script>
    <script>
        // Your web app's Firebase configuration
        // For Firebase JS SDK v7.20.0 and later, measurementId is optional
        const firebaseConfig = {
            apiKey: "AIzaSyCZ9U1FflAFcdDLgxJscs2BwV_PrXqmzKw",
            authDomain: "pastecal-web.firebaseapp.com",
            databaseURL: "https://pastecal-web-default-rtdb.firebaseio.com",
            projectId: "pastecal-web",
            storageBucket: "pastecal-web.appspot.com",
            messagingSenderId: "912998627577",
            appId: "1:912998627577:web:aa652846c2618a986d8a28",
            measurementId: "G-4J99GY9KE6"
        };
        firebase.initializeApp(firebaseConfig);

        // 
        if (location.href.includes("localhost") && location.href.includes("?local")) {
            firebase.functions().useEmulator("localhost", 5001);
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/chrono-node@1.4.9/dist/chrono.min.js"></script>
    <script src="/index.js"></script>

    <script>
        function debounce(func, timeout = 300) {
            let timer;
            return (...args) => {
                clearTimeout(timer);
                timer = setTimeout(() => { func.apply(this, args); }, timeout);
            };
        }

        function sanitizeUrl(url) {
            // example: http://pastecal.com/SOMEID?date=2025-02-10&amp;amp;view=month 
            let sanitized = url.replaceAll("amp;", "&").replace(/&+/g, '&')
            return sanitized;
        }

        let randomID = (size = 21) => {
            let alphabet = '123456789ABCDEFGHJKLMNPQRSTUVWXYZ'; // no lookalikes
            let id = '';
            let i = size;
            while (i--) {
                // `| 0` is more compact and faster than `Math.floor()`.
                id += alphabet[(Math.random() * alphabet.length) | 0]
            }
            return id;
        }

        function uuidv4() {
            return ([1e7] + -1e3 + -4e3 + -8e3 + -1e11).replace(/[018]/g, c =>
                (c ^ crypto.getRandomValues(new Uint8Array(1))[0] & 15 >> c / 4).toString(16)
            );
        }

        function parseDate(str) {
            let date = null;

            if (!str) {
                return date;
            }

            // has non-digit separator
            if (str.match(/\D/)) {
                let parts = str.split(/\D/);
                date = new Date((parts[0].length == 2 ? "20" : 0) + parts[0], parts[1] - 1, parts[2]);
            }
            else {
                // YYMMDD
                if (str.length === 6) {
                    date = new Date("20" + str.substring(0, 2), str.substring(2, 4) - 1, str.substring(4, 6));
                }
                // YYYYMMDD
                if (str.length === 8) {
                    date = new Date(str.substring(0, 4), str.substring(4, 6) - 1, str.substring(6, 8));
                }
            }

            // js silliness, no better check?
            return date.toString() == 'Invalid Date' ? null : date;
        }

        // parse test
        if (new Set([
            (new Date(2022, 1 - 1, 2)).getTime(),
            parseDate("20220102").getTime(),
            parseDate("220102").getTime(),
            parseDate("2022-01-02").getTime(),
            parseDate("22-01-02").getTime(),
            parseDate("2022.1.2").getTime(),
            parseDate("22-1-2").getTime()
        ]).size !== 1) {
            console.error("parseDate failed");
        }

        class Event {
            // may be created from JSON object or DHTMLX internal calendar event
            constructor(options) {
                this.id = options.Id || options.id || uuidv4();
                this.title = options.Subject || options.text || options.title || "";
                this.description = options.Description || options.description || "";
                this.repeat = options.Recurrence || options.repeat || "";
                this.recurrencerule = options.RecurrenceRule || options.recurrencerule || "";
                this.start = options.start || null;
                this.end = options.end || null;
                this.type = options.Type || options.type || 1;

                this.recurrenceID = options.RecurrenceID || options.recurrenceID || null;
                this.recurrenceException = options.RecurrenceException || options.recurrenceException || null;

                // for SyncFusion Internal Object
                if (options.StartTime) {
                    this.start = new Date(options.StartTime).toISOString() || null;
                    this.end = new Date(options.EndTime).toISOString() || null;
                }

                // Firebase saves fail with undefined properties, ensure they are null instead
                for (let prop in this) {
                    if (this[prop] === undefined) {
                        this[prop] = null;
                    }
                }
            }
        }

        class Calendar {
            constructor(id, title, events, options) {
                this.id = id;
                this.title = title || "";
                this.events = events || [];
                this.options = options || {};
            }

            getSyncFusionEvents() {
                return this.events.map(e => {
                    return {
                        Id: e.id,
                        Subject: e.title,
                        StartTime: e.start,
                        EndTime: e.end,
                        Description: e.description,
                        RecurrenceRule: e.recurrencerule,
                        Type: e.type || 1,

                        //                        IsAllDay: e.allday,
                        Recurrence: e.repeat,
                        RecurrenceID: e.recurrenceID,
                        RecurrenceException: e.recurrenceException
                    }
                });
            }

            defaultEvent(title) {
                var e = new Event({ title: title });

                // sample 1-hour event in local timezone 
                var d = new Date();
                d.setHours(12, 0, 0, 0);
                e.start = d.toISOString();
                d.setHours(13, 0, 0, 0);
                e.end = d.toISOString();

                return e;
            }

            import(c) {
                Object.assign(this, c);
            }

            setEvents(events) {
                // console.log("setEvents()", events);
                this.events = events.map(e => {
                    return new Event(e);
                });
                CalendarDataService.debounce_sync(this);
            }
        }

        class CalendarDataService {
            static connected = false;
            static db = firebase.database().ref('/calendars');
            static db_readonly = firebase.database().ref('/calendars_readonly');

            // subscribe to live updates
            static subscribe(slug, callback) {
                if (slug) {
                    this.db.child(slug).on('value', data => {
                        var calendar = data.val();
                        // console.log(`DataService: loaded ${slug}`, calendar);
                        if (calendar && calendar.id) {
                            this.connected = slug;
                            callback(calendar);
                        }
                    })
                }
            }

            // subscribe to live updates for read-only calendars
            static subscribe_readonly(slug, callback) {
                if (slug) {
                    this.db_readonly.child(slug).on('value', data => {
                        var calendar = data.val();
                        if (calendar && calendar.id) {
                            // don't set connected
                            callback(calendar);
                        }
                    })
                }
            }

            // only sync if we have existed
            static sync(calendar) {
                if (calendar && calendar.id && this.connected) {
                    // console.log("CalendarDataService.sync()", calendar);
                    this.db.child(calendar.id).set(calendar);
                    console.log('CalendarDataService.sync()');
                }
            }

            static debounce_sync = debounce((cal) => (CalendarDataService.sync(cal)), 500);

            static create(item) {
                return this.db.push(item);
            }

            static checkExists(id, callback_yes, callback_no) {
                this.db.child(id).once('value', data => {
                    if (data.val()) {
                        callback_yes();
                    } else {
                        callback_no();
                    }
                });
            }

            static createWithId(key, value, success) {
                return this.db.child(key).set(value, (error) => {
                    if (error) {
                        console.log("error creating calendar", error, key, value);
                    } else {
                        success();
                    }
                });
            }

            static update(key, value) {
                return this.db.child(key).update(value);
            }

            static delete(key) {
                return this.db.child(key).remove();
            }
        }
    </script>
</head>

<body class="p-1 m-1">
    <div id="app">
        <topbar class="flex justify-between items-center pb-1 md:pb-3 border-b border-gray-100 text-sm">
            <!-- Left section -->
            <section class="flex-1 flex flex-col md:flex-row items-start md:space-x-2 min-w-0">
                <!-- Logo and app name -->
                <logo class="flex items-center space-x-2 text-sm h-8">
                    <a href="/" class="flex items-center group">
                        <img class="h-8 w-8 mr-1.5 flex-shrink-0" src="/img/pastecal.logo.svg" alt="PasteCal Logo">
                        <div class="flex flex-col">
                            <span
                                class="text-blue-500 font-medium text-sm hover:text-blue-600 transition-colors">pastecal</span>
                            <span class="text-gray-400 text-xs hidden lg:block -mt-0.5"
                                style="font-size: 10px;">no-login
                                shared calendar</span>
                        </div>
                    </a>
                </logo>

                <!-- Action buttons -->
                <buttonarea class="flex items-center space-x-1 mt-0">
                    <!-- Recent calendars -->
                    <div class="relative" v-click-outside="closeRecents">
                        <button @click.stop="toggleRecents"
                            class="text-gray-500 hover:text-blue-500 p-1.5 rounded-full transition-colors flex items-center justify-center h-8"
                            title="View recent calendars">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="currentColor"
                                viewBox="0 0 16 16">
                                <path
                                    d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z" />
                                <path d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z" />
                            </svg>
                        </button>

                        <!-- Dropdown content -->
                        <div v-if="showRecents"
                            class="absolute top-full left-0 mt-1 bg-white min-w-[250px] shadow-md rounded-md overflow-hidden z-50"
                            v-cloak>
                            <div class="py-2 px-3 font-medium text-xs bg-gray-50 border-b text-gray-600">Recently Viewed
                            </div>
                            <div v-for="item in recentCalendars" :key="item.id"
                                class="flex justify-between items-center py-2 px-3 hover:bg-gray-50 border-b border-gray-100">
                                <a :href="'/' + item.id" class="text-gray-700 hover:text-blue-500 transition-colors">{{
                                    item.title }}</a>
                                <div class="flex gap-1">
                                    <button @click="togglePin(item.id)"
                                        class="p-1 opacity-60 hover:opacity-100 transition-opacity"
                                        :class="{ 'text-blue-500 opacity-100': item.pinned }">
                                        ðŸ“Œ
                                    </button>
                                    <button @click="removeRecent(item.id)"
                                        class="p-1 opacity-60 hover:opacity-100 transition-opacity">Ã—</button>
                                </div>
                            </div>
                            <div v-if="recentCalendars.length === 0" class="py-4 text-center text-gray-500 text-sm">
                                No recent calendars
                            </div>
                        </div>
                    </div>

                    <!-- Help button -->
                    <button v-on:click="toggleHelp"
                        class="text-gray-500 hover:text-blue-500 p-1.5 rounded-full transition-colors flex items-center justify-center h-8"
                        title="Show help">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="currentColor" viewBox="0 0 16 16">
                            <path d="M8 15A7 7 0 1 1 8 1a7 7 0 0 1 0 14zm0 1A8 8 0 1 0 8 0a8 8 0 0 0 0 16z" />
                            <path
                                d="M5.255 5.786a.237.237 0 0 0 .241.247h.825c.138 0 .248-.113.266-.25.09-.656.54-1.134 1.342-1.134.686 0 1.314.343 1.314 1.168 0 .635-.374.927-.965 1.371-.673.489-1.206 1.06-1.168 1.987l.003.217a.25.25 0 0 0 .25.246h.811a.25.25 0 0 0 .25-.25v-.105c0-.718.273-.927 1.01-1.486.609-.463 1.244-.977 1.244-2.056 0-1.511-1.276-2.241-2.673-2.241-1.267 0-2.655.59-2.75 2.286zm1.557 5.763c0 .533.425.927 1.01.927.609 0 1.028-.394 1.028-.927 0-.552-.42-.94-1.029-.94-.584 0-1.009.388-1.009.94z" />
                        </svg>
                    </button>

                    <!-- Search button -->
                    <button v-on:click="toggleSearch"
                        class="text-gray-500 hover:text-blue-500 p-1.5 rounded-full transition-colors"
                        title="Search events">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="currentColor" viewBox="0 0 16 16">
                            <path
                                d="M11.742 10.344a6.5 6.5 0 1 0-1.397 1.398h-.001c.03.04.062.078.098.115l3.85 3.85a1 1 0 0 0 1.415-1.414l-3.85-3.85a1.007 1.007 0 0 0-.115-.1zM12 6.5a5.5 5.5 0 1 1-11 0 5.5 5.5 0 0 1 11 0z" />
                        </svg>
                    </button>

                    <!-- Settings button -->
                    <button v-if="!isReadOnly" v-on:click="toggleSettings"
                        class="text-gray-500 hover:text-blue-500 p-1.5 rounded-full transition-colors flex items-center justify-center h-8"
                        title="Settings">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="currentColor" viewBox="0 0 16 16">
                            <path
                                d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z" />
                        </svg>
                    </button>

                    <!-- Quick add component - desktop only -->
                    <quick-add v-if="!isReadOnly" class="hidden lg:block"
                        @event-created="handleQuickAddEvent"></quick-add>

                </buttonarea>
            </section>

            <!-- Middle section - Calendar title -->
            <section class="flex-1 flex flex-col md:flex-row items-center justify-center mx-1 md:mx-2 min-w-0 h-8">
                <span v-show="!editTitle" @click="editTitle = true"
                    class="font-bold cursor-pointer max-w-[150px] md:max-w-xs text-center flex items-center h-8 hover:text-blue-500 transition-colors"
                    title="Click to edit" v-text="calendar.title"></span>
                <button v-show="!editTitle" v-on:click="toggleNotes"
                    class="text-gray-500 hover:text-blue-500 p-1.5 rounded-full transition-colors flex items-center justify-center h-8"
                    title="Toggle notes" alt="Notes">
                    <div class="flex items-center">
                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                            stroke="currentColor" class="w-5 h-5">
                            <path stroke-linecap="round" stroke-linejoin="round"
                                d="M19.5 14.25v-2.625a3.375 3.375 0 0 0-3.375-3.375h-1.5A1.125 1.125 0 0 1 13.5 7.125v-1.5a3.375 3.375 0 0 0-3.375-3.375H8.25m0 12.75h7.5m-7.5 3H12M10.5 2.25H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 0 0-9-9Z" />
                        </svg>
                        <span class="ml-0.5 text-xs hidden lg:inline">Notes</span>
                    </div>
                </button>
                <input type="text" class="border p-1 max-w-[150px] md:max-w-xs h-8" v-show="editTitle"
                    v-model="calendar.title" @keyup.enter="setTitle($event)">
            </section>

            <!-- Right section -->
            <section class="flex-1 flex items-center justify-end text-xs min-w-0 h-8">

                <div v-if="isReadOnly">
                    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4" role="alert">
                        <p>Read-only mode</p>
                    </div>
                </div>

                <div v-if="!isReadOnly">
                    <!-- Existing calendar info -->
                    <div v-show="isExisting"
                        class="text-gray-500 flex flex-col md:flex-row flex-nowrap items-center space-y-2 md:space-y-0">
                        <a :href="calendar.id" class="text-gray-600 hover:text-blue-500 transition-colors text-xs">
                            pastecal.com/<span class="inline-block md:inline">{{calendar.id}}</span>
                        </a>
                        <button v-on:click="toggleShare"
                            class="ml-1 text-gray-500 hover:text-blue-500 transition-colors flex-shrink-0">
                            <span class="hidden">share</span>
                            <span class="inline-block">
                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 inline" fill="none"
                                    viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                        d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" />
                                </svg>
                            </span>
                        </button>
                        <div class="hidden flex-shrink-0">
                            <span class="mx-1 text-gray-300">&middot;</span>
                            <a :href="calendar.id + '.ics'"
                                class="text-gray-600 hover:text-blue-500 transition-colors">iCal</a>
                        </div>
                    </div>

                    <!-- New calendar creation -->
                    <div v-show="!isExisting"
                        class="flex items-center flex-col md:flex-row space-y-1 md:space-y-0 relative">
                        <div class="absolute -top-2.5 right-1 text-gray-400 md:hidden text-xs" style="font-size: 10px">
                            pastecal.com/
                        </div>
                        <div class="text-xs md:text-sm scale-80 md:scale-none">
                            <span class="text-gray-500 hidden md:inline">pastecal.com/</span>
                            <input id="slug"
                                class="border border-gray-200 focus:border-blue-400 px-1 w-20 text-xs focus:outline-none transition-colors"
                                type="text" :disabled="isExisting" v-model="calendar.id" @keyup.enter="create">
                        </div>
                        <button @click="create" v-show="!isExisting"
                            class="ml-2 px-3 py-1 text-white bg-blue-500 rounded-full text-xs hover:bg-blue-600 transition-colors flex-shrink-0">
                            Save
                        </button>
                    </div>
                </div>
            </section>
        </topbar>

        <panel class="flex bg-gray-50 p-1 md:p-3 rounded-sm border mb-4 relative w-full" v-if="isPanelOpen()" v-cloak>
            <button class="absolute top-0 right-0 m-2 md:m-4 text-gray-500 hover:text-red-500 transition-colors"
                @click="closeAllPanels">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5"
                    stroke="currentColor" class="w-6 h-6">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
            </button>

            <div v-if="showNotes" class="w-1/2 min-w-[460px] h-[250px] mx-auto p-2.5" v-cloak>
                <textarea v-if="!isReadOnly"
                    class="w-full h-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                    placeholder="Notes..." v-model="calendar.options.notes"></textarea>

                <div v-if="isReadOnly"
                    class="w-full h-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500 text-sm"
                    v-html="getReadOnlyNotes()">
                </div>
            </div>
            <div v-if="showSearch" class="mb-2.5 text-sm" v-cloak>
                <input type="text" v-model="searchQuery" @input="searchEvents"
                    class="w-full p-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-500"
                    placeholder="Search events...">

                <div v-if="searchResults.length > 0" class="mt-2 max-h-[300px] overflow-auto">
                    <div v-for="event in searchResults" :key="event.id" @click="jumpToEvent(event)"
                        class="cursor-pointer p-2 hover:bg-gray-50 rounded">
                        {{ event.title }}: {{ formatDate(event.start) }} - {{ formatDate(event.end) }}
                    </div>
                </div>
            </div>
            <div v-if="showHelp" class="text-sm text-gray-700 p-4" v-cloak>
                <div class="w-full overflow-hidden rounded-lg shadow-md">
                    <table class="min-w-full divide-y divide-gray-200">
                        <thead>
                            <tr class="bg-blue-500 text-white">
                                <th class="px-6 py-3 text-left text-sm font-medium uppercase tracking-wider w-1/3">
                                    Feature</th>
                                <th class="px-6 py-3 text-left text-sm font-medium uppercase tracking-wider w-2/3">
                                    How to</th>
                            </tr>
                        </thead>
                        <tbody class="bg-white divide-y divide-gray-200">
                            <!-- Share a calendar -->
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 font-medium">Share a calendar</td>
                                <td class="px-6 py-4">
                                    <p class="mb-2">
                                        Choose a URL (<code class="bg-gray-100 px-1 rounded">pastecal.com/name</code>)
                                        and save. <br />
                                        For privacy, make it hard to guess:
                                        <code class="bg-gray-100 px-1 rounded">name-secretword</code>
                                    </p>
                                    <p>Anyone with the link can view/edit without logging in.</p>
                                </td>
                            </tr>


                            <!-- Link to specific date -->
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 font-medium">Link to specific date/view</td>
                                <td class="px-6 py-4">
                                    <p class="mb-2">
                                        Use URL parameters:
                                        <code
                                            class="bg-gray-100 px-1 rounded">pastecal.com/cal?date=2024-04-01&view=week</code>
                                    </p>
                                    <p class="mb-2">
                                        <span class="font-medium">Date formats:</span> YYYY-MM-DD, YYMMDD, YYYY.MM.DD
                                    </p>
                                    <p>
                                        <span class="font-medium">Views:</span> day, week, month, year, agenda
                                    </p>
                                </td>
                            </tr>

                            <!-- View in another app -->
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 font-medium">Jump between calendars
                                </td>
                                <td class="px-6 py-4">
                                    <p class="mb-2">Click the history icon
                                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 inline relative -top-0.5"
                                            fill="currentColor" viewBox="0 0 16 16">
                                            <path
                                                d="M8 3.5a.5.5 0 0 0-1 0V9a.5.5 0 0 0 .252.434l3.5 2a.5.5 0 0 0 .496-.868L8 8.71V3.5z">
                                            </path>
                                            <path
                                                d="M8 16A8 8 0 1 0 8 0a8 8 0 0 0 0 16zm7-8A7 7 0 1 1 1 8a7 7 0 0 1 14 0z">
                                            </path>
                                        </svg>
                                        to jump between recently viewed calendars
                                </td>
                            </tr>

                            <!-- Custom event types -->
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 font-medium">Custom event type labels</td>
                                <td class="px-6 py-4">
                                    <ol class="list-decimal pl-6 mb-2 space-y-1">
                                        <li>Open Settings <span class="inline-block align-middle">
                                                <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4"
                                                    fill="currentColor" viewBox="0 0 16 16">
                                                    <path
                                                        d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1 2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1 .872-2.105l.34-.1c1.4-.413 1.4-2.397 0-2.81l-.34-.1a1.464 1.464 0 0 1-.872-2.105l.17-.31c.698-1.283-.705-2.686-1.987-1.987l-.311.169a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z" />
                                                </svg>
                                            </span> in the top menu</li>
                                        <li>Go to the "Calendar Settings" section</li>
                                        <li>Edit the labels next to each color in the "Event Types" area</li>
                                    </ol>
                                </td>
                            </tr>


                            <!-- History -->
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 font-medium">Use calendar in another app (phone, computer, etc.)
                                </td>
                                <td class="px-6 py-4">
                                    <p class="mb-2">Import the ICS link in your calendar app, phone:
                                        <code class="bg-gray-100 px-1 rounded">pastecal.com/name.ics</code>
                                    </p>
                                    <p>You can set alerts, reminders, etc. in that app.</p>
                                </td>
                            </tr>
                            <!--  Feedback -->
                            <tr class="hover:bg-gray-50">
                                <td class="px-6 py-4 font-medium">Feedback / bug reports</td>
                                <td class="px-6 py-4">
                                    <p class="mb-2"><a href="https://github.com/kazad/pastecal/issues"
                                            class="text-blue-500 hover:underline">Share feedback on Github</a>.
                                    </p>
                                    Made by Kalid (<a href="https://instacalc.com"
                                        class="text-blue-500 hover:underline">Instacalc</a>,
                                    <a href="https://betterexplained.com" class="text-blue-500 hover:underline">Better
                                        Explained</a>)
                                    </p>

                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

            <div v-if="showShare" class="p-2.5 text-sm w-full" v-cloak>
                <h2 class="text-lg font-bold mb-4">Sharing</h2>

                <div class="grid md:grid-cols-2 gap-6">
                    <div class="bg-white p-4 rounded-lg shadow-sm border">
                        <editlink>
                            <h4 class="font-medium mb-2 capitalize">Full access (editable) calendar link</h4>
                            <p class="text-xs text-gray-500 mb-2">
                                Anyone with this link can view and change events. No login required.
                            </p>
                            <div class="flex gap-2 mb-8">
                                <input type="text" :value="getCalendarLink()" readonly @click="copyToClipboard"
                                    class="flex-1 p-2 border rounded bg-gray-50">
                                <button @click="copyToClipboard($event.target.previousElementSibling)"
                                    class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                    </svg>
                                    Copy
                                </button>
                                <button v-if="canShare()" @click="shareUrl(getCalendarLink(), 'Calendar')"
                                    class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M9 8.25H7.5a2.25 2.25 0 0 0-2.25 2.25v9a2.25 2.25 0 0 0 2.25 2.25h9a2.25 2.25 0 0 0 2.25-2.25v-9a2.25 2.25 0 0 0-2.25-2.25H15m0-3-3-3m0 0-3 3m3-3V15" />
                                    </svg>
                                </button>
                            </div>
                        </editlink>

                        <specificview>
                            <h4 class="font-medium mb-2 capitalize">Current date selection and layout</h4>
                            <p class="text-xs text-gray-500 mb-2">
                                Direct link to a specific day and layout (day, week, month, year, agenda). Useful for
                                upcoming events.
                            </p>
                            <div class="flex gap-2 mb-8">
                                <input type="text" :value="currentViewLink" readonly @click="copyToClipboard"
                                    class="flex-1 p-2 border rounded bg-gray-50">
                                <button @click="copyToClipboard($event.target.previousElementSibling)"
                                    class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                    </svg>
                                    Copy
                                </button>
                                <button v-if="canShare()" @click="shareUrl(currentViewLink, 'Calendar View')"
                                    class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M9 8.25H7.5a2.25 2.25 0 0 0-2.25 2.25v9a2.25 2.25 0 0 0 2.25 2.25h9a2.25 2.25 0 0 0 2.25-2.25v-9a2.25 2.25 0 0 0-2.25-2.25H15m0-3-3-3m0 0-3 3m3-3V15" />
                                    </svg>
                                </button>
                            </div>
                        </specificview>

                        <icslink>
                            <h4 class="font-medium mb-2 capitalize">ICS link for other apps</h4>
                            <p class="text-xs text-gray-500 mb-2">
                                Add to your phone, Google calendar, etc. and set alerts in that app.
                            </p>
                            <div class="flex gap-2">
                                <input type="text" :value="getICSLink()" readonly @click="copyToClipboard"
                                    class="flex-1 p-2 border rounded bg-gray-50">
                                <button @click="copyToClipboard($event.target.previousElementSibling)"
                                    class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                    </svg>
                                    Copy
                                </button>
                                <button v-if="canShare()" @click="shareUrl(getICSLink(), 'Calendar ICS')"
                                    class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round"
                                            d="M9 8.25H7.5a2.25 2.25 0 0 0-2.25 2.25v9a2.25 2.25 0 0 0 2.25 2.25h9a2.25 2.25 0 0 0 2.25-2.25v-9a2.25 2.25 0 0 0-2.25-2.25H15m0-3-3-3m0 0-3 3m3-3V15" />
                                    </svg>
                                </button>
                            </div>
                        </icslink>
                    </div>

                    <div class="bg-white p-4 rounded-lg shadow-sm border">
                        <viewonly>
                            <h4 class="font-medium mb-2 inline-flex items-center gap-x-2">
                                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                    stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                    <path stroke-linecap="round" stroke-linejoin="round"
                                        d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
                                </svg>

                                View-Only Calendar Link
                            </h4>
                            <p class="text-xs text-gray-500 mb-2">
                                The read-only version of this calendar. Updates to the original calendar will sync
                                to the view-only version.
                            </p>

                            <!-- If no view-only link exists yet -->
                            <div v-if="!getReadOnlyLink()" class="flex gap-2">
                                <button @click="createReadOnlyLink"
                                    class="px-3 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 flex items-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none"
                                        viewBox="0 0 24 24" stroke="currentColor">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                            d="M13.828 10.172a4 4 0 00-5.656 0l-4 4a4 4 0 105.656 5.656l1.102-1.101m-.758-4.899a4 4 0 005.656 0l4-4a4 4 0 00-5.656-5.656l-1.1 1.1" />
                                    </svg>
                                    Create View-Only Link
                                </button>
                            </div>

                            <!-- If view-only link already exists -->
                            <div v-else class="space-y-2">
                                <div class="flex gap-2">
                                    <input type="text" :value="getReadOnlyLink()" readonly @click="copyToClipboard"
                                        class="flex-1 p-2 border rounded bg-gray-50">
                                    <button @click="copyToClipboard($event.target.previousElementSibling)"
                                        class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" fill="none"
                                            viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                                d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                                        </svg>
                                        Copy
                                    </button>

                                    <button v-if="canShare()" @click="shareUrl(getReadOnlyLink(), 'Calendar')"
                                        class="px-3 py-1 bg-blue-500 text-white rounded hover:bg-blue-600 flex items-center">
                                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none"
                                            viewBox="0 0 24 24" stroke="currentColor">
                                            <path stroke-linecap="round" stroke-linejoin="round"
                                                d="M9 8.25H7.5a2.25 2.25 0 0 0-2.25 2.25v9a2.25 2.25 0 0 0 2.25 2.25h9a2.25 2.25 0 0 0 2.25-2.25v-9a2.25 2.25 0 0 0-2.25-2.25H15m0-3-3-3m0 0-3 3m3-3V15" />
                                        </svg>
                                    </button>
                                </div>
                            </div>
                        </viewonly>
                    </div>
                </div>
            </div>

            <div v-if="showSettings" class="w-full p-2.5 text-sm text-gray-700" v-cloak>
                <h2 class="text-lg font-bold mb-4">Settings</h2>

                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Global Settings -->
                    <div class="bg-white p-4 rounded-lg shadow-sm border">
                        <h3 class="font-bold text-gray-800 mb-3">Personal Settings</h3>
                        <p class="text-xs text-gray-500 mb-4">Settings that apply to your device only, when viewing any
                            calendar.
                        </p>

                        <div class="space-y-4">
                            <div>
                                <label class="block mb-1 font-medium">First day of week</label>
                                <select v-model="globalSettings.firstDayOfWeek" @change="saveGlobalSettings"
                                    class="w-full p-2 border rounded">
                                    <option value="0">Sunday</option>
                                    <option value="1">Monday</option>
                                </select>
                            </div>

                            <div>
                                <label class="block mb-1 font-medium">Time format</label>
                                <select v-model="globalSettings.timeFormat" @change="saveGlobalSettings"
                                    class="w-full p-2 border rounded">
                                    <option value="12">12-hour (1:00 PM)</option>
                                    <option value="24">24-hour (13:00)</option>
                                </select>
                            </div>

                            <div>
                                <label class="block mb-1 font-medium">Default view</label>
                                <select v-model="globalSettings.defaultView" @change="saveGlobalSettings"
                                    class="w-full p-2 border rounded">
                                    <option value="Day">Day</option>
                                    <option value="Week">Week</option>
                                    <option value="Month">Month</option>
                                    <option value="Year">Year</option>
                                    <option value="Agenda">Agenda</option>
                                </select>
                            </div>

                            <div>
                                <label class="block mb-1 font-medium">Start hour</label>
                                <select v-model="globalSettings.startHour" @change="saveGlobalSettings"
                                    class="w-full p-2 border rounded">
                                    <option value="00:00">12:00 AM</option>
                                    <option value="05:00">5:00 AM</option>
                                    <option value="06:00">6:00 AM</option>
                                    <option value="07:00">7:00 AM</option>
                                    <option value="08:00">8:00 AM</option>
                                    <option value="09:00">9:00 AM</option>
                                </select>
                            </div>
                        </div>
                    </div>

                    <!-- Calendar-specific Settings -->
                    <div class="bg-white p-4 rounded-lg shadow-sm border">
                        <h3 class="font-bold text-gray-800 mb-3">Calendar Settings</h3>
                        <p class="text-xs text-gray-500 mb-4">Settings that apply to anyone viewing this calendar
                            ({{calendar.title}}).
                        </p>

                        <div class="space-y-4">
                            <div>
                                <label class="block mb-1 font-medium">Event Type Labels</label>

                                <div v-for="(label, index) in localSettings.typeLabels" :key="index"
                                    class="flex items-center mb-2">
                                    <div class="w-5 h-5 rounded-full mr-2"
                                        :style="{backgroundColor: getTypeColor(index+1)}"></div>
                                    <input :value="label" @input="updateTypeLabel(index+1, $event.target.value)"
                                        class="flex-1 p-2 border rounded text-sm" :placeholder="`Type ${index+1}`">
                                </div>
                            </div>

                            <div>
                                <label class="block mb-1 font-medium">Display options</label>
                                <div class="flex items-center mt-2">
                                    <input type="checkbox" id="extendedHours" v-model="calendar.options.extended"
                                        class="mr-2">
                                    <label for="extendedHours">Show extended hours (12-4 AM)</label>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </panel>

        <div id="cal2_wrap" style="width: 100%; height: 100%;">
            <div id="Schedule"></div>
        </div>
        <pre v-text="syncFusionEvents" v-if="debug"></pre>
        <pre v-text="calendar" v-if="debug"></pre>
    </div>

    <script type="text/x-template" id="quick-add-template">
        <span class="inline-flex items-start">
            <button @click="showDialog" 
                    class="text-gray-500 hover:text-blue-500 p-1.5 rounded-full transition-colors">
                <span class="text-nowrap px-3 py-1 text-white bg-gray-500 rounded-full text-xs hover:bg-blue-600 transition-colors flex-shrink-0">+Event <!-- (âŒ˜E) -->
                </span>
                <kbd class="hidden px-1.5 py-0.5 text-xs bg-gray-100 rounded">âŒ˜E</kbd>
            </button>
    
            <div v-if="dialogVisible" 
                 class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50">
                <div class="bg-white rounded-lg p-6 w-[80%] max-w-[500px]">
                    <h3 class="text-lg font-semibold mb-4">Quick Add Event</h3>
                    <form @submit.prevent="createEvent">
                        <textarea v-model="description" 
                                 placeholder="Enter details ('Meet John tomorrow at 2pm')" 
                                 rows="3" 
                                 @keydown.enter.prevent="handleEnter"
                                 class="w-full p-2 border rounded mb-4 focus:outline-none focus:ring-2 focus:ring-blue-500">
                        </textarea>
    
                        <div class="bg-gray-50 rounded p-4 mb-4">
                            <p><strong>Subject:</strong> {{ parsedEvent?.subject }}</p>
                            <p><strong>Start:</strong> {{ formatDate(parsedEvent?.startDateTime) }}</p>
                            <p><strong>End:</strong> {{ formatDate(parsedEvent?.endDateTime) }}</p>
                        </div>
    
                        <pre class="bg-gray-50 p-4 rounded mb-4 text-sm whitespace-pre">
Examples: 
    
lunch tomorrow 2pm for 1 hour
appointment 9/15 at 2:30pm
birthday party Sat 7pm to 11pm
workout 3pm May 20 for 90 minutes
vacation dec 11 - dec 15
</pre>
    
                        <div class="flex justify-end gap-2">
                            <button type="button" 
                                    @click="hideDialog"
                                    class="px-4 py-2 border rounded hover:bg-gray-50">
                                Cancel
                            </button>
                            <button type="submit" 
                                    :disabled="!isValidEvent"
                                    class="px-4 py-2 bg-blue-500 text-white rounded hover:bg-blue-600 disabled:opacity-50">
                                Create
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </span>
    </script>

    <script>
        const QuickAdd = {
            template: "#quick-add-template",
            data() {
                return {
                    dialogVisible: false,
                    description: '',
                    parsedEvent: null
                };
            },
            computed: {
                isValidEvent() {
                    return this.parsedEvent &&
                        this.parsedEvent.subject &&
                        this.parsedEvent.startDateTime &&
                        !isNaN(new Date(this.parsedEvent.startDateTime).getTime());
                }
            },

            watch: {
                description() {
                    this.parseDescription();
                }
            },
            mounted() {
                window.addEventListener('keydown', this.handleKeydown);
            },
            beforeDestroy() {
                window.removeEventListener('keydown', this.handleKeydown);
            },
            methods: {
                showDialog() {
                    this.dialogVisible = true;
                    this.$nextTick(() => {
                        this.$el.querySelector('textarea').focus();
                    });
                },
                hideDialog() {
                    this.dialogVisible = false;
                    this.description = '';
                    this.parsedEvent = null;
                },
                parseDescription() {
                    this.parsedEvent = Utils.parseHumanWrittenCalendar(this.description);
                },
                createEvent() {
                    if (this.parsedEvent) {
                        this.$emit('event-created', this.parsedEvent);
                        this.hideDialog();
                    }
                },
                formatDate(dateString) {
                    if (!dateString) return '';
                    const options = { weekday: 'short', month: 'short', year: 'numeric', day: 'numeric', hour: 'numeric', minute: 'numeric', hour12: true };
                    return new Date(dateString).toLocaleString(undefined, options);
                },
                handleKeydown(event) {
                    // Check for Cmd+A (Mac) or Ctrl+A (Windows/Linux)
                    if ((event.metaKey || event.ctrlKey) && event.key === 'e') {
                        event.preventDefault();
                        this.showDialog();
                    }
                    // Check for Escape key when dialog is visible
                    if (event.key === 'Escape' && this.dialogVisible) {
                        this.hideDialog();
                    }
                },
                handleEnter(event) {
                    // If Shift key is not pressed, submit the form
                    if (!event.shiftKey) {
                        this.createEvent();
                    }
                }
            }
        };

        // Vue directive for handling clicks outside an element
        const clickOutside = {
            mounted(el, binding) {
                el._clickOutside = (event) => {
                    if (!(el === event.target || el.contains(event.target))) {
                        binding.value(event);
                    }
                };
                document.addEventListener('click', el._clickOutside);
            },
            unmounted(el) {
                document.removeEventListener('click', el._clickOutside);
            }
        };

        const CalendarVueApp = {
            directives: {
                'click-outside': clickOutside
            },
            data() {
                var urlslug = window.location.pathname.split("/")[1];

                if (urlslug.match(/^[a-zA-Z0-9_\-]+$/) && urlslug.length < 40) {
                    // slug is ok
                } else {
                    // should redirect back to homepage if we have a bad url;
                    urlslug = null;
                }

                var id = urlslug ?? randomID(8);
                var cal = new Calendar(id, "New Calendar", []);

                // Define COLORS for consistent reference
                const COLORS = [
                    "#3f51b5", "#e3165b", "#ff6652", "#4caf50",
                    "#ff9800", "#03a9f4", "#9e9e9e", "#27282f"
                ];

                return {
                    isReadOnly: false,
                    isExisting: false, // set by callback
                    editTitle: false,
                    calendar: cal,
                    recentCalendars: [],
                    syncFusionEvents: [],     // local copy, not synced
                    urlslug: urlslug,
                    debug: false,

                    showRecents: false,
                    showHelp: false,
                    showNotes: false,
                    showShare: false,
                    showSearch: false,
                    showSettings: false,
                    showSecurity: false,

                    currentViewLink: '',
                    updateLinkTimer: null, // re-render share link

                    searchQuery: '',
                    searchResults: [],

                    // Settings
                    globalSettings: {
                        firstDayOfWeek: '0',
                        timeFormat: '12',
                        defaultView: 'Week',
                        startHour: '05:00'
                    },
                    localSettings: {
                        typeLabels: Array(COLORS.length).fill().map((_, i) => `Type ${i + 1}`)
                    },

                    // Store COLORS as a component property for consistent reference
                    COLORS: COLORS,

                    // Store browser locale for display
                    browserLocale: navigator.language || navigator.userLanguage || 'en-US'
                }
            },

            mounted() {
                // Initialize recents
                this.recentManager = new RecentCalendars();
                this.recentCalendars = this.recentManager.getAll();

                // Initialize local settings
                this.initializeLocalSettings();
                // We'll load and apply global settings after scheduleObj is initialized

                // readonly: pastecal.com/view/ID
                let path = location.pathname;
                if (path?.startsWith('/view/')) {
                    // Read-only view mode
                    const viewId = path.split('/')[2];
                    this.isReadOnly = true;

                    // Subscribe to the read-only calendar
                    CalendarDataService.subscribe_readonly(viewId, (c) => {
                        this.calendar.import(c);
                        // Add to recents when calendar loads, but mark as read-only
                        if (c.title) {
                            this.recentManager.add(viewId, `${c.title} (View Only)`, true);
                            this.recentCalendars = this.recentManager.getAll();
                        }
                    });
                } else {
                    // default: pastecal.com/ID
                    CalendarDataService.subscribe(this.calendar.id, (c) => {
                        this.isExisting = true;
                        this.calendar.import(c);
                        // Add to recents when calendar loads
                        this.recentManager.add(this.calendar.id, this.calendar.title);
                        this.recentCalendars = this.recentManager.getAll();
                    });
                }

                window.scheduleObj = new ej.schedule.Schedule();
                scheduleObj.startHour = "05:00";
                scheduleObj.views = ['Day', 'Week', 'Month', 'Year', 'Agenda'];

                scheduleObj.readonly = this.isReadOnly;


                // Set up scheduler first, then apply settings after initialization
                // set params from URL
                var sanitizedUrl = sanitizeUrl(window.location.href.toLowerCase());
                var url = new URL(sanitizedUrl);
                var date_param = url.searchParams.get("d") || url.searchParams.get("date");
                var view_param = url.searchParams.get("v") || url.searchParams.get("view");

                if (d = parseDate(date_param)) {
                    scheduleObj.selectedDate = d;
                }

                if (view_param) {
                    switch (view_param.toLowerCase()) {
                        case "d":
                        case "day":
                            scheduleObj.currentView = "Day"; break;
                        case "w":
                        case "week":
                            scheduleObj.currentView = "Week"; break;
                        case "m":
                        case "month":
                            scheduleObj.currentView = "Month"; break;
                        case "y":
                        case "year":
                            scheduleObj.currentView = "Year"; break;
                        case "a":
                        case "agenda":
                            scheduleObj.currentView = "Agenda"; break;
                        default:
                            break;
                    }
                }

                // disable drag and drop / resizing for touch devices
                var touchDevice = ('ontouchstart' in document.documentElement);
                scheduleObj.allowDragAndDrop = !touchDevice;
                scheduleObj.allowResizing = !touchDevice;

                // live binding to events
                scheduleObj.eventSettings.dataSource = this.syncFusionEvents;
                scheduleObj.actionComplete = (ev) => {
                    switch (ev.requestType) {
                        case 'eventChanged':
                        case 'eventCreated':
                        case 'eventRemoved':
                            console.log("actionComplete()", ev, this.syncFusionEvents, scheduleObj.eventsData);
                            this.calendar.setEvents(this.syncFusionEvents);
                            break;
                    }
                    // console.log(ev);
                };

                // color events based on type
                scheduleObj.eventRendered = (args) => {
                    // change color as needed
                    categoryColor = app.COLORS[args.data.Type - 1] || app.COLORS[0];
                    if (scheduleObj.currentView === 'Agenda') {
                        args.element.firstChild.style.borderLeftColor = categoryColor;
                    } else {
                        args.element.style.backgroundColor = categoryColor;
                    }
                }

                // custom display for types
                scheduleObj.popupOpen = (args) => {

                    if (args.type === 'Editor') {
                        // console.log("Editor call");

                        function setColor(id) {
                            if (!window.btnObj) {
                                return;
                            }

                            window.btnObj.element.style.background = app.COLORS[id - 1];
                            window.inputEle.setAttribute('value', id);

                            // Explicitly set the Type on the event data object
                            args.data.Type = parseInt(id);
                            // console.log("Color set to:", id, "for event:", args.data);
                        }

                        // Initial setup
                        if (!args.element.querySelector('.custom-field-row-color')) {

                            // console.log("Initial args", args);

                            // button dropdown
                            // TODO: allow live edit (vs reload for types)
                            let items = app.getTypes();

                            window.btnObj = new ej.splitbuttons.DropDownButton({
                                items: items,
                                iconCss: 'e-type',
                                select: (button_args) => {
                                    // console.log("select type args", button_args);
                                    let type = button_args.item.value;
                                    inputEle.value = type;
                                    args.data.Type = type;
                                    setColor(type);
                                }
                            });

                            var createElement = ej.base.createElement;
                            let row = createElement('div', { className: 'custom-field-row-color' });
                            let formElement = args.element.querySelector('.e-schedule-form');
                            formElement.firstChild.insertBefore(row, args.element.querySelector('.e-description-row'));
                            let container = createElement('div', { className: 'custom-field-container', attrs: { name: 'Type' } });

                            window.inputEle = createElement('input', {
                                className: 'e-type e-field', attrs: { name: 'Type' }
                            });
                            container.appendChild(window.inputEle);
                            row.appendChild(container);

                            btnObj.appendTo(container);
                            window.inputEle.setAttribute('name', 'Type');
                            window.inputEle.style.display = "none";
                            window.inputEle.setAttribute('value', args.data.Type);
                        }

                        // Initialize with existing type or default to Type 1
                        const initialType = args.data.Type || 1;
                        setColor(initialType);

                        // Make sure the event has a Type property even if not selected
                        if (!args.data.Type) {
                            args.data.Type = 1; // Default to first type if not set
                        }

                        //setColor(args.data.Type);
                    }
                }

                scheduleObj.appendTo('#Schedule');

                // Load and apply global settings after scheduleObj is fully initialized
                this.loadGlobalSettings();
                this.applyGlobalSettings();

                // extended hours button
                document.addEventListener('click', (e) => {
                    if (e.target.className == "e-header-cells e-disable-dates") {
                        if (!this.calendar.options) this.calendar.options = {};
                        this.calendar.options.extended = !this.calendar?.options?.extended;
                    }
                });

                // populate sample data if needed, or load from local storage
                if (!this.isExisting && this.calendar.events.length == 0 && !this.urlslug) {
                    var defaultEvent = this.calendar.defaultEvent("Sample event");
                    this.calendar.setEvents([defaultEvent]);
                    this.loadLocalStorage();    // attempt this
                    this.updateCalendarView();
                }
            },

            watch: {
                showShare(newValue) {
                    if (newValue) {
                        this.updateCurrentViewLink();
                        this.startUpdateLinkTimer();
                    } else {
                        this.stopUpdateLinkTimer();
                    }
                },

                calendar: {
                    // sync changes to local storage or firebase
                    handler: function (newVal, oldVal) {
                        // console.log("Vue:watch:calendar", newVal, oldVal);
                        if (!this.isExisting) {
                            this.saveLocalStorage();
                        } else {
                            // because calendar.options.notes may be noisy
                            CalendarDataService.debounce_sync(this.calendar);
                        }
                        this.updateCalendarView();
                    },
                    deep: true
                },
                'calendar.options.extended'(val) {
                    // No need to call CalendarDataService.sync here as the calendar watcher will handle that
                    console.log("calendar.options.extended changed", val);
                    // Apply extended hour setting immediately
                    if (window.scheduleObj) {
                        scheduleObj.startHour = val ? "00:00" : this.globalSettings.startHour;
                    }
                },
            },

            methods: {
                clearLocalStorage() {
                    localStorage.removeItem("calendar");
                },

                loadLocalStorage() {
                    var c = JSON.parse(localStorage.getItem("calendar"));
                    if (c) {
                        this.calendar.import(c);
                    }
                },

                saveLocalStorage() {
                    localStorage.setItem("calendar", JSON.stringify(this.calendar));
                },

                updateCalendarView() {
                    this.syncFusionEvents = this.calendar.getSyncFusionEvents();
                    scheduleObj.eventSettings.dataSource = this.syncFusionEvents;
                },

                create() {
                    CalendarDataService.checkExists(this.calendar.id, () => {
                        alert("Calendar already exists, please choose another name.");
                    }, () => {
                        CalendarDataService.createWithId(this.calendar.id, this.calendar, () => {
                            this.clearLocalStorage();
                            window.location = "/" + this.calendar.id;
                        });
                    });
                },

                setTitle(event) {
                    if (event.target.value.trim()) {
                        this.editTitle = false;
                        this.calendar.title = event.target.value.trim();
                    }
                },

                getTypes() {
                    // First check if we have custom labels in calendar.options.typeLabels
                    if (this.calendar?.options?.typeLabels?.length > 0) {
                        return Array(this.COLORS.length).fill().map((_, i) => {
                            let id = i + 1;
                            let title = this.calendar.options.typeLabels[i] || `Type ${id}`;
                            return { text: title, value: id, iconCss: `e-color-${id}` };
                        });
                    }

                    // Fallback to default labels if no custom labels are found
                    return Array(this.COLORS.length).fill().map((_, i) => {
                        let id = i + 1;
                        return { text: `Type ${id}`, value: id, iconCss: `e-color-${id}` };
                    });
                },

                updateCurrentViewLink() {
                    const currentView = scheduleObj.currentView.toLowerCase();
                    const currentDate = scheduleObj.selectedDate.toISOString().slice(0, 10);
                    this.currentViewLink = `${window.location.origin}/${this.calendar.id}?date=${currentDate}&view=${currentView}`;
                },

                getCalendarLink() {
                    return `${window.location.origin}/${this.calendar.id}`;
                },

                getICSLink() {
                    return `${window.location.origin}/${this.calendar.id}.ics`;
                },

                createReadOnlyLink() {
                    // Call the Firebase function
                    const createPublicLink = firebase.functions().httpsCallable('createPublicLink');
                    createPublicLink({ sourceCalendarId: this.calendar.id })
                        .then((result) => {
                            const { publicViewId } = result.data;
                            if (this.calendar.options) {
                                this.calendar.options.publicViewId = publicViewId;
                            } else {
                                this.calendar.options = { publicViewId };
                            }
                        })
                        .catch((error) => {
                            console.error('Error creating public link:', error);
                            // alert('Failed to create public link. Please try again.');
                        });
                },

                getReadOnlyLink() {
                    if (this.calendar.options && this.calendar.options.publicViewId) {
                        return `${window.location.origin}/view/${this.calendar.options.publicViewId}`;
                    }
                    return null;
                },

                getReadOnlyNotes() {
                    let notes = this.calendar.options?.notes || '';

                    // Escape HTML special characters
                    notes = notes.replace(/&/g, "&amp;")
                        .replace(/</g, "&lt;")
                        .replace(/>/g, "&gt;")
                        .replace(/"/g, "&quot;")
                        .replace(/'/g, "&#039;");

                    // Convert URLs to hyperlinks safely
                    // Match URLs starting with http://, https://, or ftp://
                    notes = notes.replace(/(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/ig,
                        '<a href="$1" target="_blank" rel="noopener noreferrer">$1</a>');

                    // Match URLs starting with "www." not preceded by '://'
                    notes = notes.replace(/(^|\s)(www\.[\S]+(\b|$))/ig,
                        '$1<a href="http://$2" target="_blank" rel="noopener noreferrer">$2</a>');

                    // Convert line breaks to <br> tags
                    notes = notes.replace(/\n/g, "<br>");

                    return notes;
                },

                startUpdateLinkTimer() {
                    this.updateLinkTimer = setInterval(() => {
                        this.updateCurrentViewLink();
                    }, 100);
                },

                stopUpdateLinkTimer() {
                    clearInterval(this.updateLinkTimer);
                },

                copyToClipboard(target) {
                    target.select();
                    document.execCommand('copy');
                },

                toggleSearchOld() {
                    this.showSearch = !this.showSearch;
                    if (!this.showSearch) {
                        this.searchQuery = '';
                        this.searchResults = [];
                    }
                },

                searchEvents() {
                    if (this.searchQuery.trim() !== '') {
                        this.searchResults = this.calendar.events.filter(event =>
                            event.title.toLowerCase().includes(this.searchQuery.toLowerCase())
                        );

                        // sort results by newest first
                        this.searchResults.sort((a, b) => new Date(b.start) - new Date(a.start));
                    } else {
                        this.searchResults = [];
                    }
                },

                jumpToEvent(event) {
                    let startDate = new Date(event.start);
                    scheduleObj.selectedDate = startDate;
                    scheduleObj.currentView = 'Week';
                },

                toggleRecents() {
                    this.showRecents = !this.showRecents;
                },

                closeRecents() {
                    this.showRecents = false;
                },

                isPanelOpen() {
                    return this.showNotes || this.showSearch || this.showHelp || this.showShare || this.showSettings || this.showSecurity;
                },

                toggleHelp() {
                    // If help is already open, close it
                    if (this.showHelp) {
                        this.showHelp = false;
                    } else {
                        // Close all other panels first
                        this.closeAllPanels();
                        // Then open help
                        this.showHelp = true;
                    }
                },

                toggleNotes() {
                    if (this.showNotes) {
                        this.showNotes = false;
                    } else {
                        this.closeAllPanels();
                        this.showNotes = true;
                    }
                },

                toggleSearch() {
                    if (this.showSearch) {
                        this.showSearch = false;
                    } else {
                        this.closeAllPanels();
                        this.showSearch = true;
                    }
                },

                toggleShare() {
                    if (this.showShare) {
                        this.showShare = false;
                    } else {
                        this.closeAllPanels();
                        this.showShare = true;
                    }
                },

                toggleSecurity() {
                    if (this.showSecurity) {
                        this.showSecurity = false;
                    } else {
                        this.closeAllPanels();
                        this.showSecurity = true;
                    }
                },

                closeAllPanels() {
                    this.showHelp = false;
                    this.showNotes = false;
                    this.showSearch = false;
                    this.showShare = false;
                    this.showSettings = false;
                    this.showSecurity = false;
                },

                togglePin(id) {
                    this.recentManager.togglePin(id);
                    this.recentCalendars = this.recentManager.getAll();
                },

                removeRecent(id) {
                    this.recentManager.remove(id);
                    this.recentCalendars = this.recentManager.getAll();
                },

                formatDate(dateString) {
                    const options = {
                        weekday: 'short',
                        month: 'short',
                        day: 'numeric',
                        hour: 'numeric',
                        minute: 'numeric',
                        hour12: true
                    };
                    return new Date(dateString).toLocaleString(undefined, options);
                },

                handleQuickAddEvent(event) {
                    const newEvent = new Event({
                        title: event.subject,
                        start: event.startDateTime,
                        end: event.endDateTime
                    });
                    this.calendar.events.push(newEvent);
                    this.calendar.setEvents(this.calendar.events);
                },

                shareUrl(url, title) {
                    if (navigator.share) {
                        navigator.share({
                            title: 'PasteCal Calendar',
                            text: title,
                            url: url
                        }).catch(err => {
                            console.log('Error sharing:', err);
                        });
                    }
                },

                canShare() {
                    return !!navigator.share;
                },

                toggleSettings() {
                    if (this.showSettings) {
                        this.showSettings = false;
                    } else {
                        this.closeAllPanels();
                        this.showSettings = true;

                        // One-time import of type labels from notes when settings panel is opened
                        this.importTypeLabelsFromNotes();
                    }
                },

                // Global Settings methods (device-specific, stored in localStorage)
                loadGlobalSettings() {
                    const settings = JSON.parse(localStorage.getItem('pastecal_global_settings'));
                    if (settings) {
                        this.globalSettings = { ...this.globalSettings, ...settings };
                    } else {
                        // Auto-import locale settings if no saved settings exist
                        this.autoImportLocaleSettings();
                    }
                },

                // Auto-import settings from browser locale
                autoImportLocaleSettings() {
                    try {
                        // Get browser locale 
                        const locale = navigator.language || navigator.userLanguage;
                        console.log("Detected locale:", locale);

                        // Detect 12/24 hour format preference from locale
                        const formatter = new Intl.DateTimeFormat(locale, {
                            hour: 'numeric',
                            hour12: undefined // Let the system decide
                        });
                        const timeFormatSample = formatter.format(new Date(2023, 0, 1, 13, 0, 0));
                        // Check if the formatted time contains "AM" or "PM" or their locale equivalents
                        const is12Hour = timeFormatSample.match(/am|pm|a\.m\.|p\.m\.|AM|PM|A\.M\.|P\.M\./i) !== null;
                        this.globalSettings.timeFormat = is12Hour ? '12' : '24';
                        console.log("Detected time format:", is12Hour ? "12-hour" : "24-hour");

                        // Detect first day of week - cross-browser compatible approach
                        let firstDay = 0; // Default to Sunday (0)

                        try {
                            // Try the newer Intl.Locale API first
                            if (typeof Intl !== 'undefined' &&
                                typeof Intl.Locale !== 'undefined' &&
                                typeof Intl.Locale.prototype.getWeekInfo === 'function') {
                                const weekInfo = new Intl.Locale(locale).getWeekInfo();
                                firstDay = weekInfo.firstDay === 7 ? 0 : weekInfo.firstDay; // Convert Sunday (7) to 0
                                console.log("First day detected using Intl.Locale.getWeekInfo");
                            }
                            // Fallback to region-based detection
                            else {
                                // Countries/regions that typically use Monday as first day of week
                                const mondayFirstRegions = ['AD', 'AL', 'AM', 'AT', 'AZ', 'BA', 'BE', 'BG', 'BY', 'CH',
                                    'CZ', 'DE', 'DK', 'EE', 'ES', 'FI', 'FR', 'GB', 'GE', 'GR',
                                    'HR', 'HU', 'IS', 'IT', 'KG', 'KZ', 'LT', 'LU', 'LV', 'MC',
                                    'MD', 'ME', 'MK', 'MT', 'NL', 'NO', 'PL', 'PT', 'RO', 'RS',
                                    'RU', 'SE', 'SI', 'SK', 'SM', 'TJ', 'TM', 'TR', 'UA', 'UZ',
                                    'VA', 'CN', 'HK', 'JP', 'KP', 'KR', 'MO', 'TW'];

                                // Languages that typically use Monday as first day of week
                                const mondayFirstLanguages = ['ar', 'bg', 'ca', 'cs', 'da', 'de', 'el', 'et', 'eu', 'fa',
                                    'fi', 'fr', 'hr', 'hu', 'is', 'it', 'lt', 'lv', 'mk', 'nl',
                                    'pl', 'pt', 'ro', 'ru', 'sk', 'sl', 'sr', 'sv', 'tr', 'uk', 'zh'];

                                // Extract region code and language code
                                let regionCode = '';
                                let languageCode = '';

                                if (locale.includes('-')) {
                                    const parts = locale.split('-');
                                    languageCode = parts[0].toLowerCase();
                                    regionCode = parts[1].toUpperCase();
                                } else {
                                    languageCode = locale.toLowerCase();
                                }

                                // Check region first, then fall back to language
                                if (mondayFirstRegions.includes(regionCode)) {
                                    firstDay = 1; // Monday
                                    console.log("First day detected as Monday based on region:", regionCode);
                                } else if (mondayFirstLanguages.includes(languageCode)) {
                                    firstDay = 1; // Monday
                                    console.log("First day detected as Monday based on language:", languageCode);
                                } else {
                                    console.log("First day defaulting to Sunday (not in Monday lists)");
                                }
                            }
                        } catch (e) {
                            console.warn("Error in first day detection:", e);
                            // Keep the default (Sunday) if there's an error
                        }

                        this.globalSettings.firstDayOfWeek = firstDay.toString();
                        console.log("Detected first day of week:", firstDay === 0 ? "Sunday" : "Monday");

                        // Add locale detection flag for UI messaging
                        this.globalSettings.autoDetectedFromLocale = true;

                        // Save the imported settings
                        this.saveGlobalSettings();
                    } catch (error) {
                        console.error("Error auto-importing locale settings:", error);
                        // Fallback to defaults if import fails
                    }
                },

                saveGlobalSettings() {
                    try {
                        localStorage.setItem('pastecal_global_settings', JSON.stringify(this.globalSettings));
                        console.log('Global settings saved to localStorage');
                    } catch (error) {
                        console.warn('Failed to save settings to localStorage:', error);
                        // Notify user if in private mode
                        if (error.name === 'QuotaExceededError' ||
                            error.name === 'NS_ERROR_DOM_QUOTA_REACHED' ||
                            error.code === 22) {
                            console.warn('Browser may be in private browsing mode');
                        } else {
                            console.warn('Unable to save settings', error);
                        }
                    }
                    this.applyGlobalSettings();
                },

                applyGlobalSettings() {
                    if (typeof window.scheduleObj === 'undefined' || !window.scheduleObj) {
                        console.log('Scheduler not initialized yet, skipping settings application');
                        return;
                    }

                    try {
                        // Apply first day of week
                        scheduleObj.firstDayOfWeek = parseInt(this.globalSettings.firstDayOfWeek);

                        // Apply time format
                        const timeFormat = this.globalSettings.timeFormat === '24' ? 'HH:mm' : 'hh:mm a';
                        scheduleObj.timeFormat = timeFormat;

                        // Apply default view if not already set via URL
                        if (!window.location.search.includes('view=') && !window.location.search.includes('v=')) {
                            scheduleObj.currentView = this.globalSettings.defaultView;
                        }

                        // Apply start hour if not overridden by extended setting
                        if (!this.calendar?.options?.extended) {
                            scheduleObj.startHour = this.globalSettings.startHour;
                        }

                        console.log('Global settings applied successfully:', {
                            firstDayOfWeek: scheduleObj.firstDayOfWeek,
                            timeFormat: scheduleObj.timeFormat,
                            currentView: scheduleObj.currentView,
                            startHour: scheduleObj.startHour
                        });
                    } catch (error) {
                        console.error('Error applying global settings:', error);
                        // Try to recover by applying settings individually
                        try {
                            scheduleObj.firstDayOfWeek = parseInt(this.globalSettings.firstDayOfWeek);
                            console.log('Applied first day of week setting');
                        } catch (e) { console.warn('Failed to apply first day of week setting:', e); }

                        try {
                            scheduleObj.timeFormat = this.globalSettings.timeFormat === '24' ? 'HH:mm' : 'hh:mm a';
                            console.log('Applied time format setting');
                        } catch (e) { console.warn('Failed to apply time format setting:', e); }

                        try {
                            if (!window.location.search.includes('view=') && !window.location.search.includes('v=')) {
                                scheduleObj.currentView = this.globalSettings.defaultView;
                                console.log('Applied default view setting');
                            }
                        } catch (e) { console.warn('Failed to apply default view setting:', e); }

                        try {
                            if (!this.calendar?.options?.extended) {
                                scheduleObj.startHour = this.globalSettings.startHour;
                                console.log('Applied start hour setting');
                            }
                        } catch (e) { console.warn('Failed to apply start hour setting:', e); }
                    }
                },

                // Calendar-specific Settings methods (stored in calendar.options)
                initializeLocalSettings() {
                    // Ensure we have default type labels
                    const defaultLabels = Array(this.COLORS.length).fill().map((_, i) => `Type ${i + 1}`);

                    if (!this.localSettings.typeLabels || !Array.isArray(this.localSettings.typeLabels)) {
                        this.localSettings.typeLabels = [...defaultLabels];
                    }

                    // If the calendar has typeLabels, use them
                    if (this.calendar?.options?.typeLabels?.length > 0) {
                        this.localSettings.typeLabels = [...this.calendar.options.typeLabels];
                    } else {
                        // Try to import from notes
                        const imported = this.importTypeLabelsFromNotes();
                        if (!imported) {
                            // If import failed or had no labels, use defaults
                            this.localSettings.typeLabels = [...defaultLabels];
                            // Store defaults in calendar.options
                            if (!this.calendar.options) this.calendar.options = {};
                            this.calendar.options.typeLabels = [...defaultLabels];
                        }
                    }
                },

                updateTypeLabel(typeId, value) {
                    const index = typeId - 1;
                    if (index >= 0 && index < this.COLORS.length) {
                        // Sanitize input: trim whitespace, limit length to 70 chars, ensure non-empty
                        let sanitizedValue = value.trim().substring(0, 70);
                        if (sanitizedValue === '') {
                            sanitizedValue = `Type ${typeId}`; // Fallback to default if empty
                        }

                        this.localSettings.typeLabels[index] = sanitizedValue;
                        // Store directly in calendar.options and sync
                        this.storeTypeLabelsInCalendarOptions();

                        // Show confirmation for the user
                        this.showSettingsConfirmation(`Label "${sanitizedValue}" saved successfully`, true);
                    }
                },

                getTypeColor(typeId) {
                    // Use the component's COLORS property instead of redefining
                    return this.COLORS[typeId - 1] || this.COLORS[0];
                },

                storeTypeLabelsInCalendarOptions() {
                    // Ensure calendar.options exists
                    if (!this.calendar.options) {
                        this.calendar.options = {};
                    }

                    // Store type labels directly in calendar.options
                    this.calendar.options.typeLabels = [...this.localSettings.typeLabels];

                    // The calendar watcher will handle syncing to Firebase or localStorage
                    // Refresh the schedule to update the UI
                    if (window.scheduleObj) {
                        scheduleObj.refresh();
                    }
                },

                // One-time migration from notes format to calendar.options format
                importTypeLabelsFromNotes() {
                    try {
                        if (!this.calendar.options) {
                            this.calendar.options = {};
                        }

                        // Skip if we already have typeLabels in calendar.options
                        if (this.calendar?.options?.typeLabels?.length > 0) {
                            this.localSettings.typeLabels = [...this.calendar.options.typeLabels];
                            return true; // Success - already had labels
                        }

                        const notes = this.calendar?.options?.notes || '';
                        const typeRegex = /\b(Type)\s*(\d)\s*[=](.*)\b/ig;
                        const matches = [...notes.matchAll(typeRegex)];

                        if (matches.length > 0) {
                            // Found type definitions in notes to migrate
                            const labels = Array(this.COLORS.length).fill().map((_, i) => `Type ${i + 1}`);

                            matches.forEach(m => {
                                const index = parseInt(m[2]) - 1;
                                if (index >= 0 && index < this.COLORS.length) {
                                    labels[index] = m[3].trim().substring(0, 70);
                                }
                            });

                            // Update localSettings and store in calendar.options
                            this.localSettings.typeLabels = labels;
                            this.calendar.options.typeLabels = [...labels];

                            // Clean up the notes by removing type definitions
                            this.cleanTypeDefinitionsFromNotes(notes, matches);

                            return true; // Success - found and migrated labels
                        }

                        return false; // No labels found to migrate
                    } catch (error) {
                        console.error('Error importing type labels from notes:', error);
                        return false; // Error occurred
                    }
                },

                cleanTypeDefinitionsFromNotes(notes, matches) {
                    // Get all the strings to remove
                    const stringsToRemove = matches.map(match => match[0]);

                    let newNotes = notes;
                    // Remove each string and any line breaks around it
                    stringsToRemove.forEach(str => {
                        // Remove the string with surrounding line breaks
                        newNotes = newNotes.replace(new RegExp(str + '\\n?\\n?', 'g'), '');
                        newNotes = newNotes.replace(new RegExp('\\n?\\n?' + str.replace(/[.*+?^${}()|[\]\\]/g, '\\$&'), 'g'), '');
                    });

                    // Clean up excessive line breaks
                    newNotes = newNotes.replace(/\n{3,}/g, '\n\n').trim();

                    // Update notes
                    this.calendar.options.notes = newNotes;
                },
            }
        };

        const app = Vue.createApp(CalendarVueApp).component('quick-add', QuickAdd).mount('#app');
    </script>

    <script>
        function linkify(inputText) {
            var replacedText, replacePattern1, replacePattern2, replacePattern3;

            //URLs starting with http://, https://, or ftp://
            replacePattern1 = /(\b(https?|ftp):\/\/[-A-Z0-9+&@#\/%?=~_|!:,.;]*[-A-Z0-9+&@#\/%=~_|])/gim;
            replacedText = inputText.replace(replacePattern1, '<a href="$1" target="_blank">$1</a>');

            //URLs starting with "www." (without // before it, or it'd re-link the ones done above).
            replacePattern2 = /(^|[^\/])(www\.[\S]+(\b|$))/gim;
            replacedText = replacedText.replace(replacePattern2, '$1<a href="http://$2" target="_blank">$2</a>');

            //Change email addresses to mailto:: links.
            replacePattern3 = /(([a-zA-Z0-9\-\_\.])+@[a-zA-Z\_]+?(\.[a-zA-Z]{2,6})+)/gim;
            replacedText = replacedText.replace(replacePattern3, '<a href="mailto:$1">$1</a>');

            return replacedText;
        }

        // Convert links in description to clickable items using MutationObserver
        const linkifyObserver = new MutationObserver((mutations) => {
            mutations.forEach((mutation) => {
                if (mutation.type === 'childList') {
                    const descriptionEl = document.querySelector(".e-event-popup .e-description-details");
                    if (descriptionEl && !descriptionEl.hasAttribute('data-processed')) {
                        descriptionEl.setAttribute('data-processed', 'true');
                        descriptionEl.innerHTML = linkify(descriptionEl.innerHTML);
                    }
                }
            });
        });

        // Start observing the document with the configured parameters
        linkifyObserver.observe(document.body, {
            childList: true,
            subtree: true
        });
    </script>
    <br />
</body>

</html>