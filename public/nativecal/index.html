<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>NativeCal Interactive Prototype</title>
    <link rel="stylesheet" href="/style.css">
    <script src="https://unpkg.com/vue@3/dist/vue.global.prod.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Date FNS -->
    <script src="https://cdn.jsdelivr.net/npm/date-fns@3.6.0/cdn.min.js"></script>

    <!-- Shared deps for data/services -->
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-compat.js"></script>
    <script src="/utils/utils.js"></script>
    <script src="/models/Event.js"></script>
    <script src="/services/SlugManager.js"></script>
    <script src="/services/CalendarDataService.js"></script>
    <script src="/models/Calendar.js"></script>
    <link rel="stylesheet" href="/style.css">
    
    <style>
        /* Global Styles */
        :root {
            --bg: #ffffff;
            --bg-disabled: #eaeaea;
            --fg: #333333;
            --link: rgb(3, 169, 244);
            --link-hover: rgb(3, 140, 214);
            --panel-bg: #f9fafb;
            --border-color: #efefef;
            --bg-interactive-hover: #f3f4f6; /* Tailwind gray-100 */
            --text-color-1: #6b7280;
            --text-color-2: #374151;
        }

        /* Basic grid for month view */
        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            border-top: 1px solid #e5e7eb;
            border-left: 1px solid #e5e7eb;
        }
        .calendar-cell {
            min-height: 100px;
            border-right: 1px solid #e5e7eb;
            border-bottom: 1px solid #e5e7eb;
            padding: 0.25rem;
        }
        /* Time grid (Week/Day) */
        .time-grid {
            display: grid;
            /* First col is labels (60px), rest are dates */
            /* Template columns set dynamically via inline style */
        }
        .time-col {
            border-right: 1px solid #e5e7eb;
            min-width: 0; 
            position: relative;
        }
        .hour-row {
            height: 50px; /* 50px per hour */
            border-bottom: 1px solid #f3f4f6;
            box-sizing: border-box;
        }
        
        /* Year View */
        .year-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            padding: 1.5rem;
        }
        .mini-month-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 2px;
        }
        
        .event-card {
            transition: box-shadow 0.1s, transform 0.1s, width 0.2s ease-out, left 0.2s ease-out;
            z-index: 10;
            /* width and left are now set dynamically via style */
        }
        
        .event-card:hover {
            z-index: 50 !important;
        }
        
        .event-card.is-dragging {
            opacity: 0.5;
            z-index: 60 !important;
        }
        
        /* Active Drag State (Cute) */
        .event-card.dragging-active {
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 100 !important;
            opacity: 0.9;
        }
        
        .event-card.dragging-move-active {
            transform: rotate(3deg) scale(1.02);
        }

        .resize-handle {
            cursor: ns-resize;
        }
        .resize-handle:hover {
            background-color: rgba(0,0,0,0.1);
        }

        /* Drag Ghost */
        .drag-ghost {
            position: fixed;
            pointer-events: none;
            z-index: 9999;
            opacity: 0.9;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            transform: translate(-50%, -50%) rotate(3deg) scale(1.05);
        }

        /* Utilities */
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .no-scrollbar { -ms-overflow-style: none; scrollbar-width: none; }
        
        /* Prevent text selection during drag */
        .select-none { user-select: none; }
    </style>
</head>
<body class="bg-white text-gray-800 p-1 m-1 h-screen flex flex-col box-border overflow-hidden">
    <div id="app" class="flex flex-col h-full w-full">
        
        <!-- Settings Modal -->
        <settings-modal 
            v-if="showSettings" 
            :time-format="timeFormat" 
            @update:time-format="updateTimeFormat"
            @close="toggleSettings">
        </settings-modal>

        <!-- App Topbar (Global) -->
        <app-topbar 
            :title="calendarTitle"
            @toggle-settings="toggleSettings"
            @edit-title="editCalendarTitle">
        </app-topbar>

        <!-- Calendar Container (Edge to Edge) -->
        <div class="flex-1 flex flex-col overflow-hidden relative border border-gray-200 rounded-sm bg-white shadow-sm">
            
            <!-- Calendar Toolbar -->
            <calendar-toolbar
                :current-title="currentTitle"
                :current-view="currentView"
                :views="views"
                @prev="prev"
                @next="next"
                @today="today"
                @change-view="changeView">
            </calendar-toolbar>

            <!-- Month View -->
            <month-view v-if="currentView === 'Month'"
                :cells="monthCells"
                :week-days="weekDays"
                :drag-state="dragState"
                :get-events-for-date="getEventsForDate"
                :get-event-style="getEventStyle"
                :is-today="isToday"
                @create-event="createMonthEvent"
                @start-drag="startDrag"
                @select-event="selectEvent">
            </month-view>

            <!-- Time Grid View (Week/Day) -->
            <time-grid-view v-if="currentView === 'Week' || currentView === 'Day'"
                :current-view="currentView"
                :visible-dates="visibleDates"
                :week-days="weekDays"
                :is-today="isToday"
                :current-time-top="currentTimeTop"
                :drag-state="dragState"
                :selected-event-id="selectedEventId"
                :event-cursor="eventCursor"
                :get-events-with-layout="getEventsWithLayout"
                :get-event-style="getEventStyle"
                :get-week-event-position="getWeekEventPosition"
                :get-ghost-style="getGhostStyle"
                :format-time="formatTime"
                :is-same-day="isSameDay"
                :time-format="timeFormat"
                @create-time-event="createTimeEvent"
                @start-drag="startDrag"
                @select-event="selectEvent">
            </time-grid-view>

            <!-- Year View -->
            <div v-if="currentView === 'Year'" class="h-full overflow-y-auto p-4">
                <div class="year-grid">
                    <div v-for="(month, idx) in yearMonths" :key="idx" class="border rounded p-2 hover:shadow-md transition-shadow cursor-pointer"
                         @click="goToMonth(month.date)">
                        <h3 class="text-center font-bold text-gray-700 mb-2">{{ month.name }}</h3>
                        <div class="mini-month-grid">
                            <div v-for="day in ['S','M','T','W','T','F','S']" :key="day" class="text-[10px] text-center text-gray-400">{{ day }}</div>
                            
                            <!-- Empty start cells -->
                            <div v-for="n in month.startPad" :key="'pad-'+n"></div>
                            
                            <!-- Days -->
                            <div v-for="day in month.days" :key="day.date" 
                                 class="text-center text-xs p-1 rounded-full"
                                 :class="{'bg-blue-600 text-white': isToday(day.date), 'bg-blue-100': day.hasEvents && !isToday(day.date)}">
                                {{ day.dayNumber }}
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Agenda View -->
            <div v-if="currentView === 'Agenda'" class="h-full overflow-y-auto p-4">
                <div class="max-w-3xl mx-auto space-y-6">
                    <div v-if="agendaEvents.length === 0" class="text-center text-gray-500 py-10">No events found.</div>
                    
                    <div v-for="(group, dateStr) in agendaEvents" :key="dateStr">
                        <div class="sticky top-0 bg-gray-50/95 backdrop-blur py-2 border-b border-gray-200 mb-2 z-10">
                            <span class="font-bold text-lg">{{ group.formattedDate }}</span>
                            <span v-if="group.isToday" class="ml-2 text-xs bg-blue-600 text-white px-2 py-0.5 rounded-full">Today</span>
                        </div>
                        <div class="space-y-2">
                            <div v-for="event in group.events" :key="event.id" 
                                 class="flex gap-4 p-3 bg-white rounded border-l-4 shadow-sm hover:shadow cursor-pointer"
                                 :style="{ borderLeftColor: getEventColor(event) }"
                                 @click.stop="selectEvent(event, $event)">
                                <div class="w-24 text-right text-sm text-gray-500 flex-shrink-0">
                                    <div>{{ formatTime(event.start) }}</div>
                                    <div class="text-xs opacity-75">{{ formatDuration(event) }}</div>
                                </div>
                                <div>
                                    <div class="font-bold text-gray-800">{{ event.title }}</div>
                                    <div class="text-xs text-gray-500">Type {{ event.type }}</div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

        </div>

        <!-- Quick Info Popup -->
        <div v-if="selectedEventId" 
             class="fixed z-50 bg-white rounded-lg shadow-xl border border-gray-200 w-80 overflow-hidden"
             :style="popupStyle">
             <!-- Header -->
             <div class="bg-blue-600 px-4 py-3 flex justify-between items-start text-white">
                <h3 class="font-bold text-lg truncate flex-1 mr-2">{{ getEventById(selectedEventId)?.title || '(No Title)' }}</h3>
                <div class="flex items-center gap-1">
                    <button @click="openEditor(selectedEventId)" class="p-1 hover:bg-blue-700 rounded transition-colors" title="Edit">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.572L16.732 3.732z" /></svg>
                    </button>
                    <button @click="deleteEvent(selectedEventId)" class="p-1 hover:bg-blue-700 rounded transition-colors" title="Delete">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                    </button>
                    <button @click="closePreview" class="p-1 hover:bg-blue-700 rounded transition-colors ml-1" title="Close">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
             </div>
             <!-- Body -->
             <div class="p-4 bg-white">
                 <div class="flex items-start gap-3 mb-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-500 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h10M5 21h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v12a2 2 0 002 2z" /></svg>
                    <div class="text-sm text-gray-700" v-if="getEventById(selectedEventId)">
                        <div class="font-medium">{{ df.format(getEventById(selectedEventId).start, 'MMMM d, yyyy') }}</div>
                        <div class="text-gray-500">
                            {{ formatTime(getEventById(selectedEventId).start) }} - {{ formatTime(getEventById(selectedEventId).end) }}
                        </div>
                    </div>
                 </div>
                 <div v-if="getEventById(selectedEventId)?.description" class="flex items-start gap-3 mt-3 pt-3 border-t border-gray-100">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5 text-gray-500 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" /></svg>
                    <div class="text-sm text-gray-600 whitespace-pre-wrap">{{ getEventById(selectedEventId).description }}</div>
                 </div>
             </div>
        </div>

        <!-- Edit Modal -->
        <div v-if="isEditorOpen" class="fixed inset-0 z-[100] flex items-center justify-center bg-black/50" @click.self="closeEditor">
            <div class="bg-white rounded-lg shadow-xl w-full max-w-md m-4 overflow-hidden">
                <!-- Header -->
                <div class="px-6 py-4 border-b border-gray-200 flex justify-between items-center">
                    <h2 class="text-xl font-bold text-gray-800">Edit Event</h2>
                    <button @click="closeEditor" class="text-gray-400 hover:text-gray-600">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" /></svg>
                    </button>
                </div>
                
                <div class="p-6 space-y-5">
                    <!-- Title -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Title</label>
                        <input v-model="editorForm.title" type="text" class="block w-full border-b-2 border-gray-300 focus:border-blue-500 focus:outline-none py-2 text-lg font-medium transition-colors" placeholder="Add title">
                    </div>
                    
                    <!-- Date/Time Grid -->
                    <div class="grid grid-cols-2 gap-6">
                        <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Start</label>
                            <input v-model="editorForm.start" type="datetime-local" class="block w-full rounded border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                        </div>
                         <div>
                            <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">End</label>
                            <input v-model="editorForm.end" type="datetime-local" class="block w-full rounded border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm">
                        </div>
                    </div>

                    <!-- Options (All day / Timezone) -->
                    <div class="flex items-center gap-6">
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-sm text-gray-700">All day</span>
                        </label>
                        <label class="flex items-center gap-2 cursor-pointer">
                            <input type="checkbox" class="rounded border-gray-300 text-blue-600 focus:ring-blue-500">
                            <span class="text-sm text-gray-700">Timezone</span>
                        </label>
                    </div>

                    <!-- Repeat -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Repeat</label>
                        <select class="block w-full rounded border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm py-2">
                            <option>Never</option>
                            <option>Daily</option>
                            <option>Weekly</option>
                            <option>Monthly</option>
                            <option>Yearly</option>
                        </select>
                    </div>

                    <!-- Description -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-1">Description</label>
                        <textarea v-model="editorForm.description" rows="3" class="block w-full rounded border-gray-300 shadow-sm focus:border-blue-500 focus:ring-blue-500 text-sm" placeholder="Add description..."></textarea>
                    </div>

                    <!-- Color -->
                    <div>
                        <label class="block text-xs font-bold text-gray-500 uppercase tracking-wide mb-2">Color</label>
                        <div class="flex gap-3 flex-wrap">
                            <div v-for="(c, i) in colors" :key="i" 
                                 class="w-6 h-6 rounded-full cursor-pointer transition-transform hover:scale-110"
                                 :class="{'ring-2 ring-offset-2 ring-blue-500': editorForm.type === i + 1}"
                                 :style="{backgroundColor: c}"
                                 @click="editorForm.type = i + 1"></div>
                        </div>
                    </div>
                </div>

                <!-- Footer -->
                <div class="px-6 py-4 bg-gray-50 border-t border-gray-200 flex justify-between items-center">
                    <button v-if="editorForm.id" @click="deleteEvent(editorForm.id); closeEditor()" class="text-red-600 hover:text-red-800 text-sm font-medium uppercase tracking-wide hover:bg-red-50 px-3 py-1.5 rounded transition-colors">Delete</button>
                    <div v-else></div> <!-- Spacer -->
                    
                    <div class="flex gap-3">
                        <button @click="closeEditor" class="px-4 py-2 text-gray-700 hover:bg-gray-200 rounded font-medium text-sm uppercase tracking-wide transition-colors">Cancel</button>
                        <button @click="saveEvent" class="px-4 py-2 bg-blue-600 text-white rounded font-medium text-sm uppercase tracking-wide hover:bg-blue-700 shadow-sm transition-colors">Save</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Drag Ghost (Month View) -->
        <div v-if="dragState.isDragging && dragState.action === 'month-move' && dragState.ghostEvent" 
             class="drag-ghost px-2 py-1 text-xs rounded text-white font-bold truncate w-32 pointer-events-none"
             :style="[getEventStyle(dragState.ghostEvent), { left: dragState.mouseX + 'px', top: dragState.mouseY + 'px' }]">
            {{ dragState.ghostEvent.title }}
        </div>

        <!-- Simple Toast/Hint -->
        <div v-if="notification" class="fixed bottom-4 left-1/2 transform -translate-x-1/2 bg-gray-800 text-white px-4 py-2 rounded-full text-sm shadow-lg z-50 transition-opacity">
            {{ notification }}
        </div>
    </div>

    <!-- Time Grid View Component Template -->
    <script type="text/x-template" id="time-grid-view-template">
        <div class="h-full flex flex-col">
            <!-- Header Row -->
            <div class="border-b border-gray-200 bg-white flex-shrink-0 grid"
                 :style="`grid-template-columns: 60px repeat(${visibleDates.length}, 1fr)`">
                <div class="border-r border-gray-200 p-2"></div> <!-- Gutter -->
                <div v-for="(date, idx) in visibleDates" :key="idx" 
                     class="p-2 text-center border-r border-gray-100">
                    <div class="text-xs font-semibold text-gray-500 uppercase">{{ weekDays[date.getDay()] }}</div>
                    <div class="text-xl font-light w-8 h-8 mx-auto rounded-full flex items-center justify-center" 
                         :class="{'bg-blue-600 text-white font-bold': isToday(date)}">
                        {{ date.getDate() }}
                    </div>
                </div>
            </div>

            <!-- Scrollable Area -->
            <div class="flex-1 overflow-y-auto relative" ref="timeScroll">
                <div class="time-grid relative"
                     :style="`grid-template-columns: 60px repeat(${visibleDates.length}, 1fr)`">
                    
                    <!-- Time Labels (Left Gutter) -->
                    <div class="flex flex-col text-xs text-gray-400 text-right pr-2 pt-[-0.5rem] bg-white sticky left-0 z-10 border-r border-gray-200">
                        <div v-for="h in 24" :key="h" class="h-[50px] -mt-2.5 bg-white select-none">
                            {{ formatTimeLabel(h-1) }}
                        </div>
                    </div>
                    
                    <!-- Day Columns -->
                    <div v-for="(date, idx) in visibleDates" :key="idx" 
                         class="time-col relative"
                         :data-date="date.toISOString()"
                         @click="$emit('create-time-event', date, $event)">
                        
                        <!-- Grid lines -->
                        <div v-for="h in 24" :key="h" class="hour-row pointer-events-none"></div>
                        
                        <!-- Current Time Indicator -->
                        <div v-if="isToday(date)" class="absolute w-full h-0.5 bg-red-500 z-30 pointer-events-none flex items-center"
                             :style="{ top: currentTimeTop + 'px' }">
                             <div class="w-2 h-2 bg-red-500 rounded-full -ml-1"></div>
                        </div>

                        <!-- Original Position Ghost (When Dragging) -->
                        <div v-if="dragState.isDragging && isSameDay(date, new Date(dragState.originalStart)) && dragState.action === 'time-move'"
                             class="absolute inset-x-1 rounded border-2 border-gray-400 border-dashed bg-gray-100 opacity-60 pointer-events-none z-0"
                             :style="getGhostStyle()">
                        </div>

                        <!-- Absolute Events -->
                        <div v-for="event in getEventsWithLayout(date)" :key="event.id" 
                             class="event-card absolute p-1 text-xs inset-x-1 rounded overflow-hidden border-l-4"
                             :class="{
                                 'dragging-active': dragState.eventId === event.id && dragState.isDragging, 
                                 'dragging-move-active': dragState.eventId === event.id && dragState.isDragging && dragState.action === 'time-move',
                                 'ring-2 ring-offset-1 ring-black': selectedEventId === event.id
                             }"
                             :style="[getEventStyle(event, true), getWeekEventPosition(event), { cursor: eventCursor }]"
                             @mousedown.stop="$emit('start-drag', event, $event, 'time-move')"
                             @click.stop="$emit('select-event', event, $event)">
                            <div class="event-text-content">
                                <div class="font-bold leading-tight pointer-events-none">{{ event.title }}</div>
                                <div class="opacity-75 text-[10px] pointer-events-none">{{ formatTime(event.start) }} - {{ formatTime(event.end) }}</div>
                            </div>
                            <!-- Resize Handle -->
                            <div class="resize-handle absolute bottom-0 inset-x-0 h-2 z-20"
                                 @mousedown.stop="$emit('start-drag', event, $event, 'resize')"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </script>

    <!-- Month View Component Template -->
    <script type="text/x-template" id="month-view-template">
        <div class="h-full flex flex-col overflow-y-auto">
            <!-- Headers -->
            <div class="grid grid-cols-7 border-b border-gray-200 bg-gray-50">
                <div v-for="day in weekDays" :key="day" class="py-2 text-center text-sm font-semibold text-gray-500 uppercase tracking-wide">
                    {{ day }}
                </div>
            </div>
            <!-- Grid -->
            <div class="calendar-grid flex-1">
                <div v-for="(cell, idx) in cells" :key="idx" 
                     class="calendar-cell relative group hover:bg-gray-50 flex flex-col gap-1 cursor-pointer"
                     :class="{'bg-gray-50/50': !cell.isCurrentMonth, 'bg-blue-50': isToday(cell.date)}"
                     :data-date="cell.date.toISOString()"
                     @click.self="$emit('create-event', cell.date)">
                    
                    <span class="text-xs font-medium p-1 ml-auto rounded-full w-7 h-7 flex items-center justify-center"
                          :class="isToday(cell.date) ? 'bg-blue-600 text-white' : 'text-gray-700'">
                        {{ cell.dayNumber }}
                    </span>

                    <!-- Month Events -->
                    <div v-for="event in getEventsForDate(cell.date)" :key="event.id"
                         class="px-1.5 py-0.5 text-xs rounded truncate cursor-pointer shadow-sm border-l-2 hover:brightness-95 transition-all select-none"
                         :class="{'is-dragging': dragState.eventId === event.id}"
                         :style="getEventStyle(event)"
                         @mousedown.stop="$emit('start-drag', event, $event, 'month-move')"
                         @click.stop="$emit('select-event', event, $event)">
                        {{ event.title }}
                    </div>
                </div>
            </div>
        </div>
    </script>

    <!-- Calendar Toolbar Component Template -->
    <script type="text/x-template" id="calendar-toolbar-template">
        <div class="flex justify-between items-center p-3 border-b border-gray-200 bg-white flex-shrink-0">
            <div class="flex items-center gap-4">
                <!-- Date Nav -->
                <div class="flex items-center bg-gray-100 rounded-lg p-0.5">
                    <button @click="$emit('prev')" class="px-2 hover:bg-white rounded-md h-7 flex items-center text-gray-600 text-lg leading-none mb-0.5">&lsaquo;</button>
                    <button @click="$emit('today')" class="px-3 text-xs font-bold hover:bg-white rounded-md h-7 text-gray-700 uppercase tracking-wide">Today</button>
                    <button @click="$emit('next')" class="px-2 hover:bg-white rounded-md h-7 flex items-center text-gray-600 text-lg leading-none mb-0.5">&rsaquo;</button>
                </div>
                <!-- Date Range -->
                <div class="text-xl font-medium text-gray-800">{{ currentTitle }}</div>
            </div>

            <!-- View Switcher -->
            <div class="flex bg-gray-100 rounded-lg p-0.5">
                <button v-for="view in views" 
                    :key="view"
                    @click="$emit('change-view', view)"
                    :class="['px-3 py-1 rounded-md text-xs font-medium transition-all', currentView === view ? 'bg-white text-blue-600 shadow-sm' : 'text-gray-500 hover:text-gray-700']">
                    {{ view }}
                </button>
            </div>
        </div>
    </script>

    <!-- App Topbar Component Template -->
    <script type="text/x-template" id="app-topbar-template">
        <div class="flex-shrink-0 bg-white border-b border-gray-200 md:border-b-0">
            <!-- Mobile Topbar -->
            <div class="md:hidden flex items-center justify-between p-2">
                <!-- Left: Logo -->
                <div class="flex items-center">
                    <img class="h-8 w-8 mr-1" src="https://pastecal.com/img/pastecal.logo.svg" alt="Logo">
                    <span class="text-blue-500 font-bold text-sm">pastecal</span>
                </div>

                <!-- Center: Title -->
                <div class="absolute left-1/2 transform -translate-x-1/2 font-bold text-gray-800 cursor-pointer"
                     @click="$emit('edit-title')">
                    {{ title }}
                </div>

                <!-- Right: Menu -->
                <button @click="$emit('toggle-settings')" class="p-2 text-gray-500">
                    <svg xmlns="http://www.w3.org/2000/svg" class="w-6 h-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" /></svg>
                </button>
            </div>

            <!-- Desktop Topbar -->
            <div class="hidden md:flex justify-between items-center pb-1 md:pb-3 text-sm">
                <!-- Left: Logo & App Actions -->
                <section class="flex-1 flex items-center min-w-0">
                    <div class="flex items-center h-8 mr-4">
                        <img class="h-8 w-8 mr-1.5 flex-shrink-0" src="https://pastecal.com/img/pastecal.logo.svg" alt="Logo">
                        <div class="flex flex-col leading-none">
                            <span class="text-blue-500 font-bold text-sm tracking-tight">pastecal</span>
                            <span class="text-gray-400 text-[10px] -mt-0.5">no-login calendar</span>
                        </div>
                    </div>
                    
                    <!-- App Icons -->
                    <div class="flex items-center space-x-1">
                        <button class="text-gray-400 hover:text-blue-500 p-1.5 rounded-full transition-colors" title="Help">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.228 9c.549-1.165 2.03-2 3.772-2 2.21 0 4 1.343 4 3 0 1.4-1.278 2.575-3.006 2.907-.542.104-.994.54-.994 1.093m0 3h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>
                        </button>
                        <button class="text-gray-400 hover:text-blue-500 p-1.5 rounded-full transition-colors" title="Search">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" /></svg>
                        </button>
                        <button @click="$emit('toggle-settings')" class="text-gray-400 hover:text-blue-500 p-1.5 rounded-full transition-colors" title="Settings">
                            <svg xmlns="http://www.w3.org/2000/svg" class="w-5 h-5" fill="currentColor" viewBox="0 0 16 16"><path d="M9.405 1.05c-.413-1.4-2.397-1.4-2.81 0l-.1.34a1.464 1.464 0 0 1-2.105.872l-.31-.17c-1.283-.698-2.686.705-1.987 1.987l.169.311c.446.82.023 1.841-.872 2.105l-.34.1c-1.4.413-1.4 2.397 0 2.81l.34.1a1.464 1.464 0 0 1 .872 2.105l-.17.31c-.698 1.283.705 2.686 1.987 1.987l.311-.169a1.464 1.464 0 0 1 2.105.872l.1.34c.413 1.4 2.397 1.4 2.81 0l.1-.34a1.464 1.464 0 0 1-2.105-.872l.31.17c1.283.698 2.686-.705 1.987-1.987l-.169-.311a1.464 1.464 0 0 1-2.105-.872l-.1-.34zM8 10.93a2.929 2.929 0 1 1 0-5.86 2.929 2.929 0 0 1 0 5.858z" /></svg>
                        </button>
                    </div>
                </section>

                <!-- Center: Calendar Title -->
                <section class="flex-1 flex justify-center">
                    <div class="text-lg font-bold text-gray-800 cursor-pointer hover:text-blue-600 transition-colors px-2 py-1 rounded hover:bg-gray-50"
                         @click="$emit('edit-title')">
                        {{ title }}
                    </div>
                </section>

                <!-- Right: Share Actions -->
                <section class="flex-1 flex justify-end items-center">
                    <div class="flex items-center bg-white border border-gray-200 rounded-full px-3 py-1 shadow-sm hover:border-blue-400 cursor-pointer transition-colors group">
                        <svg xmlns="http://www.w3.org/2000/svg" class="w-4 h-4 text-gray-400 group-hover:text-blue-500 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8.684 13.342C8.886 12.938 9 12.482 9 12c0-.482-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.368 2.684 3 3 0 00-5.368-2.684z" /></svg>
                        <div class="text-xs text-gray-500">pastecal.com/<span class="font-bold text-gray-700">native-proto</span></div>
                    </div>
                </section>
            </div>
        </div>
    </script>

    <!-- Settings Modal Component Template -->
    <script type="text/x-template" id="settings-modal-template">
        <div class="fixed inset-0 z-[100] flex items-center justify-center bg-black/50" @click.self="$emit('close')">
            <div class="w-full max-w-2xl p-4 text-sm text-gray-800 bg-white rounded-lg shadow-xl border border-gray-200 m-4">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h2 class="text-lg font-bold">Settings</h2>
                    <button @click="$emit('close')" class="text-gray-500 hover:text-gray-700">âœ•</button>
                </div>

                <div class="grid md:grid-cols-2 gap-6">
                    <!-- Global Settings -->
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="font-bold text-gray-800 mb-3">Personal Settings</h3>
                        <p class="text-xs text-gray-500 mb-4 italic">Default settings for your device.</p>

                        <div class="space-y-4">
                            <div>
                                <label class="block mb-1 font-medium">Time format</label>
                                <select :value="timeFormat" @change="$emit('update:timeFormat', $event.target.value)"
                                    class="w-full p-2 border border-gray-200 rounded bg-white">
                                    <option value="12">12-hour (1:00 PM)</option>
                                    <option value="24">24-hour (13:00)</option>
                                </select>
                            </div>
                            
                            <!-- Placeholders for other settings matching main app -->
                            <div>
                                <label class="block mb-1 font-medium text-gray-400">First day of week</label>
                                <select disabled class="w-full p-2 border border-gray-200 rounded bg-white text-gray-400">
                                    <option>Sunday</option>
                                </select>
                            </div>
                            <div>
                                <label class="block mb-1 font-medium text-gray-400">Theme</label>
                                <select disabled class="w-full p-2 border border-gray-200 rounded bg-white text-gray-400">
                                    <option>Light</option>
                                </select>
                            </div>
                        </div>
                    </div>
                    
                    <!-- Calendar Specific Placeholders -->
                    <div class="bg-gray-50 p-4 rounded-lg shadow-sm border border-gray-200">
                        <h3 class="font-bold text-gray-800 mb-3">Calendar Settings</h3>
                        <p class="text-xs text-gray-500 mb-4 italic">Settings for everyone viewing this calendar.</p>
                        <div class="text-center text-gray-400 py-8">
                            (Calendar-specific settings coming soon)
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </script>

    <script>
        const { createApp, ref, computed, onMounted, onUnmounted } = Vue;
        const df = window.dateFns;

        // Component: App Topbar
        const AppTopbar = {
            template: '#app-topbar-template',
            props: ['title'],
            emits: ['toggle-settings', 'edit-title']
        };

        // Component: Calendar Toolbar
        const CalendarToolbar = {
            template: '#calendar-toolbar-template',
            props: ['currentTitle', 'currentView', 'views'],
            emits: ['prev', 'next', 'today', 'change-view']
        };

        // Component: Month View
        const MonthView = {
            template: '#month-view-template',
            props: ['cells', 'weekDays', 'dragState', 'getEventsForDate', 'getEventStyle', 'isToday'],
            emits: ['create-event', 'start-drag', 'select-event']
        };

        // Component: Time Grid View
        const TimeGridView = {
            template: '#time-grid-view-template',
            props: [
                'currentView', 'visibleDates', 'weekDays', 'isToday', 
                'currentTimeTop', 'dragState', 'selectedEventId', 'eventCursor',
                'getEventsWithLayout', 'getEventStyle', 'getWeekEventPosition', 'getGhostStyle', 'formatTime', 'isSameDay', 'timeFormat'
            ],
            emits: ['create-time-event', 'start-drag', 'select-event'],
            methods: {
                formatTimeLabel(hours) {
                    const date = new Date();
                    date.setHours(hours, 0, 0, 0);
                    // Use parent's formatTime if possible, or re-implement logic based on timeFormat
                    // To respect 12/24h, we need to know the format. 
                    // Actually, formatTime is passed as a prop!
                    return this.formatTime(date.getTime());
                }
            }
        };

        // Component: Settings Modal
        const SettingsModal = {
            template: '#settings-modal-template',
            props: ['timeFormat'],
            emits: ['update:timeFormat', 'close']
        };

        createApp({
            components: {
                'settings-modal': SettingsModal,
                'app-topbar': AppTopbar,
                'calendar-toolbar': CalendarToolbar,
                'month-view': MonthView,
                'time-grid-view': TimeGridView
            },
            setup() {
                const currentView = ref('Month'); // Default view
                const views = ['Day', 'Week', 'Month', 'Year', 'Agenda'];
                const currentDate = ref(new Date());
                const weekDays = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
                const notification = ref('');
                const selectedEventId = ref(null);
                const popupPosition = ref({ top: 0, left: 0 });
                const isEditorOpen = ref(false);
                const editorForm = ref({ id: null, title: '', description: '', start: '', end: '', type: 1, recurrencerule: '' });
                const timeFormat = ref('12'); // '12' for AM/PM, '24' for military
                const showSettings = ref(false);
                const calendarTitle = ref('My Schedule');
                
                // ----------------------------------------------------------------
                // Data
                // ----------------------------------------------------------------
                const events = ref([
                    { id: 1, title: 'Morning Standup', start: new Date().setHours(9, 0, 0, 0), end: new Date().setHours(9, 30, 0, 0), type: 1 },
                    { id: 2, title: 'Deep Work', start: new Date().setHours(10, 0, 0, 0), end: new Date().setHours(12, 0, 0, 0), type: 2 },
                    { id: 3, title: 'Lunch', start: new Date().setHours(12, 30, 0, 0), end: new Date().setHours(13, 30, 0, 0), type: 3 },
                    { id: 4, title: 'Client Meeting', start: new Date().setHours(14, 0, 0, 0), end: new Date().setHours(15, 0, 0, 0), type: 4 },
                ]);

                const colors = ["#3f51b5", "#e3165b", "#ff6652", "#4caf50", "#ff9800", "#03a9f4", "#9e9e9e", "#27282f"];

                // ----------------------------------------------------------------
                // Computed Props
                // ----------------------------------------------------------------
                const eventCursor = computed(() => {
                    if (dragState.value.isDragging && dragState.value.eventId) {
                        return dragState.value.action === 'resize' ? 'ns-resize' : 'grabbing';
                    }
                    return 'pointer';
                });

                const currentTitle = computed(() => {
                    if (currentView.value === 'Year') return df.format(currentDate.value, 'yyyy');
                    if (currentView.value === 'Day') return df.format(currentDate.value, 'MMMM d, yyyy');
                    return df.format(currentDate.value, 'MMMM yyyy');
                });

                const popupStyle = computed(() => {
                    // Keep popup within bounds roughly
                    let left = popupPosition.value.left;
                    let top = popupPosition.value.top;
                    
                    // Adjust if too close to right edge (simplistic)
                    if (window.innerWidth - left < 300) left -= 300;
                    // Adjust if too close to bottom
                    if (window.innerHeight - top < 200) top -= 200;
                    
                    return {
                        top: `${top}px`,
                        left: `${left}px`
                    };
                });

                const getEventById = (id) => events.value.find(e => e.id === id);

                const toDateTimeLocalString = (timestamp) => {
                    const date = new Date(timestamp);
                    const pad = (num) => String(num).padStart(2, '0');
                    return `${date.getFullYear()}-${pad(date.getMonth() + 1)}-${pad(date.getDate())}T${pad(date.getHours())}:${pad(date.getMinutes())}`;
                };

                // Month View Logic
                const monthCells = computed(() => {
                    const start = df.startOfMonth(currentDate.value);
                    const end = df.endOfMonth(currentDate.value);
                    const days = df.eachDayOfInterval({ start, end });
                    const startDay = df.getDay(start);
                    const prevMonthDays = [];
                    for(let i = 0; i < startDay; i++) {
                        prevMonthDays.unshift({
                            date: df.subDays(start, i + 1),
                            dayNumber: df.getDate(df.subDays(start, i + 1)),
                            isCurrentMonth: false
                        });
                    }
                    const currentMonthDays = days.map(d => ({ date: d, dayNumber: df.getDate(d), isCurrentMonth: true }));
                    // Pad end
                    const totalCells = 42; // 6 rows
                    const remaining = totalCells - (prevMonthDays.length + currentMonthDays.length);
                    const nextMonthDays = [];
                    for(let i = 1; i <= remaining; i++) {
                        nextMonthDays.push({
                            date: df.addDays(end, i),
                            dayNumber: df.getDate(df.addDays(end, i)),
                            isCurrentMonth: false
                        });
                    }
                    
                    return [...prevMonthDays, ...currentMonthDays, ...nextMonthDays];
                });

                // Week/Day View Logic
                const visibleDates = computed(() => {
                    if (currentView.value === 'Day') {
                        return [currentDate.value];
                    }
                    // Week view
                    const start = df.startOfWeek(currentDate.value);
                    return Array.from({ length: 7 }, (_, i) => df.addDays(start, i));
                });

                // Year View Logic
                const yearMonths = computed(() => {
                    const yearStart = df.startOfYear(currentDate.value);
                    const months = df.eachMonthOfInterval({
                        start: yearStart,
                        end: df.endOfYear(currentDate.value)
                    });

                    return months.map(m => {
                        const start = df.startOfMonth(m);
                        const end = df.endOfMonth(m);
                        const days = df.eachDayOfInterval({ start, end });
                        return {
                            name: df.format(m, 'MMMM'),
                            date: m,
                            startPad: df.getDay(start),
                            days: days.map(d => ({
                                date: d,
                                dayNumber: df.getDate(d),
                                hasEvents: events.value.some(e => df.isSameDay(new Date(e.start), d))
                            }))
                        };
                    });
                });

                // Agenda View Logic
                const agendaEvents = computed(() => {
                    // Sort all events by start date
                    const sorted = [...events.value].sort((a, b) => a.start - b.start);
                    
                    // Group by date
                    const groups = {};
                    sorted.forEach(event => {
                        const dateKey = df.format(new Date(event.start), 'yyyy-MM-dd');
                        if (!groups[dateKey]) {
                            groups[dateKey] = {
                                date: new Date(event.start),
                                formattedDate: df.format(new Date(event.start), 'EEEE, MMMM d'),
                                isToday: df.isSameDay(new Date(event.start), new Date()),
                                events: []
                            };
                        }
                        groups[dateKey].events.push(event);
                    });
                    return groups; // Object (not ordered), usually okay for v-for but better as array
                });

                // ----------------------------------------------------------------
                // Methods: Navigation
                // ----------------------------------------------------------------
                const changeView = (view) => {
                    currentView.value = view;
                    selectedEventId.value = null; // Close preview
                };

                const prev = () => {
                    if (currentView.value === 'Year') currentDate.value = df.subYears(currentDate.value, 1);
                    else if (currentView.value === 'Month') currentDate.value = df.subMonths(currentDate.value, 1);
                    else if (currentView.value === 'Week') currentDate.value = df.subWeeks(currentDate.value, 1);
                    else currentDate.value = df.subDays(currentDate.value, 1);
                    selectedEventId.value = null; // Close preview
                };
                const next = () => {
                    if (currentView.value === 'Year') currentDate.value = df.addYears(currentDate.value, 1);
                    else if (currentView.value === 'Month') currentDate.value = df.addMonths(currentDate.value, 1);
                    else if (currentView.value === 'Week') currentDate.value = df.addWeeks(currentDate.value, 1);
                    else currentDate.value = df.addDays(currentDate.value, 1);
                    selectedEventId.value = null; // Close preview
                };
                const today = () => {
                    currentDate.value = new Date();
                    selectedEventId.value = null; // Close preview
                };
                const isToday = (date) => df.isSameDay(date, new Date());
                const goToMonth = (date) => {
                    currentDate.value = date;
                    currentView.value = 'Month';
                    selectedEventId.value = null; // Close preview
                };

                const toggleSettings = () => {
                    showSettings.value = !showSettings.value;
                };

                const updateTimeFormat = (val) => {
                    timeFormat.value = val;
                };

                const editCalendarTitle = () => {
                    const newTitle = prompt("Enter calendar name:", calendarTitle.value);
                    if (newTitle) calendarTitle.value = newTitle;
                };

                // ----------------------------------------------------------------
                // Methods: Event Logic
                // ----------------------------------------------------------------
                const getEventsForDate = (date) => {
                    return events.value.filter(e => df.isSameDay(new Date(e.start), date));
                };

                // Layout Algorithm for Week/Day View
                const getEventsWithLayout = (date) => {
                    const dayEvents = getEventsForDate(date).map(e => ({...e})); // Shallow copy to attach layout props
                    if (dayEvents.length === 0) return [];

                    // Sort by start time, then end time (descending duration)
                    dayEvents.sort((a, b) => a.start - b.start || b.end - a.end);

                    const columns = [];
                    dayEvents.forEach(ev => {
                        let placed = false;
                        for (let i = 0; i < columns.length; i++) {
                            const col = columns[i];
                            // Check if this event overlaps with the LAST event in this column
                            // (Simple packing) - actually need to check all in column to be safe,
                            // but usually just checking the last one is enough if sorted? 
                            // No, if we have A(9-11), B(9-10), C(10-11). A is col 0. B is col 1. C? 
                            // C starts at 10. A ends at 11. C cannot be col 0.
                            // C starts at 10. B ends at 10. C DOES NOT overlap B. C can be col 1.
                            
                            const hasOverlap = col.some(existing => {
                                return Math.max(existing.start, ev.start) < Math.min(existing.end, ev.end);
                            });
                            
                            if (!hasOverlap) {
                                col.push(ev);
                                ev.colIndex = i;
                                placed = true;
                                break;
                            }
                        }
                        if (!placed) {
                            columns.push([ev]);
                            ev.colIndex = columns.length - 1;
                        }
                    });

                    // Now calculate Width and Left
                    // Simple Approach: Width = 100% / total columns in the "cluster"
                    // For this prototype, we will use global columns for the day for simplicity,
                    // or we can try to find max_col_index for the specific event's cluster.
                    
                    // Let's do a simplified "shared width" approach:
                    // If I am in col 0, and there is a col 1 that overlaps me, we share space.
                    
                    // We will use a generic "Max Columns" for the day to avoid complex cluster logic for now.
                    // This means if there is a 4-event overlap at 9am, ALL events in the day might be 1/4 width.
                    // This is suboptimal but robust for a first pass. 
                    // IMPROVEMENT: Calculate max overlap for each event's connected component.
                    
                    // Better: Calculate overlaps per event.
                    dayEvents.forEach(ev => {
                        // Find all overlapping events
                        const overlapping = dayEvents.filter(other => 
                            Math.max(ev.start, other.start) < Math.min(ev.end, other.end)
                        );
                        // The "width" is 1 / (max concurrent events in this group).
                        // The "left" depends on the colIndex.
                        
                        // Actually, simpler visual:
                        // width = 100 / columns.length (global max columns)
                        // This ensures alignment.
                        
                        const widthPercent = 100 / columns.length;
                        ev.style = {
                            left: (ev.colIndex * widthPercent) + '%',
                            width: (widthPercent * 0.8) + '%' // Events take 80% of their column space
                        };
                    });
                    
                    return dayEvents;
                };

                const formatTime = (timestamp) => {
                    if (timeFormat.value === '12') {
                        return df.format(new Date(timestamp), 'h:mm a');
                    } else {
                        return df.format(new Date(timestamp), 'HH:mm');
                    }
                };
                const formatDuration = (event) => {
                    const diff = df.differenceInMinutes(event.end, event.start);
                    const h = Math.floor(diff / 60);
                    const m = diff % 60;
                    return (h > 0 ? `${h}h ` : '') + (m > 0 ? `${m}m` : ''); 
                };

                const getEventStyle = (event, isWeekView = false) => {
                    const color = colors[(event.type - 1) % colors.length];
                    if (isWeekView) {
                        return { 
                            borderLeftColor: color, 
                            backgroundColor: color + '20', 
                            color: color,
                            ...event.style // Apply layout styles (left, width)
                        };
                    }
                    return { backgroundColor: color, color: 'white' };
                };
                const getEventColor = (event) => colors[(event.type - 1) % colors.length];

                const getWeekEventPosition = (event) => {
                    const start = new Date(event.start);
                    const end = new Date(event.end);
                    const startMinutes = start.getHours() * 60 + start.getMinutes();
                    const endMinutes = end.getHours() * 60 + end.getMinutes();
                    const top = (startMinutes / 60) * 50;
                    const height = Math.max(((endMinutes - startMinutes) / 60) * 50, 20);
                    return { top: `${top}px`, height: `${height}px` }; // Width/Left handled by layout style
                };
                
                const getGhostStyle = () => {
                    const start = new Date(dragState.value.originalStart);
                    const end = new Date(dragState.value.originalEnd);
                    const startMinutes = start.getHours() * 60 + start.getMinutes();
                    const endMinutes = end.getHours() * 60 + end.getMinutes();
                    const top = (startMinutes / 60) * 50;
                    const height = Math.max(((endMinutes - startMinutes) / 60) * 50, 20);
                    return { top: `${top}px`, height: `${height}px`, width: '80%', left: '0%' }; // Ghost is left aligned 80% width
                };

                // ----------------------------------------------------------------
                // Hover Guide Logic (Removed - no longer needed)
                // ----------------------------------------------------------------

                // ----------------------------------------------------------------
                // Interactions
                // ----------------------------------------------------------------
                const showToast = (msg) => {
                    notification.value = msg;
                    setTimeout(() => notification.value = '', 2000);
                }

                const createMonthEvent = (date) => {
                    console.log('[createMonthEvent] triggered for', date);
                    const start = df.setHours(date, 9);
                    const end = df.setHours(date, 10);
                    events.value.push({ id: Date.now(), title: 'New Event', start: start.getTime(), end: end.getTime(), type: Math.floor(Math.random() * 8) + 1 });
                    showToast(`Created event on ${df.format(date, 'MMM d')}`);
                };

                const createTimeEvent = (date, event) => {
                    console.log('[createTimeEvent] triggered. Dragging:', dragState.value.isDragging);
                    if (dragState.value.isDragging) {
                        console.log('[createTimeEvent] Blocked because dragging is active');
                        return;
                    }
                    
                    // Check if we just finished a drag (click often fires after drag release)
                    if (dragState.value.wasDragging) {
                         console.log('[createTimeEvent] Blocked because we just finished dragging');
                         dragState.value.wasDragging = false;
                         return;
                    }

                    // Ensure click wasn't on an event (extra safety)
                    // Note: @click.stop on event-card should prevent this, but this is a fallback
                    if (event.target.closest('.event-card')) {
                        console.log('[createTimeEvent] Blocked because target is event-card');
                        return;
                    }
                    
                    // Clear previous selection
                    selectedEventId.value = null;

                    const rect = event.currentTarget.getBoundingClientRect();
                    const y = event.clientY - rect.top;
                    const hoursFloat = y / 50;
                    const hours = Math.floor(hoursFloat);
                    const roundedMinutes = 0; // Snap to the hour start
                    const start = df.set(date, { hours: hours, minutes: roundedMinutes });
                    const end = df.addMinutes(start, 60);
                    const newEvent = { id: Date.now(), title: '(No Title)', start: start.getTime(), end: end.getTime(), type: Math.floor(Math.random() * 8) + 1 };
                    events.value.push(newEvent);
                    selectedEventId.value = newEvent.id; // Select newly created
                    showToast(`Created at ${df.format(start, 'h:mm a')}`);
                };

                const editEvent = (event) => {
                    // Legacy double click handler if needed, now redirected to openEditor
                    openEditor(event.id);
                };

                const selectEvent = (event, e) => {
                    console.log('[selectEvent] triggered for', event.id);
                    if (dragState.value.isDragging || dragState.value.wasDragging) return;
                    selectedEventId.value = event.id;
                    
                    // Calculate popup position
                    if (e) {
                        // Position relative to viewport
                        const rect = e.currentTarget.getBoundingClientRect();
                        // Place to the right or bottom of the element
                        popupPosition.value = {
                            top: rect.bottom + 10,
                            left: rect.left + (rect.width / 2)
                        };
                    }
                };

                const closePreview = () => {
                    selectedEventId.value = null;
                };

                const deleteEvent = (id) => {
                    if(confirm("Delete this event?")) {
                        events.value = events.value.filter(e => e.id !== id);
                        selectedEventId.value = null;
                    }
                };

                const openEditor = (id) => {
                    const event = getEventById(id);
                    if (event) {
                        // Clone event and format dates for inputs
                        editorForm.value = { 
                            ...event,
                            start: toDateTimeLocalString(event.start),
                            end: toDateTimeLocalString(event.end)
                        };
                        isEditorOpen.value = true;
                        selectedEventId.value = null; // Close preview
                    }
                };

                const closeEditor = () => {
                    isEditorOpen.value = false;
                };

                const saveEvent = () => {
                    const index = events.value.findIndex(e => e.id === editorForm.value.id);
                    if (index !== -1) {
                        // Convert back to timestamps
                        const updatedEvent = { 
                            ...editorForm.value,
                            start: new Date(editorForm.value.start).getTime(),
                            end: new Date(editorForm.value.end).getTime()
                        };
                        events.value[index] = updatedEvent;
                        showToast('Event saved');
                    }
                    closeEditor();
                };

                // ----------------------------------------------------------------
                // Drag & Drop (Unified)
                // ----------------------------------------------------------------
                const dragState = ref({
                    eventId: null,
                    isDragging: false,
                    wasDragging: false, // New flag to prevent click-after-drag
                    startY: 0, // For Time Grid
                    originalStart: 0,
                    originalEnd: 0,
                    action: 'move', // 'time-move', 'month-move', 'resize'
                    ghostEvent: null, // For Month Move
                    mouseX: 0,
                    mouseY: 0
                });

                const startDrag = (event, e, action) => {
                    console.log('[startDrag] action:', action, 'id:', event.id);
                    if (e.button !== 0) return;
                    dragState.value = {
                        eventId: event.id,
                        isDragging: false,
                        wasDragging: false,
                        startY: e.clientY,
                        originalStart: event.start,
                        originalEnd: event.end,
                        action: action,
                        ghostEvent: event,
                        mouseX: e.clientX,
                        mouseY: e.clientY
                    };
                };

                const onDrag = (e) => {
                    if (!dragState.value.eventId) return;
                    
                    if (!dragState.value.isDragging) {
                        const deltaY = Math.abs(e.clientY - dragState.value.startY);
                        const deltaX = Math.abs(e.clientX - dragState.value.mouseX);
                        console.log(`[onDrag] Check threshold: dx=${deltaX}, dy=${deltaY}`);
                        
                        // Threshold check to prevent accidental micro-drags on click
                        if (deltaY > 5 || deltaX > 5) {
                            console.log('[onDrag] Drag started (threshold passed)');
                            dragState.value.isDragging = true;
                        } else {
                            return;
                        }
                    }

                    // Update Mouse Position for Month Ghost
                    dragState.value.mouseX = e.clientX;
                    dragState.value.mouseY = e.clientY;

                    const event = events.value.find(ev => ev.id === dragState.value.eventId);
                    if (!event) return;

                    // Time Grid Logic (Move/Resize)
                    if (dragState.value.action === 'time-move' || dragState.value.action === 'resize') {
                        const deltaPixels = e.clientY - dragState.value.startY;
                        const deltaMinutes = Math.round((deltaPixels / 50) * 60 / 30) * 30;

                        if (dragState.value.action === 'time-move') {
                            const duration = dragState.value.originalEnd - dragState.value.originalStart;
                            
                            // Calculate time based on original + delta (vertical move)
                            const newStartTime = df.addMinutes(dragState.value.originalStart, deltaMinutes);
                            const newHours = newStartTime.getHours();
                            const newMinutes = newStartTime.getMinutes();
                            
                            // Find target column (horizontal move)
                            const target = document.elementFromPoint(e.clientX, e.clientY);
                            let targetDate = null;
                            if (target) {
                                const col = target.closest('.time-col');
                                if (col && col.dataset.date) {
                                    targetDate = new Date(col.dataset.date);
                                }
                            }
                            
                            // Use target date if found, else keep current event date
                            const baseDate = targetDate ? targetDate : new Date(event.start);
                            
                            const newStart = df.set(baseDate, {
                                hours: newHours,
                                minutes: newMinutes
                            });
                            
                            event.start = newStart.getTime();
                            event.end = new Date(newStart.getTime() + duration).getTime();

                        } else if (dragState.value.action === 'resize') {
                            let newEnd = df.addMinutes(dragState.value.originalEnd, deltaMinutes);
                            const start = new Date(dragState.value.originalStart);
                            if (df.differenceInMinutes(newEnd, start) < 15) newEnd = df.addMinutes(start, 15);
                            event.end = newEnd.getTime();
                        }
                    }
                    // Month Move Logic handled in stopDrag (Drop)
                };

                const stopDrag = (e) => {
                    console.log('[stopDrag] isDragging:', dragState.value.isDragging);
                    if (!dragState.value.eventId) {
                        return;
                    }
                    
                    const wasDragging = dragState.value.isDragging;

                    if (wasDragging) {
                        // Handle Drop logic
                        if (dragState.value.action === 'month-move') {
                            // ... (Month drop logic) ...
                            const target = document.elementFromPoint(e.clientX, e.clientY);
                            const cell = target.closest('.calendar-cell');
                            if (cell && cell.dataset.date) {
                                const targetDate = new Date(cell.dataset.date);
                                const event = events.value.find(ev => ev.id === dragState.value.eventId);
                                if (event) {
                                    const duration = event.end - event.start;
                                    const newStart = df.set(targetDate, {
                                        hours: new Date(event.start).getHours(),
                                        minutes: new Date(event.start).getMinutes()
                                    });
                                    event.start = newStart.getTime();
                                    event.end = newStart.getTime() + duration;
                                    showToast(`Moved to ${df.format(targetDate, 'MMM d')}`);
                                }
                            }
                        } else {
                            const action = dragState.value.action === 'resize' ? 'resized' : 'moved';
                            showToast(`Event ${action}`);
                        }
                    }

                    // Reset state, but keep wasDragging true momentarily for click handlers
                    dragState.value = { 
                        eventId: null, 
                        isDragging: false, 
                        wasDragging: wasDragging, // Preserve this!
                        action: 'move' 
                    };
                    
                    // Clear wasDragging after a microtask to let click events fire and see the flag
                    setTimeout(() => {
                        dragState.value.wasDragging = false;
                    }, 50);
                };

                // ----------------------------------------------------------------
                // Time Indicator & Init
                // ----------------------------------------------------------------
                const currentTimeTop = ref(0);
                const updateTimeIndicator = () => {
                    const now = new Date();
                    currentTimeTop.value = ((now.getHours() * 60 + now.getMinutes()) / 60) * 50;
                };

                let timer;
                onMounted(() => {
                    updateTimeIndicator();
                    timer = setInterval(updateTimeIndicator, 60000);
                    setTimeout(() => {
                        const scroll = document.querySelector('.overflow-y-auto.relative');
                        if(scroll) scroll.scrollTop = 350; 
                    }, 100);
                    
                    // Global event listeners for drag
                    window.addEventListener('mousemove', onDrag);
                    window.addEventListener('mouseup', stopDrag);
                });
                onUnmounted(() => {
                    clearInterval(timer);
                    window.removeEventListener('mousemove', onDrag);
                    window.removeEventListener('mouseup', stopDrag);
                });

                return {
                    currentView, views, currentTitle, weekDays, monthCells, visibleDates, yearMonths, agendaEvents,
                    prev, next, today, isToday, changeView, goToMonth,
                    events, getEventsForDate, getEventsWithLayout, getEventStyle, getWeekEventPosition, getGhostStyle, formatTime, formatDuration, getEventColor,
                    createMonthEvent, createTimeEvent, editEvent, selectEvent, selectedEventId,
                    closePreview, openEditor, closeEditor, saveEvent, deleteEvent, isEditorOpen, editorForm, popupStyle, getEventById, toDateTimeLocalString,
                    startDrag, onDrag, stopDrag, dragState,
                    currentTimeTop, notification, eventCursor, timeFormat, showSettings, toggleSettings, updateTimeFormat, calendarTitle, editCalendarTitle,
                    isSameDay: (d1, d2) => df.isSameDay(d1, d2)
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
